<!doctype html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/index.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Properties</title>
    <link rel="preconnect" href="https://unpkg.com" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #f7f7f8; }
      .container { max-width: 960px; margin: 0 auto; }
      h1 { margin-top: 0; }
      table { width: 100%; border-collapse: collapse; background: #fff; }
      th, td { padding: 8px 10px; border: 1px solid #e5e7eb; font-size: 14px; }
      th { background: #f3f4f6; text-align: left; }
      .card { background: #fff; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 16px; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; }
      .row .col { flex: 1 1 200px; min-width: 200px; }
      input, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
      button { padding: 10px 14px; border: 0; background: #111827; color: #fff; border-radius: 6px; cursor: pointer; }
      button:disabled { background: #6b7280; cursor: not-allowed; }
      .actions { display: flex; gap: 8px; }
      .muted { color: #6b7280; font-size: 13px; }
      .error { color: #b91c1c; }
      /* Tabbed pane styles */
      .tabs { display: flex; gap: 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 0; }
      .tab { appearance: none; background: transparent; border: 0; border-bottom: 2px solid transparent; color: #6b7280; padding: 10px 14px; margin: 0; cursor: pointer; border-top-left-radius: 8px; border-top-right-radius: 8px; }
      .tab:hover { color: #111827; }
      .tab.active { color: #111827; border-bottom-color: #111827; font-weight: 600; }
      .tabcontent { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: -1px; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="text/babel" src="/components/Modal.jsx"></script>
    <script type="text/babel" src="/components/Confirm.jsx"></script>
    <script type="text/babel" src="/components/MultiSelect.jsx"></script>
    <script type="text/babel" src="/components/ClassifyRulesPanel.jsx"></script>
    <!-- External Panels loaded via Babel -->
    <script type="text/babel" src="/components/PropertiesPanel.jsx"></script>
    <script type="text/babel" src="/components/CompaniesPanel.jsx"></script>
    <script type="text/babel" src="/components/BankAccountsPanel.jsx"></script>
    <script type="text/babel" src="/components/GroupsPanel.jsx"></script>
    <script type="text/babel" src="/components/OwnersPanel.jsx"></script>
    <script type="text/babel" src="/components/BanksPanel.jsx"></script>
    <script type="text/babel" src="/components/TaxCategoriesPanel.jsx"></script>
    <script type="text/babel" src="/components/TransactionTypesPanel.jsx"></script>

    <script type="text/babel">
      const { useEffect, useState } = React;

      // Subtabs component for Classify Rules
      function ClassifyRulesTabs({ classifyRules, loading, load, bankaccounts, items, taxCategories, transactionTypes, groups }) {
        const [crSubTab, setCrSubTab] = useState(() => {
          try {
            const v = window.localStorage.getItem('crSubTab');
            return v || 'bank';
          } catch (_) { return 'bank'; }
        });
        const [commonFilter, setCommonFilter] = useState({ transaction_type: '', pattern_match_logic: '' });
        const [inheritFilter, setInheritFilter] = useState({ bankaccountname: '', tax_category: '', property: '', group: '', otherentity: '' });
        const [commonRules, setCommonRules] = useState([]);
        const [inheritRules, setInheritRules] = useState([]);
        const [subLoading, setSubLoading] = useState(false);

        const fetchCommon = React.useCallback(async () => {
          try {
            setSubLoading(true);
            const res = await fetch('/api/common-rules');
            if (!res.ok) throw new Error('Failed to fetch common rules');
            const data = await res.json();
            setCommonRules(Array.isArray(data) ? data : []);
          } catch (e) {
            console.error(e);
            setCommonRules([]);
          } finally { setSubLoading(false); }
        }, []);

        const fetchInherit = React.useCallback(async () => {
          try {
            setSubLoading(true);
            const res = await fetch('/api/inherit-common-to-bank');
            if (!res.ok) throw new Error('Failed to fetch inherit rules');
            const data = await res.json();
            setInheritRules(Array.isArray(data) ? data : []);
          } catch (e) {
            console.error(e);
            setInheritRules([]);
          } finally { setSubLoading(false); }
        }, []);

        React.useEffect(() => {
          if (crSubTab === 'common') fetchCommon();
          if (crSubTab === 'inherit') fetchInherit();
        }, [crSubTab, fetchCommon, fetchInherit]);

        // Persist selected subtab for stickiness across refresh/hard refresh
        React.useEffect(() => {
          try { window.localStorage.setItem('crSubTab', crSubTab); } catch (_) {}
        }, [crSubTab]);

        // CommonRules CRUD (Modal based)
        const Modal = window.Modal;
        const confirmAsync = async (message) => {
          try {
            if (typeof window.showConfirm === 'function') {
              return await window.showConfirm(message);
            }
          } catch (e) { /* ignore and fallback */ }
          return window.confirm(message);
        };
        const [commonOpen, setCommonOpen] = useState(false);
        const [commonMode, setCommonMode] = useState('add');
        const [commonForm, setCommonForm] = useState({ transaction_type: '', pattern_match_logic: '' });
        const [commonSaving, setCommonSaving] = useState(false);
        const [commonOriginal, setCommonOriginal] = useState(null);
        const onCommonChange = (e) => {
          const { name, value } = e.target;
          const v = (value || '').toString();
          setCommonForm(prev => ({ ...prev, [name]: name === 'transaction_type' ? v.toLowerCase() : v }));
        };
        const handleAddCommon = () => {
          setCommonForm({ transaction_type: '', pattern_match_logic: '' });
          setCommonMode('add');
          setCommonOriginal(null);
          setCommonOpen(true);
        };
        const handleDeleteCommon = async (r) => {
          const qs = new URLSearchParams({ transaction_type: r.transaction_type || '', pattern_match_logic: r.pattern_match_logic || '' }).toString();
          if (!(await confirmAsync('Delete common rule?'))) return;
          try {
            setSubLoading(true);
            const res = await fetch(`/api/common-rules?${qs}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete common rule');
            await fetchCommon();
          } catch (e) { console.error(e); } finally { setSubLoading(false); }
        };
        const handleEditCommon = (r) => {
          setCommonMode('edit');
          setCommonOriginal(r);
          setCommonForm({ transaction_type: (r.transaction_type||'').toLowerCase(), pattern_match_logic: r.pattern_match_logic||'' });
          setCommonOpen(true);
        };
        const onSubmitCommon = async (e) => {
          e.preventDefault();
          if (!commonForm.transaction_type || !commonForm.pattern_match_logic) return;
          try {
            setCommonSaving(true);
            const res = await fetch('/api/common-rules', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ transaction_type: (commonForm.transaction_type||'').trim().toLowerCase(), pattern_match_logic: (commonForm.pattern_match_logic||'').trim() })
            });
            if (!res.ok) throw new Error('Failed to save common rule');
            if (commonMode === 'edit' && commonOriginal && (commonOriginal.transaction_type !== commonForm.transaction_type || commonOriginal.pattern_match_logic !== commonForm.pattern_match_logic)) {
              const qs = new URLSearchParams({ transaction_type: commonOriginal.transaction_type || '', pattern_match_logic: commonOriginal.pattern_match_logic || '' }).toString();
              await fetch(`/api/common-rules?${qs}`, { method: 'DELETE' });
            }
            setCommonOpen(false);
            await fetchCommon();
          } catch (e) { console.error(e); } finally { setCommonSaving(false); }
        };

        // InheritCommonToBank CRUD (Modal based)
        const [inheritOpen, setInheritOpen] = useState(false);
        const [inheritMode, setInheritMode] = useState('add');
        const [inheritSaving, setInheritSaving] = useState(false);
        const [inheritOriginal, setInheritOriginal] = useState(null);
        const emptyInherit = { bankaccountname:'', transaction_type:'', pattern_match_logic:'', tax_category:'', property:'', group:'', otherentity:'' };
        const [inheritForm, setInheritForm] = useState(emptyInherit);
        const onInheritChange = (e) => {
          const { name, value } = e.target;
          const v = (value || '').toString();
          if (['bankaccountname','transaction_type','tax_category','property','group'].includes(name)) {
            setInheritForm(prev => ({ ...prev, [name]: v.toLowerCase() }));
          } else {
            setInheritForm(prev => ({ ...prev, [name]: v }));
          }
        };
        const handleAddInherit = () => {
          setInheritForm(emptyInherit);
          setInheritMode('add');
          setInheritOriginal(null);
          setInheritOpen(true);
        };
        const handleDeleteInherit = async (r) => {
          const params = {
            bankaccountname: r.bankaccountname || '',
            transaction_type: r.transaction_type || '',
            pattern_match_logic: r.pattern_match_logic || '',
            property: r.property || '',
            group: r.group || '',
            tax_category: r.tax_category || '',
            otherentity: r.otherentity || ''
          };
          const qs = new URLSearchParams(params).toString();
          if (!(await confirmAsync('Delete inherit rule?'))) return;
          try {
            setSubLoading(true);
            const res = await fetch(`/api/inherit-common-to-bank?${qs}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete inherit rule');
            await fetchInherit();
          } catch (e) { console.error(e); } finally { setSubLoading(false); }
        };
        const handleEditInherit = (r) => {
          setInheritMode('edit');
          setInheritOriginal(r);
          setInheritForm({
            bankaccountname: (r.bankaccountname||'').toLowerCase(),
            transaction_type: (r.transaction_type||'').toLowerCase(),
            pattern_match_logic: r.pattern_match_logic || '',
            tax_category: (r.tax_category||'').toLowerCase(),
            property: (r.property||'').toLowerCase(),
            group: (r.group||'').toLowerCase(),
            otherentity: r.otherentity || ''
          });
          setInheritOpen(true);
        };
        const onSubmitInherit = async (e) => {
          e.preventDefault();
          const payload = {
            bankaccountname: (inheritForm.bankaccountname||'').trim().toLowerCase(),
            transaction_type: (inheritForm.transaction_type||'').trim().toLowerCase(),
            pattern_match_logic: (inheritForm.pattern_match_logic||'').trim(),
            tax_category: (inheritForm.tax_category||'').trim().toLowerCase(),
            property: (inheritForm.property||'').trim().toLowerCase(),
            group: (inheritForm.group||'').trim().toLowerCase(),
            otherentity: (inheritForm.otherentity||'').trim(),
          };
          if (!payload.bankaccountname || !payload.transaction_type || !payload.pattern_match_logic) return;
          try {
            setInheritSaving(true);
            const res = await fetch('/api/inherit-common-to-bank', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error('Failed to save inherit rule');
            if (inheritMode === 'edit' && inheritOriginal) {
              const params = {
                bankaccountname: inheritOriginal.bankaccountname || '',
                transaction_type: inheritOriginal.transaction_type || '',
                pattern_match_logic: inheritOriginal.pattern_match_logic || '',
                property: inheritOriginal.property || '',
                tax_category: inheritOriginal.tax_category || '',
                otherentity: inheritOriginal.otherentity || ''
              };
              const qs = new URLSearchParams(params).toString();
              await fetch(`/api/inherit-common-to-bank?${qs}`, { method: 'DELETE' });
            }
            setInheritOpen(false);
            await fetchInherit();
          } catch (e) { console.error(e); } finally { setInheritSaving(false); }
        };
        return (
          <div>
            <div className="tabs" style={{ marginBottom: 12 }}>
              <button className={`tab ${crSubTab==='bank' ? 'active' : ''}`} onClick={() => setCrSubTab('bank')}>BankRules</button>
              <button className={`tab ${crSubTab==='common' ? 'active' : ''}`} onClick={() => setCrSubTab('common')}>CommonRules</button>
              <button className={`tab ${crSubTab==='inherit' ? 'active' : ''}`} onClick={() => setCrSubTab('inherit')}>InheritCommonToBank</button>
            </div>
            {crSubTab === 'bank' && (
              <div>
                <ClassifyRulesPanelExt
                  classifyRules={classifyRules}
                  loading={loading}
                  reload={load}
                  bankaccounts={bankaccounts}
                  items={items}
                  taxCategories={taxCategories}
                  transactionTypes={transactionTypes}
                  groups={groups}
                />
              </div>
            )}
            {crSubTab === 'common' && (
              <div className="card">
                <div className="actions" style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                  <div className="muted">CommonRules</div>
                  <div>
                    <button type="button" onClick={handleAddCommon} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add</button>
                    <button type="button" onClick={fetchCommon} disabled={subLoading} className="ml-2 px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:opacity-60">Refresh</button>
                  </div>
                </div>
                <Modal title={commonMode==='edit' ? 'Edit Common Rule' : 'Add Common Rule'} open={commonOpen} onClose={() => { setCommonOpen(false); setCommonMode('add'); setCommonOriginal(null); }} onSubmit={onSubmitCommon} submitLabel={commonSaving ? 'Saving...' : 'Save'} submitDisabled={!((commonForm.transaction_type||'').trim()) || !((commonForm.pattern_match_logic||'').trim())}>
                  <form onSubmit={onSubmitCommon} className="grid grid-cols-1 gap-5">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">transaction_type</label>
                      <select name="transaction_type" value={commonForm.transaction_type} onChange={onCommonChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Select transaction type</option>
                        {(transactionTypes || []).map(t => (
                          <option key={t.transactiontype} value={(t.transactiontype || '').toLowerCase()}>{t.transactiontype}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">pattern_match_logic</label>
                      <textarea name="pattern_match_logic" value={commonForm.pattern_match_logic} onChange={onCommonChange} rows={3} placeholder="e.g., desc_contains=rent" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required />
                    </div>
                  </form>
                </Modal>
                {subLoading ? (<div>Loading...</div>) : (
                  <table>
                    <thead>
                      <tr>
                        <th>transaction_type</th>
                        <th>pattern_match_logic</th>
                        <th>actions</th>
                      </tr>
                      <tr>
                        <th><input placeholder="filter" value={commonFilter.transaction_type} onChange={(e)=> setCommonFilter(f => ({...f, transaction_type: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={commonFilter.pattern_match_logic} onChange={(e)=> setCommonFilter(f => ({...f, pattern_match_logic: e.target.value}))} /></th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {(commonRules || [])
                        .filter(r => (
                          (commonFilter.transaction_type ? (r.transaction_type||'').toLowerCase().includes(commonFilter.transaction_type.toLowerCase()) : true) &&
                          (commonFilter.pattern_match_logic ? (r.pattern_match_logic||'').toLowerCase().includes(commonFilter.pattern_match_logic.toLowerCase()) : true)
                        ))
                        .map((r, idx) => (
                          <tr key={`common-${r.transaction_type}-${idx}`}>
                            <td>{r.transaction_type}</td>
                            <td className="whitespace-pre-wrap">{r.pattern_match_logic}</td>
                            <td>
                              <button onClick={() => handleEditCommon(r)} className="px-2 py-1 mr-2 bg-gray-700 text-white rounded hover:bg-gray-800">Edit</button>
                              <button onClick={() => handleDeleteCommon(r)} className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
                            </td>
                          </tr>
                        ))}
                      {(commonRules || []).length === 0 && (
                        <tr><td colSpan="3" className="muted">No common rules</td></tr>
                      )}
                    </tbody>
                  </table>
                )}
              </div>
            )}
            {crSubTab === 'inherit' && (
              <div className="card">
                <div className="actions" style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                  <div className="muted">InheritCommonToBank</div>
                  <div>
                    <button type="button" onClick={handleAddInherit} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add</button>
                    <button type="button" onClick={fetchInherit} disabled={subLoading} className="ml-2 px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:opacity-60">Refresh</button>
                  </div>
                </div>
                <Modal title={inheritMode==='edit' ? 'Edit Inherit Rule' : 'Add Inherit Rule'} open={inheritOpen} onClose={() => { setInheritOpen(false); setInheritMode('add'); setInheritOriginal(null); }} onSubmit={onSubmitInherit} submitLabel={inheritSaving ? 'Saving...' : 'Save'} submitDisabled={!((inheritForm.bankaccountname||'').trim()) || !((inheritForm.transaction_type||'').trim()) || !((inheritForm.pattern_match_logic||'').trim())}>
                  <form onSubmit={onSubmitInherit} className="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">bankaccountname</label>
                      <select name="bankaccountname" value={inheritForm.bankaccountname} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Select bank account</option>
                        {(bankaccounts || []).map(b => (
                          <option key={b.bankaccountname} value={(b.bankaccountname || '').toLowerCase()}>{b.bankaccountname}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">transaction_type</label>
                      <select name="transaction_type" value={inheritForm.transaction_type} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Select transaction type</option>
                        {(transactionTypes || []).map(t => (
                          <option key={t.transactiontype} value={(t.transactiontype || '').toLowerCase()}>{t.transactiontype}</option>
                        ))}
                      </select>
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700">pattern_match_logic</label>
                      <textarea name="pattern_match_logic" value={inheritForm.pattern_match_logic} onChange={onInheritChange} rows={3} placeholder="e.g., desc_contains=rent" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">tax_category</label>
                      <select name="tax_category" value={inheritForm.tax_category} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select tax category</option>
                        {(taxCategories || []).map(c => (
                          <option key={c.category} value={(c.category || '').toLowerCase()}>{c.category}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">property</label>
                      <select name="property" value={inheritForm.property} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select property</option>
                        {(items || []).map(p => (
                          <option key={p.property} value={(p.property || '').toLowerCase()}>{p.property}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">group</label>
                      <select name="group" value={inheritForm.group} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select group (optional)</option>
                        {(groups || []).map(g => (
                          <option key={g.groupname} value={(g.groupname || '').toLowerCase()}>{g.groupname}</option>
                        ))}
                      </select>
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700">otherentity</label>
                      <input name="otherentity" value={inheritForm.otherentity} onChange={onInheritChange} placeholder="optional" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                  </form>
                </Modal>
                {subLoading ? (<div>Loading...</div>) : (
                  <table>
                    <thead>
                      <tr>
                        <th>bankaccountname</th>
                        <th>tax_category</th>
                        <th>property</th>
                        <th>group</th>
                        <th>otherentity</th>
                        <th>actions</th>
                      </tr>
                      <tr>
                        <th><input placeholder="filter" value={inheritFilter.bankaccountname} onChange={(e)=> setInheritFilter(f => ({...f, bankaccountname: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.tax_category} onChange={(e)=> setInheritFilter(f => ({...f, tax_category: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.property} onChange={(e)=> setInheritFilter(f => ({...f, property: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.group} onChange={(e)=> setInheritFilter(f => ({...f, group: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.otherentity} onChange={(e)=> setInheritFilter(f => ({...f, otherentity: e.target.value}))} /></th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {(inheritRules || [])
                        .filter(r => (
                          (inheritFilter.bankaccountname ? (r.bankaccountname||'').toLowerCase().includes(inheritFilter.bankaccountname.toLowerCase()) : true) &&
                          (inheritFilter.tax_category ? (r.tax_category||'').toLowerCase().includes(inheritFilter.tax_category.toLowerCase()) : true) &&
                          (inheritFilter.property ? (r.property||'').toLowerCase().includes(inheritFilter.property.toLowerCase()) : true) &&
                          (inheritFilter.group ? (r.group||'').toLowerCase().includes(inheritFilter.group.toLowerCase()) : true) &&
                          (inheritFilter.otherentity ? (r.otherentity||'').toLowerCase().includes(inheritFilter.otherentity.toLowerCase()) : true)
                        ))
                        .map((r, idx) => (
                          <tr key={`inherit-${r.bankaccountname}-${r.property}-${idx}`}>
                            <td>{r.bankaccountname}</td>
                            <td>{r.tax_category}</td>
                            <td>{r.property}</td>
                            <td>{r.group}</td>
                            <td>{r.otherentity}</td>
                            <td>
                              <button onClick={() => handleEditInherit(r)} className="px-2 py-1 mr-2 bg-gray-700 text-white rounded hover:bg-gray-800">Edit</button>
                              <button onClick={() => handleDeleteInherit(r)} className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
                            </td>
                          </tr>
                        ))}
                      {(inheritRules || []).length === 0 && (
                        <tr><td colSpan="6" className="muted">No bank-specific rules</td></tr>
                      )}
                    </tbody>
                  </table>
                )}
              </div>
            )}
          </div>
        );
      }

      const api = {
        async list() {
          const res = await fetch('/api/properties');
          if (!res.ok) throw new Error('Failed to fetch properties');
          return res.json();
        },
        async add(item) {
          const res = await fetch('/api/properties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || 'Failed to add property');
          }

      function CompaniesPanel({ companyRecords, loading, reload }) {
        const emptyCompany = { companyname: '', rentPercentage: 0 };
        const [form, setForm] = React.useState(emptyCompany);
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ companyname: '', rentPercentage: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'rentPercentage') {
            setForm({ ...form, [name]: Number(value || 0) });
          } else if (name === 'companyname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
      window.api = api;
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            if (!form.companyname) throw new Error('companyname is required');
            const payload = { ...form, companyname: form.companyname.trim().toLowerCase() };
            await api.addCompanyRecord(payload);
            setForm(emptyCompany);
            await reload();
          } catch (e) { setError(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeCompanyRecord(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Company Records</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>companyname<br/>
                    <input name="companyname" value={form.companyname} onChange={onChange} placeholder="company name (lowercased)" />
                  </label></div>
                  <div className="col"><label>rentPercentage<br/>
                    <input name="rentPercentage" type="number" value={form.rentPercentage} onChange={onChange} min="0" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add company</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>companyname</th>
                      <th>rentPercentage</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th>
                        <input
                          placeholder="filter"
                          value={filter.companyname}
                          onChange={(e)=> setFilter(f=>({...f, companyname: e.target.value }))}
                        />
                      </th>
                      <th>
                        <input
                          placeholder="filter"
                          value={filter.rentPercentage}
                          onChange={(e)=> setFilter(f=>({...f, rentPercentage: e.target.value }))}
                        />
                      </th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {companyRecords
                      .filter(x => (
                        (filter.companyname ? (x.companyname||'').toString().toLowerCase().includes(filter.companyname.toLowerCase()) : true) &&
                        (filter.rentPercentage ? String(x.rentPercentage||'').toLowerCase().includes(filter.rentPercentage.toLowerCase()) : true)
                      ))
                      .map((x) => (
                      <tr key={x.companyname}>
                        <td>{x.companyname}</td>
                        <td>{x.rentPercentage}</td>
                        <td><button onClick={() => onDelete(x.companyname)}>Delete</button></td>
                      </tr>
                    ))}
                    {companyRecords.length === 0 && (<tr><td colSpan="3" className="muted">No company records</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function BankAccountsPanel({ bankaccounts, loading, reload }) {
        const emptyBA = { bankaccountname: '', bankname: '' };
        const [form, setForm] = React.useState(emptyBA);
        const [saving, setSaving] = React.useState(false);
        const [filter, setFilter] = React.useState({ bankaccountname: '', bankname: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'bankaccountname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else if (name === 'bankname') {
            setForm({ ...form, [name]: (value || '').toLowerCase() });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true);
          try {
            if (!form.bankaccountname || !form.bankname) throw new Error('bankaccountname and bankname are required');
            await api.addBankaccount(form);
            setForm(emptyBA);
            await reload();
          } catch (e) { alert(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBankaccount(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Bank Accounts</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>bankaccountname<br/>
                    <input name="bankaccountname" value={form.bankaccountname} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>bankname<br/>
                    <input name="bankname" value={form.bankname} onChange={onChange} placeholder="bank name" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add bank account</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>bankaccountname</th>
                      <th>bankname</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th>
                        <input placeholder="filter" value={filter.bankaccountname} onChange={(e)=> setFilter(f=>({...f, bankaccountname: e.target.value }))} />
                      </th>
                      <th>
                        <input placeholder="filter" value={filter.bankname} onChange={(e)=> setFilter(f=>({...f, bankname: e.target.value }))} />
                      </th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {bankaccounts
                      .filter(x => (
                        (filter.bankaccountname ? (x.bankaccountname||'').toLowerCase().includes(filter.bankaccountname.toLowerCase()) : true) &&
                        (filter.bankname ? (x.bankname||'').toLowerCase().includes(filter.bankname.toLowerCase()) : true)
                      ))
                      .map(x => (
                      <tr key={x.bankaccountname}>
                        <td>{x.bankaccountname}</td>
                        <td>{x.bankname}</td>
                        <td><button onClick={() => onDelete(x.bankaccountname)}>Delete</button></td>
                      </tr>
                    ))}
                    {bankaccounts.length === 0 && (<tr><td colSpan="3" className="muted">No bank accounts</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function GroupsPanel({ groups, loading, reload }) {
        const emptyGroup = { groupname: '', propertylist: '' };
        const [form, setForm] = React.useState(emptyGroup);
        const [saving, setSaving] = React.useState(false);
        const [filter, setFilter] = React.useState({ groupname: '', propertylist: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'groupname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true);
          try {
            const payload = { groupname: form.groupname, propertylist: (form.propertylist || '').split('|').map(s=>s.trim().toLowerCase()).filter(Boolean) };
            if (!payload.groupname) throw new Error('groupname is required');
            await api.addGroup(payload);
            setForm(emptyGroup);
            await reload();
          } catch (e) { alert(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeGroup(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Groups</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>groupname<br/>
                    <input name="groupname" value={form.groupname} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>propertylist (pipe-separated)<br/>
                    <input name="propertylist" value={form.propertylist} onChange={onChange} placeholder="p1|p2|p3" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add group</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>groupname</th>
                      <th>propertylist</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th>
                        <input placeholder="filter" value={filter.groupname} onChange={(e)=> setFilter(f=>({...f, groupname: e.target.value }))} />
                      </th>
                      <th>
                        <input placeholder="filter" value={filter.propertylist} onChange={(e)=> setFilter(f=>({...f, propertylist: e.target.value }))} />
                      </th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {groups
                      .filter(x => (
                        (filter.groupname ? (x.groupname||'').toLowerCase().includes(filter.groupname.toLowerCase()) : true) &&
                        (filter.propertylist ? (x.propertylist||[]).join(' ').toLowerCase().includes(filter.propertylist.toLowerCase()) : true)
                      ))
                      .map(x => (
                      <tr key={x.groupname}>
                        <td>{x.groupname}</td>
                        <td>{x.propertylist.join(' | ')}</td>
                        <td><button onClick={() => onDelete(x.groupname)}>Delete</button></td>
                      </tr>
                    ))}
                    {groups.length === 0 && (<tr><td colSpan="3" className="muted">No groups</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function OwnersPanel({ owners, loading, reload, bankaccounts, items, companies }) {
        const emptyOwner = { name: '', bankaccounts: [], properties: [], companies: [] };
        const [form, setForm] = React.useState(emptyOwner);
        const [saving, setSaving] = React.useState(false);
        const [filter, setFilter] = React.useState({ name: '', bankaccounts: '', properties: '', companies: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'name') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else if (e.target.multiple) {
            const selected = Array.from(e.target.selectedOptions).map(o => (o.value || '').toLowerCase());
            setForm({ ...form, [name]: selected });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true);
          try {
            if (!form.name) throw new Error('name is required');
            const payload = {
              name: form.name,
              bankaccounts: Array.from(new Set((form.bankaccounts || []).map(s => (s || '').toLowerCase()))),
              properties: Array.from(new Set((form.properties || []).map(s => (s || '').toLowerCase()))),
              companies: Array.from(new Set((form.companies || []).map(s => (s || '').toLowerCase()))),
            };
            await api.addOwner(payload);
            setForm(emptyOwner);
            await reload();
          } catch (e) { alert(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeOwner(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Owners</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>name<br/>
                    <input name="name" value={form.name} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>bankaccounts (multi-select)<br/>
                    <select name="bankaccounts" multiple value={form.bankaccounts} onChange={onChange}>
                      {bankaccounts.map(ba => (
                        <option key={ba.bankaccountname} value={ba.bankaccountname}>{ba.bankaccountname}</option>
                      ))}
                    </select>
                  </label></div>
                  <div className="col"><label>properties (multi-select)<br/>
                    <select name="properties" multiple value={form.properties} onChange={onChange}>
                      {items.map(p => (
                        <option key={p.property} value={p.property}>{p.property}</option>
                      ))}
                    </select>
                  </label></div>
                  <div className="col"><label>companies (multi-select)<br/>
                    <select name="companies" multiple value={form.companies} onChange={onChange}>
                      {companies.map(c => (
                        <option key={c} value={c}>{c}</option>
                      ))}
                    </select>
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add owner</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>name</th>
                      <th>bankaccounts</th>
                      <th>properties</th>
                      <th>companies</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.name} onChange={(e)=> setFilter(f=>({...f, name: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.bankaccounts} onChange={(e)=> setFilter(f=>({...f, bankaccounts: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.properties} onChange={(e)=> setFilter(f=>({...f, properties: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.companies} onChange={(e)=> setFilter(f=>({...f, companies: e.target.value }))} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {owners
                      .filter(x => (
                        (filter.name ? (x.name||'').toLowerCase().includes(filter.name.toLowerCase()) : true) &&
                        (filter.bankaccounts ? (x.bankaccounts||[]).join(' ').toLowerCase().includes(filter.bankaccounts.toLowerCase()) : true) &&
                        (filter.properties ? (x.properties||[]).join(' ').toLowerCase().includes(filter.properties.toLowerCase()) : true) &&
                        (filter.companies ? (x.companies||[]).join(' ').toLowerCase().includes(filter.companies.toLowerCase()) : true)
                      ))
                      .map(x => (
                      <tr key={x.name}>
                        <td>{x.name}</td>
                        <td>{x.bankaccounts.join(' | ')}</td>
                        <td>{x.properties.join(' | ')}</td>
                        <td>{x.companies.join(' | ')}</td>
                        <td><button onClick={() => onDelete(x.name)}>Delete</button></td>
                      </tr>
                    ))}
                    {owners.length === 0 && (<tr><td colSpan="5" className="muted">No owners</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function PropertiesPanel({ items, companies, loading, reload }) {
        const empty = { property: '', cost: 0, landValue: 0, renovation: 0, loanClosingCOst: 0, ownerCount: 1, purchaseDate: '', propMgmgtComp: '' };
        const [form, setForm] = React.useState(empty);
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ property:'', cost:'', landValue:'', renovation:'', loanClosingCOst:'', ownerCount:'', purchaseDate:'', propMgmgtComp:'' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if ([ 'cost','landValue','renovation','loanClosingCOst','ownerCount' ].includes(name)) {
            setForm({ ...form, [name]: Number(value || 0) });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            if (!form.property) throw new Error('property is required');
            const payload = {
              ...form,
              property: (form.property || '').trim().toLowerCase(),
              purchaseDate: (form.purchaseDate || '').trim().toLowerCase(),
              propMgmgtComp: (form.propMgmgtComp || '').trim().toLowerCase(),
            };
            await api.add(payload);
            setForm(empty);
            await reload();
          } catch (e) { setError(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (id) => {
          if (!confirm(`Delete ${id}?`)) return;
          try { await api.remove(id); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Properties</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>property<br/><input name="property" value={form.property} onChange={onChange} placeholder="unique id" required /></label></div>
                  <div className="col"><label>cost<br/><input name="cost" type="number" value={form.cost} onChange={onChange} /></label></div>
                  <div className="col"><label>landValue<br/><input name="landValue" type="number" value={form.landValue} onChange={onChange} /></label></div>
                  <div className="col"><label>renovation<br/><input name="renovation" type="number" value={form.renovation} onChange={onChange} /></label></div>
                  <div className="col"><label>loanClosingCOst<br/><input name="loanClosingCOst" type="number" value={form.loanClosingCOst} onChange={onChange} /></label></div>
                  <div className="col"><label>ownerCount<br/><input name="ownerCount" type="number" value={form.ownerCount} onChange={onChange} min="1" /></label></div>
                  <div className="col"><label>purchaseDate<br/><input name="purchaseDate" type="text" value={form.purchaseDate} onChange={onChange} placeholder="MM/DD/YYYY" /></label></div>
                  <div className="col"><label>propMgmgtComp<br/>
                    <select name="propMgmgtComp" value={form.propMgmgtComp} onChange={onChange}>
                      <option value="">Select company</option>
                      {companies.map((c) => (
                        <option key={c} value={c}>{c}</option>
                      ))}
                    </select>
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add property</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                  <span className="muted">All data is in-memory only.</span>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>property</th>
                      <th>cost</th>
                      <th>landValue</th>
                      <th>renovation</th>
                      <th>loanClosingCOst</th>
                      <th>ownerCount</th>
                      <th>purchaseDate</th>
                      <th>propMgmgtComp</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.property} onChange={(e)=> setFilter(f=>({...f, property: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.cost} onChange={(e)=> setFilter(f=>({...f, cost: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.landValue} onChange={(e)=> setFilter(f=>({...f, landValue: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.renovation} onChange={(e)=> setFilter(f=>({...f, renovation: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.loanClosingCOst} onChange={(e)=> setFilter(f=>({...f, loanClosingCOst: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.ownerCount} onChange={(e)=> setFilter(f=>({...f, ownerCount: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.purchaseDate} onChange={(e)=> setFilter(f=>({...f, purchaseDate: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.propMgmgtComp} onChange={(e)=> setFilter(f=>({...f, propMgmgtComp: e.target.value }))} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {items
                      .filter(x => (
                        (filter.property ? (x.property||'').toLowerCase().includes(filter.property.toLowerCase()) : true) &&
                        (filter.cost ? String(x.cost||'').toLowerCase().includes(filter.cost.toLowerCase()) : true) &&
                        (filter.landValue ? String(x.landValue||'').toLowerCase().includes(filter.landValue.toLowerCase()) : true) &&
                        (filter.renovation ? String(x.renovation||'').toLowerCase().includes(filter.renovation.toLowerCase()) : true) &&
                        (filter.loanClosingCOst ? String(x.loanClosingCOst||'').toLowerCase().includes(filter.loanClosingCOst.toLowerCase()) : true) &&
                        (filter.ownerCount ? String(x.ownerCount||'').toLowerCase().includes(filter.ownerCount.toLowerCase()) : true) &&
                        (filter.purchaseDate ? String(x.purchaseDate||'').toLowerCase().includes(filter.purchaseDate.toLowerCase()) : true) &&
                        (filter.propMgmgtComp ? String(x.propMgmgtComp||'').toLowerCase().includes(filter.propMgmgtComp.toLowerCase()) : true)
                      ))
                      .map((x) => (
                      <tr key={x.property}>
                        <td>{x.property}</td>
                        <td>{x.cost}</td>
                        <td>{x.landValue}</td>
                        <td>{x.renovation}</td>
                        <td>{x.loanClosingCOst}</td>
                        <td>{x.ownerCount}</td>
                        <td>{x.purchaseDate}</td>
                        <td>{x.propMgmgtComp}</td>
                        <td><button onClick={() => onDelete(x.property)}>Delete</button></td>
                      </tr>
                    ))}
                    {items.length === 0 && (<tr><td colSpan="9" className="muted">No items</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      // Tax Categories Panel
      function TaxCategoriesPanel({ taxCategories, loading, reload }) {
        const [form, setForm] = React.useState({ category: '' });
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ category: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: name === 'category' ? (value || '').trim().toLowerCase() : value }));
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            const category = (form.category || '').trim().toLowerCase();
            if (!category) throw new Error('category is required');
            await api.addTaxCategory({ category });
            setForm({ category: '' });
            await reload();
          } catch (err) { setError(err.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (category) => {
          if (!confirm(`Delete ${category}?`)) return;
          try { await api.removeTaxCategory(category); await reload(); } catch (err) { alert(err.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Tax Categories</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>category<br/>
                    <input name="category" value={form.category} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add category</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>category</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.category} onChange={(e)=> setFilter({ category: e.target.value })} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {taxCategories
                      .filter(t => (filter.category ? (t.category||'').toLowerCase().includes(filter.category.toLowerCase()) : true))
                      .map(t => (
                      <tr key={t.category}>
                        <td>{t.category}</td>
                        <td><button onClick={() => onDelete(t.category)}>Delete</button></td>
                      </tr>
                    ))}
                    {taxCategories.length === 0 && (<tr><td colSpan="2" className="muted">No tax categories</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      // Transaction Types Panel
      function TransactionTypesPanel({ transactionTypes, loading, reload }) {
        const [form, setForm] = React.useState({ transactiontype: '' });
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ transactiontype: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: name === 'transactiontype' ? (value || '').trim().toLowerCase() : value }));
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            const transactiontype = (form.transactiontype || '').trim().toLowerCase();
            if (!transactiontype) throw new Error('transactiontype is required');
            await api.addTransactionType({ transactiontype });
            setForm({ transactiontype: '' });
            await reload();
          } catch (err) { setError(err.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (tt) => {
          if (!confirm(`Delete ${tt}?`)) return;
          try { await api.removeTransactionType(tt); await reload(); } catch (err) { alert(err.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Transaction Types</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>transactiontype<br/>
                    <input name="transactiontype" value={form.transactiontype} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add type</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>transactiontype</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.transactiontype} onChange={(e)=> setFilter({ transactiontype: e.target.value })} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {transactionTypes
                      .filter(t => (filter.transactiontype ? (t.transactiontype||'').toLowerCase().includes(filter.transactiontype.toLowerCase()) : true))
                      .map(t => (
                      <tr key={t.transactiontype}>
                        <td>{t.transactiontype}</td>
                        <td><button onClick={() => onDelete(t.transactiontype)}>Delete</button></td>
                      </tr>
                    ))}
                    {transactionTypes.length === 0 && (<tr><td colSpan="2" className="muted">No transaction types</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }
          return res.json();
        },
        async remove(id) {
          const res = await fetch(`/api/properties/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete');
        },
        async companies() {
          const res = await fetch('/api/companies');
          if (!res.ok) throw new Error('Failed to fetch companies');
          return res.json();
        },
        async listCompanyRecords() {
          const res = await fetch('/api/company-records');
          if (!res.ok) throw new Error('Failed to fetch company records');
          return res.json();
        },
        async addCompanyRecord(item) {
          const res = await fetch('/api/company-records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || 'Failed to add company record');
          }
          return res.json();
        },
        async removeCompanyRecord(name) {
          const res = await fetch(`/api/company-records/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete company record');
        },
        // Bank accounts
        async listBankaccounts() {
          const res = await fetch('/api/bankaccounts');
          if (!res.ok) throw new Error('Failed to fetch bank accounts');
          return res.json();
        },
        async addBankaccount(item) {
          const res = await fetch('/api/bankaccounts', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeBankaccount(name) {
          const res = await fetch(`/api/bankaccounts/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete bank account');
        },
        // Groups
        async listGroups() {
          const res = await fetch('/api/groups');
          if (!res.ok) throw new Error('Failed to fetch groups');
          return res.json();
        },
        async addGroup(item) {
          const res = await fetch('/api/groups', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeGroup(name) {
          const res = await fetch(`/api/groups/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete group');
        },
        // Owners
        async listOwners() {
          const res = await fetch('/api/owners');
          if (!res.ok) throw new Error('Failed to fetch owners');
          return res.json();
        },
        async addOwner(item) {
          const res = await fetch('/api/owners', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeOwner(name) {
          const res = await fetch(`/api/owners/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete owner');
        },
        // Tax categories
        async listTaxCategories() {
          const res = await fetch('/api/tax-categories');
          if (!res.ok) throw new Error('Failed to fetch tax categories');
          return res.json();
        },
        async addTaxCategory(item) {
          const res = await fetch('/api/tax-categories', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeTaxCategory(category) {
          const res = await fetch(`/api/tax-categories/${encodeURIComponent(category)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete tax category');
        },
        // Transaction types
        async listTransactionTypes() {
          const res = await fetch('/api/transaction-types');
          if (!res.ok) throw new Error('Failed to fetch transaction types');
          return res.json();
        },
        async addTransactionType(item) {
          const res = await fetch('/api/transaction-types', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeTransactionType(tt) {
          const res = await fetch(`/api/transaction-types/${encodeURIComponent(tt)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete transaction type');
        },
        // Classify rules
        async listClassifyRules() {
          const res = await fetch('/api/classify-rules');
          if (res.status === 404) return [];
          if (!res.ok) throw new Error('Failed to fetch classify rules');
          return res.json();
        },
        async addClassifyRule(item) {
          const res = await fetch('/api/classify-rules', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeClassifyRule(key) {
          // key can be an object; encode a composite id if backend expects one
          const obj = (typeof key === 'object' && key !== null) ? key : { bankaccountname: key };
          const bankVal = obj.bankaccountname != null ? obj.bankaccountname : '';
          const qp = new URLSearchParams({
            bankaccountname: String(bankVal),
            transaction_type: obj.transaction_type || '',
            property: obj.property || '',
          }).toString();
          const res = await fetch(`/api/classify-rules?${qp}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete classify rule');
        },

        // Banks config
        async listBanks() {
          const res = await fetch('/api/banks');
          if (!res.ok) throw new Error('Failed to fetch banks config');
          return res.json();
        },
        async addBank(cfg) {
          const res = await fetch('/api/banks', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeBank(name) {
          const res = await fetch(`/api/banks/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete bank config');
        }
      };

      // Banks Panel component (encapsulates its own form state and handlers)
      function BanksPanel({ banks, loading, reload }) {
        const [form, setForm] = React.useState({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const onChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: value }));
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            const name = (form.name || '').trim().toLowerCase();
            if (!name) throw new Error('name is required');
            const ignore_lines_contains = (form.ignore_lines_contains || '').split('|').map(s=>s.trim()).filter(Boolean);
            const ignore_lines_startswith = (form.ignore_lines_startswith || '').split('|').map(s=>s.trim()).filter(Boolean);
            let columns = [];
            if (form.columnsText && form.columnsText.trim()) {
              try { columns = JSON.parse(form.columnsText); } catch (_) { columns = []; }
            }
            const payload = {
              name,
              date_format: form.date_format || undefined,
              delim: form.delim || undefined,
              ignore_lines_contains: ignore_lines_contains.length ? ignore_lines_contains : undefined,
              ignore_lines_startswith: ignore_lines_startswith.length ? ignore_lines_startswith : undefined,
              columns: columns.length ? columns : undefined,
            };
            await api.addBank(payload);
            setForm({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
            await reload();
          } catch (err) { setError(err.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBank(name); await reload(); } catch (err) { alert(err.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Banks</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>name<br/>
                    <input name="name" value={form.name} onChange={onChange} placeholder="lowercase id [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>date_format<br/>
                    <input name="date_format" value={form.date_format} onChange={onChange} placeholder="M/d/yyyy" />
                  </label></div>
                  <div className="col"><label>delim<br/>
                    <input name="delim" value={form.delim} onChange={onChange} placeholder="," />
                  </label></div>
                  <div className="col"><label>ignore_lines_contains (| separated)<br/>
                    <input name="ignore_lines_contains" value={form.ignore_lines_contains} onChange={onChange} placeholder="foo|bar" />
                  </label></div>
                  <div className="col"><label>ignore_lines_startswith (| separated)<br/>
                    <input name="ignore_lines_startswith" value={form.ignore_lines_startswith} onChange={onChange} placeholder="Header|Total" />
                  </label></div>
                  <div className="col" style={{flexBasis:'100%'}}><label>columns (JSON array)<br/>
                    <input name="columnsText" value={form.columnsText} onChange={onChange} placeholder='[{"date":1,"description":2,"debit":3}]' />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add bank</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>name</th>
                      <th>date_format</th>
                      <th>delim</th>
                      <th>ignore_lines_contains</th>
                      <th>ignore_lines_startswith</th>
                      <th>columns</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {banks.map(b => (
                      <tr key={b.name}>
                        <td>{b.name}</td>
                        <td>{b.date_format || ''}</td>
                        <td>{b.delim || ''}</td>
                        <td>{(b.ignore_lines_contains || []).join(' | ')}</td>
                        <td>{(b.ignore_lines_startswith || []).join(' | ')}</td>
                        <td>{(b.columns || []).map((c, i) => (
                          <span key={i}>{Object.entries(c).map(([k,v]) => `${k}:${v}`).join(', ')}{i < (b.columns.length-1) ? ' | ' : ''}</span>
                        ))}</td>
                        <td><button onClick={() => onDelete(b.name)}>Delete</button></td>
                      </tr>
                    ))}
                    {banks.length === 0 && (<tr><td colSpan="7" className="muted">No bank configs</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function App() {
        const [items, setItems] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');
        const [companies, setCompanies] = useState([]);
        const [companyRecords, setCompanyRecords] = useState([]);
        const [bankaccounts, setBankaccounts] = useState([]);
        const [groups, setGroups] = useState([]);
        const [owners, setOwners] = useState([]);
        const [taxCategories, setTaxCategories] = useState([]);
        const [transactionTypes, setTransactionTypes] = useState([]);
        const [banks, setBanks] = useState([]);
        const [classifyRules, setClassifyRules] = useState([]);
        const [taxCatForm, setTaxCatForm] = useState({ category: '' });
        const [txTypeForm, setTxTypeForm] = useState({ transactiontype: '' });
        const [bankForm, setBankForm] = useState({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
        const [savingTaxCat, setSavingTaxCat] = useState(false);
        const [savingTxType, setSavingTxType] = useState(false);
        const [savingBank, setSavingBank] = useState(false);

        // Tabs state (persisted)
        const [topTab, setTopTab] = useState(() => {
          try { return window.localStorage.getItem('topTab') || 'setup'; } catch (_) { return 'setup'; }
        }); // 'setup' | 'classifyrules' | 'transactions' | 'report'
        const [setupTab, setSetupTab] = useState(() => {
          try { return window.localStorage.getItem('setupTab') || 'properties'; } catch (_) { return 'properties'; }
        }); // 'properties' | 'companies' | 'bankaccounts' | 'groups' | 'owners' | 'banks' | 'taxcats' | 'txtypes'

        const empty = { property: '', cost: 0, landValue: 0, renovation: 0, loanClosingCOst: 0, ownerCount: 1, purchaseDate: '', propMgmgtComp: '' };
        const [form, setForm] = useState(empty);
        const [saving, setSaving] = useState(false);

        const load = async () => {
          setError('');
          setLoading(true);
          try {
            const [data, comps, compRecs, bas, grps, ownrs, taxcats, txtypes, banksCfg, rules] = await Promise.all([
              api.list(),
              api.companies(),
              api.listCompanyRecords(),
              api.listBankaccounts(),
              api.listGroups(),
              api.listOwners(),
              api.listTaxCategories(),
              api.listTransactionTypes(),
              api.listBanks(),
              api.listClassifyRules()
            ]);
            setItems(data);
            setCompanies(comps);
            setCompanyRecords(compRecs);
            setBankaccounts(bas);
            setGroups(grps);
            setOwners(ownrs);
            setTaxCategories(taxcats);
            setTransactionTypes(txtypes);
            setBanks(banksCfg);
            setClassifyRules(rules);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => { load(); }, []);

        // Persist tab selections
        useEffect(() => {
          try { window.localStorage.setItem('topTab', topTab); } catch (_) {}
        }, [topTab]);
        useEffect(() => {
          try { window.localStorage.setItem('setupTab', setupTab); } catch (_) {}
        }, [setupTab]);

        const onChange = (e) => {
          const { name, value } = e.target;
          if ([ 'cost','landValue','renovation','loanClosingCOst','ownerCount' ].includes(name)) {
            setForm({ ...form, [name]: Number(value || 0) });
          } else {
            setForm({ ...form, [name]: value });
          }
        };

        // Tax Categories handlers
        const onTaxCatChange = (e) => {
          const { name, value } = e.target;
          setTaxCatForm(prev => ({ ...prev, [name]: name === 'category' ? (value || '').trim().toLowerCase() : value }));
        };
        const onTaxCatSubmit = async (e) => {
          e.preventDefault(); setSavingTaxCat(true); setError('');
          try {
            const category = (taxCatForm.category || '').trim().toLowerCase();
            if (!category) throw new Error('category is required');
            await api.addTaxCategory({ category });
            setTaxCatForm({ category: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingTaxCat(false); }
        };
        const onTaxCatDelete = async (category) => {
          if (!confirm(`Delete ${category}?`)) return;
          try { await api.removeTaxCategory(category); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        // Transaction Types handlers
        const onTxTypeChange = (e) => {
          const { name, value } = e.target;
          setTxTypeForm(prev => ({ ...prev, [name]: name === 'transactiontype' ? (value || '').trim().toLowerCase() : value }));
        };
        const onTxTypeSubmit = async (e) => {
          e.preventDefault(); setSavingTxType(true); setError('');
          try {
            const transactiontype = (txTypeForm.transactiontype || '').trim().toLowerCase();
            if (!transactiontype) throw new Error('transactiontype is required');
            await api.addTransactionType({ transactiontype });
            setTxTypeForm({ transactiontype: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingTxType(false); }
        };
        const onTxTypeDelete = async (tt) => {
          if (!confirm(`Delete ${tt}?`)) return;
          try { await api.removeTransactionType(tt); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        // Banks handlers
        const onBankChange = (e) => {
          const { name, value } = e.target;
          setBankForm(prev => ({ ...prev, [name]: value }));
        };
        const onBankSubmit = async (e) => {
          e.preventDefault(); setSavingBank(true); setError('');
          try {
            const name = (bankForm.name || '').trim().toLowerCase();
            if (!name) throw new Error('name is required');
            const ignore_lines_contains = (bankForm.ignore_lines_contains || '')
              .split('|').map(s => s.trim()).filter(Boolean);
            const ignore_lines_startswith = (bankForm.ignore_lines_startswith || '')
              .split('|').map(s => s.trim()).filter(Boolean);
            let columns = [];
            if (bankForm.columnsText && bankForm.columnsText.trim()) {
              try { columns = JSON.parse(bankForm.columnsText); } catch (_) { columns = []; }
            }
            const payload = {
              name,
              date_format: bankForm.date_format || undefined,
              delim: bankForm.delim || undefined,
              ignore_lines_contains: ignore_lines_contains.length ? ignore_lines_contains : undefined,
              ignore_lines_startswith: ignore_lines_startswith.length ? ignore_lines_startswith : undefined,
              columns: columns.length ? columns : undefined,
            };
            await api.addBank(payload);
            setBankForm({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingBank(false); }
        };
        const onBankDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBank(name); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        const onSubmit = async (e) => {
          e.preventDefault();
          setSaving(true);
          setError('');
          try {
            if (!form.property) throw new Error('property is required');
            const payload = {
              ...form,
              property: (form.property || '').trim().toLowerCase(),
              purchaseDate: (form.purchaseDate || '').trim().toLowerCase(),
              propMgmgtComp: (form.propMgmgtComp || '').trim().toLowerCase(),
            };
            const created = await api.add(payload);
            setItems([ ...items, created ]);
            setForm(empty);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setSaving(false);
          }
        };

        const onDelete = async (id) => {
          if (!confirm(`Delete ${id}?`)) return;
          try {
            await api.remove(id);
            setItems(items.filter(x => x.property !== id));
          } catch (e) {
            alert(e.message || 'Error');
          }
        };

        // Company Records form
        const emptyCompany = { companyname: '', rentPercentage: 0 };
        const [companyForm, setCompanyForm] = useState(emptyCompany);
        const [savingCompany, setSavingCompany] = useState(false);

        const onCompanyChange = (e) => {
          const { name, value } = e.target;
          if (name === 'rentPercentage') {
            setCompanyForm({ ...companyForm, [name]: Number(value || 0) });
          } else if (name === 'companyname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            setCompanyForm({ ...companyForm, [name]: sanitized });
          } else {
            setCompanyForm({ ...companyForm, [name]: value });
          }
        };

        const onCompanySubmit = async (e) => {
          e.preventDefault();
          setSavingCompany(true);
          setError('');
          try {
            if (!companyForm.companyname) throw new Error('companyname is required');
            const payload = { ...companyForm, companyname: companyForm.companyname.trim().toLowerCase() };
            const created = await api.addCompanyRecord(payload);
            setCompanyRecords([ ...companyRecords, created ]);
            setCompanyForm(emptyCompany);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setSavingCompany(false);
          }
        };

        const onCompanyDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try {
            await api.removeCompanyRecord(name);
            setCompanyRecords(companyRecords.filter(x => x.companyname !== name));
          } catch (e) {
            alert(e.message || 'Error');
          }
        };

        // Bank account form
        const emptyBA = { bankaccountname: '', bankname: '' };
        const [baForm, setBaForm] = useState(emptyBA);
        const [savingBA, setSavingBA] = useState(false);
        const onBAChange = (e) => {
          const { name, value } = e.target;
          if (name === 'bankaccountname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setBaForm({ ...baForm, [name]: sanitized });
          } else if (name === 'bankname') {
            setBaForm({ ...baForm, [name]: (value || '').toLowerCase() });
          }
        };
        const onBASubmit = async (e) => {
          e.preventDefault(); setSavingBA(true); setError('');
          try {
            if (!baForm.bankaccountname || !baForm.bankname) throw new Error('bankaccountname and bankname are required');
            const created = await api.addBankaccount(baForm);
            setBankaccounts([ ...bankaccounts, created ]);
            setBaForm(emptyBA);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingBA(false); }
        };
        const onBADelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBankaccount(name); setBankaccounts(bankaccounts.filter(x => x.bankaccountname !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        // Group form
        const emptyGroup = { groupname: '', propertylist: '' };
        const [groupForm, setGroupForm] = useState(emptyGroup);
        const [savingGroup, setSavingGroup] = useState(false);
        const onGroupChange = (e) => {
          const { name, value } = e.target;
          if (name === 'groupname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setGroupForm({ ...groupForm, [name]: sanitized });
          } else {
            setGroupForm({ ...groupForm, [name]: value });
          }
        };
        const onGroupSubmit = async (e) => {
          e.preventDefault(); setSavingGroup(true); setError('');
          try {
            const payload = { groupname: groupForm.groupname, propertylist: (groupForm.propertylist || '').split('|').map(s=>s.trim().toLowerCase()).filter(Boolean) };
            if (!payload.groupname) throw new Error('groupname is required');
            const created = await api.addGroup(payload);
            setGroups([ ...groups, created ]);
            setGroupForm(emptyGroup);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingGroup(false); }
        };
        const onGroupDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeGroup(name); setGroups(groups.filter(x => x.groupname !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        // Owner form
        const emptyOwner = { name: '', bankaccounts: [], properties: [], companies: [] };
        const [ownerForm, setOwnerForm] = useState(emptyOwner);
        const [savingOwner, setSavingOwner] = useState(false);
        const onOwnerChange = (e) => {
          const { name, value } = e.target;
          if (name === 'name') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setOwnerForm({ ...ownerForm, [name]: sanitized });
          } else if (e.target.multiple) {
            const selected = Array.from(e.target.selectedOptions).map(o => (o.value || '').toLowerCase());
            setOwnerForm({ ...ownerForm, [name]: selected });
          } else {
            setOwnerForm({ ...ownerForm, [name]: value });
          }
        };
        const onOwnerSubmit = async (e) => {
          e.preventDefault(); setSavingOwner(true); setError('');
          try {
            if (!ownerForm.name) throw new Error('name is required');
            const payload = {
              name: ownerForm.name,
              bankaccounts: Array.from(new Set((ownerForm.bankaccounts || []).map(s => (s || '').toLowerCase()))),
              properties: Array.from(new Set((ownerForm.properties || []).map(s => (s || '').toLowerCase()))),
              companies: Array.from(new Set((ownerForm.companies || []).map(s => (s || '').toLowerCase()))),
            };
            const created = await api.addOwner(payload);
            setOwners([ ...owners, created ]);
            setOwnerForm(emptyOwner);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingOwner(false); }
        };
        const onOwnerDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeOwner(name); setOwners(owners.filter(x => x.name !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        const TabButton = ({ active, onClick, children }) => (
          <button type="button" onClick={onClick} className={`tab ${active ? 'active' : ''}`}>{children}</button>
        );

        return (
          <div className="container">
            <h1>AccountSpy</h1>

            <div className="tabs">
              <TabButton active={topTab==='setup'} onClick={() => setTopTab('setup')}>Setup</TabButton>
              <TabButton active={topTab==='classifyrules'} onClick={() => setTopTab('classifyrules')}>ClassifyRules</TabButton>
              <TabButton active={topTab==='transactions'} onClick={() => setTopTab('transactions')}>Transactions</TabButton>
              <TabButton active={topTab==='report'} onClick={() => setTopTab('report')}>Report</TabButton>
            </div>

            {topTab === 'setup' && (
              <div className="tabcontent">
                <div className="actions" style={{ marginBottom: 12, flexWrap: 'wrap' }}>
                  <TabButton active={setupTab==='banks'} onClick={() => setSetupTab('banks')}>Banks</TabButton>
                  <TabButton active={setupTab==='bankaccounts'} onClick={() => setSetupTab('bankaccounts')}>Bank Accounts</TabButton>
                  <TabButton active={setupTab==='companies'} onClick={() => setSetupTab('companies')}>Company Records</TabButton>
                  <TabButton active={setupTab==='properties'} onClick={() => setSetupTab('properties')}>Properties</TabButton>
                  <TabButton active={setupTab==='groups'} onClick={() => setSetupTab('groups')}>Groups</TabButton>
                  <TabButton active={setupTab==='owners'} onClick={() => setSetupTab('owners')}>Owners</TabButton>
                  <TabButton active={setupTab==='taxcats'} onClick={() => setSetupTab('taxcats')}>Tax Categories</TabButton>
                  <TabButton active={setupTab==='txtypes'} onClick={() => setSetupTab('txtypes')}>Transaction Types</TabButton>
                </div>

                {setupTab === 'properties' && (
                  <PropertiesPanelExt items={items} companies={companies} loading={loading} reload={load} />
                )}

                {setupTab === 'companies' && (
                  <CompaniesPanelExt companyRecords={companyRecords} loading={loading} reload={load} />
                )}

                {setupTab === 'banks' && (
                  <BanksPanelExt banks={banks} loading={loading} reload={load} />
                )}

                {setupTab === 'taxcats' && (
                  <TaxCategoriesPanelExt taxCategories={taxCategories} loading={loading} reload={load} />
                )}

                {setupTab === 'txtypes' && (
                  <TransactionTypesPanelExt transactionTypes={transactionTypes} loading={loading} reload={load} />
                )}

                {setupTab === 'bankaccounts' && (
                  <BankAccountsPanelExt bankaccounts={bankaccounts} loading={loading} reload={load} banks={banks} />
                )}

                {setupTab === 'groups' && (
                  <GroupsPanelExt groups={groups} loading={loading} reload={load} items={items} />
                )}

                {setupTab === 'owners' && (
                  <OwnersPanelExt owners={owners} loading={loading} reload={load} bankaccounts={bankaccounts} items={items} companies={companies} />
                )}
              </div>
            )}

            {topTab === 'classifyrules' && (
              <div className="tabcontent">
                <ClassifyRulesTabs
                  classifyRules={classifyRules}
                  loading={loading}
                  load={load}
                  bankaccounts={bankaccounts}
                  items={items}
                  taxCategories={taxCategories}
                  transactionTypes={transactionTypes}
                />
              </div>
            )}

            {topTab === 'transactions' && (
              <div className="tabcontent"><div className="muted">Transactions UI coming soon.</div></div>
            )}

            {topTab === 'report' && (
              <div className="tabcontent"><div className="muted">Report UI coming soon.</div></div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
