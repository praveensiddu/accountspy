<!doctype html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/index.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Properties</title>
    <link rel="preconnect" href="https://unpkg.com" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #f7f7f8; }
      .container { max-width: 960px; margin: 0 auto; }
      h1 { margin-top: 0; }
      table { width: 100%; border-collapse: collapse; background: #fff; }
      th, td { padding: 8px 10px; border: 1px solid #e5e7eb; font-size: 14px; }
      th { background: #f3f4f6; text-align: left; }
      .card { background: #fff; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 16px; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; }
      .row .col { flex: 1 1 200px; min-width: 200px; }
      input, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
      button { padding: 10px 14px; border: 0; background: #111827; color: #fff; border-radius: 6px; cursor: pointer; }
      button:disabled { background: #6b7280; cursor: not-allowed; }
      .actions { display: flex; gap: 8px; }
      .muted { color: #6b7280; font-size: 13px; }
      .error { color: #b91c1c; }
      /* Tabbed pane styles */
      .tabs { display: flex; gap: 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 0; }
      .tab { appearance: none; background: transparent; border: 0; border-bottom: 2px solid transparent; color: #6b7280; padding: 10px 14px; margin: 0; cursor: pointer; border-top-left-radius: 8px; border-top-right-radius: 8px; }
      .tab:hover { color: #111827; }
      .tab.active { color: #111827; border-bottom-color: #111827; font-weight: 600; }
      .tabcontent { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: -1px; }
      /* Link style */
      a.link { color: #2563eb; text-decoration: underline; cursor: pointer; }
      a.link:hover { color: #1d4ed8; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="text/babel" src="/components/Modal.jsx"></script>
    <script type="text/babel" src="/components/Confirm.jsx"></script>
    <script type="text/babel" src="/components/MultiSelect.jsx"></script>
    <script type="text/babel" src="/components/ClassifyRulesPanel.jsx"></script>
    <!-- External Panels loaded via Babel -->
    <script type="text/babel" src="/components/PropertiesPanel.jsx"></script>
    <script type="text/babel" src="/components/CompaniesPanel.jsx"></script>
    <script type="text/babel" src="/components/BankAccountsPanel.jsx"></script>
    <script type="text/babel" src="/components/GroupsPanel.jsx"></script>
    <script type="text/babel" src="/components/OwnersPanel.jsx"></script>
    <script type="text/babel" src="/components/BanksPanel.jsx"></script>
    <script type="text/babel" src="/components/TaxCategoriesPanel.jsx"></script>
    <script type="text/babel" src="/components/TransactionTypesPanel.jsx"></script>

    <script type="text/babel">
      const { useEffect, useState } = React;

      function BankRulesTabs({ bankaccounts, items, taxCategories, transactionTypes, groups }) {
        const [banks, setBanks] = useState([]);
        const [active, setActive] = useState(() => {
          try { return window.localStorage.getItem('bankrules_active') || ''; } catch(_) { return ''; }
        });
        const [rules, setRules] = useState([]);
        const [rulesReady, setRulesReady] = useState(false);
        const [loading, setLoading] = useState(false);
        const [filter, setFilter] = useState(() => {
          try {
            const order = window.localStorage.getItem('bankrules_filter_order') || '';
            return { order, transaction_type:'', pattern_match_logic:'', tax_category:'', property:'', group:'', company:'', otherentity:'' };
          } catch(_) { return { order:'', transaction_type:'', pattern_match_logic:'', tax_category:'', property:'', group:'', company:'', otherentity:'' }; }
        });
        // Local groups data sourced from Groups table
        const [bankGroupsData, setBankGroupsData] = useState(groups || []);
        useEffect(() => { setBankGroupsData(groups || []); }, [groups]);
        // Companies for dropdown
        const [companiesData, setCompaniesData] = useState([]);
        useEffect(() => {
          (async () => {
            try {
              const res = await fetch('/api/company-records');
              if (res.ok) {
                const data = await res.json();
                if (Array.isArray(data)) setCompaniesData(data);
              }
            } catch (_) {}
          })();
        }, []);
        useEffect(() => {
          if (!bankGroupsData || bankGroupsData.length === 0) {
            (async () => {
              try {
                const res = await fetch('/api/groups');
                if (res.ok) {
                  const data = await res.json();
                  if (Array.isArray(data)) setBankGroupsData(data);
                }
              } catch (_) {}
            })();
          }
        }, []);
        const Modal = window.Modal;
        const confirmAsync = async (message) => {
          try { if (typeof window.showConfirm === 'function') return await window.showConfirm(message); } catch (_) {}
          return window.confirm(message);
        };
        const emptyForm = { bankaccountname:'', order: 10000, transaction_type:'', match:'desc_contains', description:'', credit:'', tax_category:'', property:'', group:'', company:'', otherentity:'' };
        const [open, setOpen] = useState(false);
        const [mode, setMode] = useState('add');
        const [saving, setSaving] = useState(false);
        const [original, setOriginal] = useState(null);
        const [form, setForm] = useState(emptyForm);
        const onChange = (e) => {
          const { name, value } = e.target; const v = (value||'').toString();
          if (name === 'order') {
            const n = Number(v);
            const clamped = (Number.isFinite(n) && n >= 1) ? n : 1;
            setForm(prev => ({ ...prev, order: clamped }));
            return;
          }
          if (name === 'match') { setForm(prev => ({ ...prev, match: v })); return; }
          if (['bankaccountname','transaction_type','tax_category','property','group','company'].includes(name)) setForm(prev => ({...prev, [name]: v.toLowerCase()}));
          else setForm(prev => ({...prev, [name]: v}));
        };

        const loadBanks = React.useCallback(async () => {
          try {
            const res = await fetch('/api/bank-rules/banks');
            if (!res.ok) throw new Error('Failed to fetch bank list');
            const data = await res.json();
            const all = Array.isArray(data) ? data : [];
            const allowed = new Set((bankaccounts||[]).map(b => (b.bankaccountname||'').toLowerCase()));
            const filtered = all.filter(name => allowed.has((name||'').toLowerCase()));
            setBanks(filtered);
            if (filtered.length > 0) setActive(prev => prev && filtered.includes(prev) ? prev : filtered[0]);
          } catch (_) {
            setBanks([]);
          }
        }, [bankaccounts]);

        const loadRules = React.useCallback(async (bank) => {
          if (!bank) { setRules([]); return; }
          try {
            const qs = new URLSearchParams({ bankaccountname: bank });
            const res = await fetch(`/api/bank-rules?${qs}`);
            if (!res.ok) throw new Error('Failed to fetch bank rules');
            const data = await res.json();
            setRules(Array.isArray(data) ? data : []);
            setRulesReady(true);
          } catch (_) {
            setRules([]);
            setRulesReady(true);
          } finally { setLoading(false); }
        }, []);

        useEffect(() => { loadBanks(); }, [loadBanks]);
        useEffect(() => {
          try { window.localStorage.setItem('bankrules_active', active || ''); } catch(_) {}
        }, [active]);
        useEffect(() => {
          try { window.localStorage.setItem('bankrules_filter_order', filter.order || ''); } catch(_) {}
        }, [filter.order]);
        useEffect(() => { loadRules(active); }, [active, loadRules]);

        // Handle external prefill from Transactions: open Add/Edit modal with pattern, credit and order, and row attributes
        useEffect(() => {
          let consumed = false;
          const run = async () => {
            try {
              const shouldOpen = window.localStorage.getItem('bankrules_prefill_open') === '1';
              const patt = window.localStorage.getItem('bankrules_prefill_pattern') || '';
              const orderPref = window.localStorage.getItem('bankrules_prefill_order') || '';
              const creditPref = window.localStorage.getItem('bankrules_prefill_credit') || '';
              const ttypePref = (window.localStorage.getItem('bankrules_prefill_ttype') || '').toLowerCase();
              const taxPref = (window.localStorage.getItem('bankrules_prefill_tax') || '').toLowerCase();
              const propPref = (window.localStorage.getItem('bankrules_prefill_property') || '').toLowerCase();
              const groupPref = (window.localStorage.getItem('bankrules_prefill_group') || '').toLowerCase();
              const companyPref = (window.localStorage.getItem('bankrules_prefill_company') || '').toLowerCase();
              const otherPref = (window.localStorage.getItem('bankrules_prefill_otherentity') || '');
              const forceAdd = window.localStorage.getItem('bankrules_prefill_force_add') === '1';
              if (!shouldOpen) return;
              if (!active) return;
              if (!rulesReady) return; // wait until rules loaded to compute nextOrder accurately
              // compute next order similar to handleAdd (max valid > 0 + 1)
              const fallbackMax = (rules || []).reduce((m, r) => {
                const o = Number(r && r.order);
                return (Number.isFinite(o) && o > 0) ? Math.max(m, o) : m;
              }, 0);
              let nextOrder = fallbackMax + 1;
              // Prefer server-computed max order
              try {
                const qsMO = new URLSearchParams({ bankaccountname: (active||'').toLowerCase() });
                const resMO = await fetch(`/api/bank-rules/max-order?${qsMO}`);
                if (resMO.ok) {
                  const dataMO = await resMO.json();
                  const mo = Number(dataMO && dataMO.max_order);
                  if (Number.isFinite(mo) && mo >= 0) nextOrder = mo + 1;
                }
              } catch(_) { /* ignore and use fallback */ }
              const parsedOrder = (() => { const n = Number((orderPref||'').trim()); return isNaN(n) ? null : n; })();
              let existing = null;
              if (!forceAdd && parsedOrder != null) {
                existing = (rules || []).find(r => Number(r.order||0) === parsedOrder);
              }
              // Parse patt into match + description/credit
              let match = 'desc_contains', description = '', credit = '';
              try {
                const m1 = patt.match(/^(desc_startswith|desc_contains)\s*=\s*(.*)$/i);
                const m2 = patt.match(/^credit_equals\s*=\s*([-+]?[0-9]*\.?[0-9]+)$/i);
                if (m1) { match = (m1[1]||'').toLowerCase(); description = m1[2] || ''; }
                else if (m2) { match = 'credit_equals'; credit = m2[1] || ''; }
              } catch(_) {}
              if (!credit && creditPref) { credit = creditPref; }
              if (existing) {
                setMode('edit');
                setOriginal(existing);
                const exo = Number(existing.order);
                const finalOrder = (Number.isFinite(exo) && exo > 0)
                  ? exo
                  : ((Number.isFinite(parsedOrder) && parsedOrder > 0) ? parsedOrder : Math.max(1, Number(nextOrder)||1));
                setForm({
                  bankaccountname: (active||'').toLowerCase(),
                  order: finalOrder,
                  transaction_type: ttypePref || (existing.transaction_type||'').toLowerCase(),
                  match, description, credit,
                  tax_category: taxPref || (existing.tax_category||'').toLowerCase(),
                  property: propPref || (existing.property||'').toLowerCase(),
                  group: groupPref || (existing.group||'').toLowerCase(),
                  company: companyPref || (existing.company||'').toLowerCase(),
                  otherentity: otherPref || (existing.otherentity||'')
                });
              } else {
                setMode('add');
                setOriginal(null);
                const finalOrder = (Number.isFinite(parsedOrder) && parsedOrder > 0) ? parsedOrder : Math.max(1, Number(nextOrder)||1);
                setForm({
                  bankaccountname: (active||'').toLowerCase(),
                  order: finalOrder,
                  transaction_type: ttypePref || '',
                  match, description, credit,
                  tax_category: taxPref || '',
                  property: propPref || '',
                  group: groupPref || '',
                  company: companyPref || '',
                  otherentity: otherPref || ''
                });
              }
              setOpen(true);
              consumed = true;
            } catch (_) { /* ignore */ }
            finally {
              if (consumed) {
                try {
                  window.localStorage.removeItem('bankrules_prefill_open');
                  window.localStorage.removeItem('bankrules_prefill_pattern');
                  window.localStorage.removeItem('bankrules_prefill_order');
                  window.localStorage.removeItem('bankrules_prefill_credit');
                  window.localStorage.removeItem('bankrules_prefill_ttype');
                  window.localStorage.removeItem('bankrules_prefill_tax');
                  window.localStorage.removeItem('bankrules_prefill_property');
                  window.localStorage.removeItem('bankrules_prefill_group');
                  window.localStorage.removeItem('bankrules_prefill_company');
                  window.localStorage.removeItem('bankrules_prefill_otherentity');
                  window.localStorage.removeItem('bankrules_prefill_force_add');
                  // ensure we are on Bank subtab
                  window.localStorage.setItem('crSubTab','bank');
                } catch (_) {}
              }
            }
          };
          run();
        }, [active, rules, rulesReady]);

        const handleAdd = async (row) => {
          setMode('add'); setOriginal(null);
          // Fallback: compute from currently loaded rules
          const fallbackMax = (rules || []).reduce((m, r) => {
            const o = Number(r && r.order);
            return (Number.isFinite(o) && o > 0) ? Math.max(m, o) : m;
          }, 0);
          let nextOrder = fallbackMax + 1;
          // Prefer server-computed max order
          try {
            const qs = new URLSearchParams({ bankaccountname: (active||'').toLowerCase() });
            const res = await fetch(`/api/bank-rules/max-order?${qs}`);
            if (res.ok) {
              const data = await res.json();
              const mo = Number(data && data.max_order);
              if (Number.isFinite(mo) && mo >= 0) nextOrder = mo + 1;
            }
          } catch (_) { /* ignore and use fallback */ }
          const finalOrder = Math.max(1, Number(nextOrder)||1);
          setForm({ ...emptyForm, bankaccountname: (active||'').toLowerCase(), order: finalOrder, match: 'desc_contains', description: '', credit: '' });
          setOpen(true);
        };
        const handleEdit = (r) => {
          setMode('edit'); setOriginal(r);
          // Parse existing pattern_match_logic into match + description/credit
          const p = (r.pattern_match_logic || '').toString();
          let match = 'desc_contains', description = '', credit = '';
          const m1 = p.match(/^(desc_startswith|desc_contains)\s*=\s*(.*)$/i);
          const m2 = p.match(/^credit_equals\s*=\s*([-+]?[0-9]*\.?[0-9]+)$/i);
          if (m1) { match = m1[1].toLowerCase(); description = m1[2] || ''; }
          else if (m2) { match = 'credit_equals'; credit = m2[1] || ''; }
          setForm({
            bankaccountname: (r.bankaccountname||'').toLowerCase(),
            order: Number(r.order || 10000),
            transaction_type: (r.transaction_type||'').toLowerCase(),
            match, description, credit,
            tax_category: (r.tax_category||'').toLowerCase(),
            property: (r.property||'').toLowerCase(),
            group: (r.group||'').toLowerCase(),
            company: (r.company||'').toLowerCase(),
            otherentity: r.otherentity||''
          });
          setOpen(true);
        };
        const onSubmit = async (e) => {
          e.preventDefault();
          if (!form.bankaccountname || !form.transaction_type || !form.match) return;
          try {
            setSaving(true);
            // Compose pattern_match_logic from UI
            let pattern_match_logic = '';
            if (form.match === 'credit_equals') {
              pattern_match_logic = `credit_equals=${(form.credit||'').toString().trim()}`;
            } else {
              const desc = (form.description||'').toString().trim();
              pattern_match_logic = `${form.match}=${desc}`;
            }
            const payload = {
              bankaccountname: (form.bankaccountname||'').trim().toLowerCase(),
              order: Number(form.order || 10000),
              transaction_type: (form.transaction_type||'').trim().toLowerCase(),
              pattern_match_logic,
              tax_category: (form.tax_category||'').trim().toLowerCase(),
              property: (form.property||'').trim().toLowerCase(),
              group: (form.group||'').trim().toLowerCase(),
              company: (form.company||'').trim().toLowerCase(),
              otherentity: (form.otherentity||'').trim(),
            };
            const res = await fetch('/api/bank-rules', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error('Failed to save bank rule');
            if (mode === 'edit' && original) {
              // If key changed, delete old
              if (
                (original.bankaccountname||'').toLowerCase() !== payload.bankaccountname ||
                (original.transaction_type||'').toLowerCase() !== payload.transaction_type ||
                (original.pattern_match_logic||'') !== payload.pattern_match_logic ||
                (original.property||'').toLowerCase() !== payload.property ||
                (original.group||'').toLowerCase() !== payload.group ||
                (original.company||'').toLowerCase() !== payload.company ||
                (original.tax_category||'').toLowerCase() !== payload.tax_category ||
                (original.otherentity||'') !== payload.otherentity
              ) {
                const params = {
                  bankaccountname: original.bankaccountname||'',
                  transaction_type: original.transaction_type||'',
                  pattern_match_logic: original.pattern_match_logic||'',
                  property: original.property||'',
                  group: original.group||'',
                  company: original.company||'',
                  tax_category: original.tax_category||'',
                  otherentity: original.otherentity||''
                };
                const qs = new URLSearchParams(params).toString();
                await fetch(`/api/bank-rules?${qs}`, { method: 'DELETE' });
              }
            }
            setOpen(false);
            await loadRules(active);
            try { if (typeof window.requestTransactionsReload === 'function') await window.requestTransactionsReload(); } catch (_) {}
            try { setTopTab('transactions'); } catch(_) {}
          } catch (err) {
            console.error(err);
          } finally { setSaving(false); }
        };
        const handleDelete = async (r) => {
          if (!(await confirmAsync('Delete rule?'))) return;
          const params = {
            bankaccountname: r.bankaccountname||'',
            transaction_type: r.transaction_type||'',
            pattern_match_logic: r.pattern_match_logic||'',
            property: r.property||'',
            group: r.group||'',
            tax_category: r.tax_category||'',
            otherentity: r.otherentity||''
          };
          const qs = new URLSearchParams(params).toString();
          try {
            setLoading(true);
            const res = await fetch(`/api/bank-rules?${qs}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete bank rule');
            await loadRules(active);
            try { if (typeof window.requestTransactionsReload === 'function') await window.requestTransactionsReload(); } catch (_) {}
          } catch (e) { console.error(e); } finally { setLoading(false); }
        };

        return (
          <div className="card" style={{ marginBottom: 16 }}>
            <div className="tabs" style={{ flexWrap: 'wrap', rowGap: 6 }}>
              {(banks||[]).map(b => (
                <button
                  key={b}
                  className={`tab ${active===b ? 'active' : ''}`}
                  onClick={()=> setActive(b)}
                  style={{ whiteSpace: 'normal', wordBreak: 'break-word', textAlign: 'left' }}
                >
                  {b}
                </button>
              ))}
            </div>
            {!active && (<div className="muted">No bank rule files found</div>)}
            {active && (
              <div className="tabcontent">
                <div className="actions" style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                  <div className="muted">BankRules: {active}</div>
                  <div>
                    <span className="mr-3 text-gray-600">Total: {(rules||[]).length}</span>
                    <button type="button" onClick={handleAdd} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Rule</button>
                    <button type="button" onClick={()=> loadRules(active)} disabled={loading} className="ml-2 px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:opacity-60">Refresh</button>
                  </div>
                </div>
                <Modal title={mode==='edit' ? 'Edit Bank Rule' : 'Add Bank Rule'} open={open} onClose={()=> { setOpen(false); setMode('add'); setOriginal(null); }} onSubmit={onSubmit} submitLabel={saving ? 'Saving...' : 'Save'} submitDisabled={
                  !((form.bankaccountname||'').trim())
                  || !((form.transaction_type||'').trim())
                  || !((form.tax_category||'').trim())
                  || !((form.match||'').trim())
                  || ((form.match!=='credit_equals') && !(form.description||'').trim())
                  || ((form.match==='credit_equals') && !(form.credit||'').toString().trim())
                  || (((form.tax_category||'').toLowerCase().trim() === 'personal') && (
                        ((form.property||'').trim()) || ((form.group||'').trim()) || ((form.company||'').trim())
                     ))
                  || (((form.tax_category||'').trim().toLowerCase()==='rental') && (
                        (((form.property||'').trim() && (form.group||'').trim())) ||
                        (!((form.property||'').trim()) && !((form.group||'').trim()))
                     ))
                  || (((form.tax_category||'').trim().toLowerCase()==='company') && (
                        !((form.company||'').trim()) ||
                        ((form.property||'').trim()) ||
                        ((form.group||'').trim())
                     ))
                }>
                  <form onSubmit={onSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">bankaccountname</label>
                      <input name="bankaccountname" value={form.bankaccountname} onChange={onChange} readOnly className="mt-1 w-full border border-gray-300 rounded-md p-2 bg-gray-100" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">{mode==='edit' ? 'order' : 'insert as order'}</label>
                      <input
                        name="order"
                        type="number"
                        value={form.order}
                        onChange={onChange}
                        readOnly={mode==='edit'}
                        className={`mt-1 w-full border rounded-md p-2 shadow-sm ${mode==='edit' ? 'bg-gray-100 border-gray-300 text-gray-600 cursor-not-allowed' : 'border-gray-300 focus:ring-blue-500 focus:border-blue-500'}`}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">match</label>
                      <select name="match" value={form.match} onChange={onChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="desc_startswith">desc_startswith</option>
                        <option value="desc_contains">desc_contains</option>
                        <option value="credit_equals">credit_equals</option>
                      </select>
                    </div>
                    {form.match !== 'credit_equals' && (
                      <div className="md:col-span-1">
                        <label className="block text-sm font-medium text-gray-700">description</label>
                        <input name="description" value={form.description} onChange={onChange} placeholder="text" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                      </div>
                    )}
                    {form.match === 'credit_equals' && (
                      <div className="md:col-span-1">
                        <label className="block text-sm font-medium text-gray-700">credit</label>
                        <input name="credit" value={form.credit} onChange={onChange} placeholder="e.g., 100.00" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                      </div>
                    )}
                    <div>
                      <label className="block text-sm font-medium text-gray-700">transaction_type</label>
                      <input
                        name="transaction_type"
                        value={form.transaction_type}
                        onChange={onChange}
                        list="transaction-types-list"
                        placeholder="type to filter..."
                        className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                        required
                      />
                      <datalist id="transaction-types-list">
                        {(transactionTypes || []).map(t => (
                          <option key={t.transactiontype} value={(t.transactiontype || '').toLowerCase()}>{t.transactiontype}</option>
                        ))}
                      </datalist>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">tax_category</label>
                      <select name="tax_category" value={form.tax_category} onChange={onChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select tax category</option>
                        {(taxCategories || []).map(c => (
                          <option key={c.category} value={(c.category || '').toLowerCase()}>{c.category}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">property</label>
                      <input
                        name="property"
                        value={form.property}
                        onChange={onChange}
                        list="properties-list"
                        placeholder="type to filter..."
                        className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                      />
                      <datalist id="properties-list">
                        {(items || []).map(p => (
                          <option key={p.property} value={(p.property || '').toLowerCase()}>{p.property}</option>
                        ))}
                      </datalist>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">group</label>
                      <select name="group" value={form.group} onChange={onChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select group (optional)</option>
                        {(bankGroupsData || []).map(g => (
                          <option key={g.groupname} value={(g.groupname || '').toLowerCase()}>{g.groupname}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">company</label>
                      <select name="company" value={form.company} onChange={onChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select company (optional)</option>
                        {(companiesData || []).map(c => (
                          <option key={c.companyname} value={(c.companyname || '').toLowerCase()}>{c.companyname}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">otherentity</label>
                      <input name="otherentity" value={form.otherentity} onChange={onChange} placeholder="optional" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                  </form>
                </Modal>
                {loading ? (<div>Loading...</div>) : (
                  <div className="overflow-x-auto">
                  <table className="min-w-full" style={{ tableLayout: 'fixed' }}>
                    <thead>
                      <tr>
                        <th>order</th>
                        <th>transaction_type</th>
                        <th>pattern_match_logic</th>
                        <th>tax_category</th>
                        <th>property</th>
                        <th>group</th>
                        <th>company</th>
                        <th>otherentity</th>
                        <th>actions</th>
                      </tr>
                      <tr>
                        <th><input placeholder="filter" value={filter.order} onChange={(e)=> setFilter(f => ({...f, order: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={filter.transaction_type} onChange={(e)=> setFilter(f => ({...f, transaction_type: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={filter.pattern_match_logic} onChange={(e)=> setFilter(f => ({...f, pattern_match_logic: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={filter.tax_category} onChange={(e)=> setFilter(f => ({...f, tax_category: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={filter.property} onChange={(e)=> setFilter(f => ({...f, property: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={filter.group} onChange={(e)=> setFilter(f => ({...f, group: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={filter.company} onChange={(e)=> setFilter(f => ({...f, company: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={filter.otherentity} onChange={(e)=> setFilter(f => ({...f, otherentity: e.target.value}))} /></th>
                      </tr>
                    </thead>
                    <tbody>
                       {(rules||[])
                         .slice()
                        .sort((a,b)=> {
                          const ao = Number(a.order||10000);
                          const bo = Number(b.order||10000);
                          if (ao !== bo) return ao - bo;
                          const at = (a.transaction_type||'').toLowerCase();
                          const bt = (b.transaction_type||'').toLowerCase();
                          if (at < bt) return -1; if (at > bt) return 1; return 0;
                        })
                        .filter(r => (
                          (filter.order ? String(r.order||'').toLowerCase().includes(String(filter.order).toLowerCase()) : true) &&
                          (filter.transaction_type ? (((r.transaction_type||'').trim() ? (r.transaction_type||'') : 'empty').toLowerCase().includes(filter.transaction_type.toLowerCase())) : true) &&
                          (filter.pattern_match_logic ? (r.pattern_match_logic||'').toLowerCase().includes(filter.pattern_match_logic.toLowerCase()) : true) &&
                          (filter.tax_category ? (r.tax_category||'').toLowerCase().includes(filter.tax_category.toLowerCase()) : true) &&
                          (filter.property ? (r.property||'').toLowerCase().includes(filter.property.toLowerCase()) : true) &&
                          (filter.group ? (r.group||'').toLowerCase().includes(filter.group.toLowerCase()) : true) &&
                          (filter.company ? (r.company||'').toLowerCase().includes(filter.company.toLowerCase()) : true) &&
                          (filter.otherentity ? (r.otherentity||'').toLowerCase().includes(filter.otherentity.toLowerCase()) : true)
                        ))
                        .map((r, idx) => (
                          <tr key={`bankrules-${active}-${idx}`}>
                            <td className="break-words whitespace-pre-wrap">{r.order || 10000}</td>
                            <td className="break-words whitespace-pre-wrap">{r.transaction_type}</td>
                            <td className="break-words whitespace-pre-wrap">{r.pattern_match_logic}</td>
                            <td className="break-words whitespace-pre-wrap">{r.tax_category}</td>
                            <td className="break-words whitespace-pre-wrap">{r.property}</td>
                            <td className="break-words whitespace-pre-wrap">{r.group}</td>
                            <td className="break-words whitespace-pre-wrap">{r.company}</td>
                            <td className="break-words whitespace-pre-wrap">{r.otherentity}</td>
                            <td>
                              <button onClick={()=> handleEdit(r)} className="px-2 py-1 mr-2 bg-gray-700 text-white rounded hover:bg-gray-800">Edit</button>
                              <button onClick={()=> handleDelete(r)} className="px-2 py-1 mr-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
                              <button onClick={async()=>{
                                try {
                                  const bank = (active||'').toLowerCase();
                                  const cur = Number(r.order||0);
                                  if (!bank || !Number.isFinite(cur) || cur < 1) return;
                                  const input = window.prompt('Enter updated order (1..max):', String(cur));
                                  if (input == null) return;
                                  const upd = Number(input);
                                  if (!Number.isFinite(upd)) { alert('updatedorder must be an integer'); return; }
                                  // fetch max-order for this bank
                                  let maxOrder = 0;
                                  try {
                                    const qsMO = new URLSearchParams({ bankaccountname: bank });
                                    const resMO = await fetch(`/api/bank-rules/max-order?${qsMO}`);
                                    if (resMO.ok) {
                                      const dataMO = await resMO.json();
                                      const mo = Number(dataMO && dataMO.max_order);
                                      if (Number.isFinite(mo) && mo >= 0) maxOrder = mo;
                                    }
                                  } catch(_) {}
                                  if (!(upd >= 1 && upd <= maxOrder)) { alert(`updatedorder must be between 1 and ${maxOrder}`); return; }
                                  const qs = new URLSearchParams({ bankaccountname: bank });
                                  const res = await fetch(`/api/bank-rules/update-order?${qs}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentorder: cur, updatedorder: upd }) });
                                  if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'Failed to update order'); }
                                  await loadRules(active);
                                  try { if (typeof window.requestTransactionsReload === 'function') await window.requestTransactionsReload(); } catch (_) {}
                                } catch (e) { console.error(e); alert(e.message || 'Failed to update order'); }
                              }} className="px-2 py-1 bg-amber-600 text-white rounded hover:bg-amber-700">updateorder</button>
                            </td>
                          </tr>
                        ))}
                      {(rules||[]).length === 0 && (
                        <tr><td colSpan="8" className="muted">No rules</td></tr>
                      )}
                    </tbody>
                  </table>
                  </div>
                )}
              </div>
            )}
          </div>
        );
      }

      // Subtabs component for Classify Rules
      function ClassifyRulesTabs({ classifyRules, loading, load, bankaccounts, items, taxCategories, transactionTypes, groups }) {
        const [crSubTab, setCrSubTab] = useState(() => {
          try {
            const v = window.localStorage.getItem('crSubTab');
            return v || 'bank';
          } catch (_) { return 'bank'; }
        });
        // Local fallback for groups specifically for modals in this tab
        const [inheritGroupsData, setInheritGroupsData] = useState(groups || []);
        useEffect(() => { setInheritGroupsData(groups || []); }, [groups]);
        useEffect(() => {
          if (!groups || groups.length === 0) {
            try {
              const fn = (window.api && window.api.listGroups) ? window.api.listGroups : null;
              if (typeof fn === 'function') {
                fn().then(gs => { if (Array.isArray(gs)) setInheritGroupsData(gs); }).catch(()=>{});
              }
            } catch (_) {}
          }
        }, []);
        const [commonFilter, setCommonFilter] = useState({ transaction_type: '', pattern_match_logic: '' });
        const [inheritFilter, setInheritFilter] = useState({ bankaccountname: '', tax_category: '', property: '', group: '', otherentity: '' });
        const [commonRules, setCommonRules] = useState([]);
        const [inheritRules, setInheritRules] = useState([]);
        const [subLoading, setSubLoading] = useState(false);

        const fetchCommon = React.useCallback(async () => {
          try {
            setSubLoading(true);
            const res = await fetch('/api/common-rules');
            if (!res.ok) throw new Error('Failed to fetch common rules');
            const data = await res.json();
            setCommonRules(Array.isArray(data) ? data : []);
          } catch (e) {
            console.error(e);
            setCommonRules([]);
          } finally { setSubLoading(false); }
        }, []);

        const fetchInherit = React.useCallback(async () => {
          try {
            setSubLoading(true);
            const res = await fetch('/api/inherit-common-to-bank');
            if (!res.ok) throw new Error('Failed to fetch inherit rules');
            const data = await res.json();
            setInheritRules(Array.isArray(data) ? data : []);
          } catch (e) {
            console.error(e);
            setInheritRules([]);
          } finally { setSubLoading(false); }
        }, []);

        React.useEffect(() => {
          if (crSubTab === 'common') fetchCommon();
          if (crSubTab === 'inherit') fetchInherit();
        }, [crSubTab, fetchCommon, fetchInherit]);

        // Persist selected subtab for stickiness across refresh/hard refresh
        React.useEffect(() => {
          try { window.localStorage.setItem('crSubTab', crSubTab); } catch (_) {}
        }, [crSubTab]);

        // CommonRules CRUD (Modal based)
        const Modal = window.Modal;
        const confirmAsync = async (message) => {
          try {
            if (typeof window.showConfirm === 'function') {
              return await window.showConfirm(message);
            }
          } catch (e) { /* ignore and fallback */ }
          return window.confirm(message);
        };
        const [commonOpen, setCommonOpen] = useState(false);
        const [commonMode, setCommonMode] = useState('add');
        const [commonForm, setCommonForm] = useState({ transaction_type: '', pattern_match_logic: '' });
        const [commonSaving, setCommonSaving] = useState(false);
        const [commonOriginal, setCommonOriginal] = useState(null);
        const onCommonChange = (e) => {
          const { name, value } = e.target;
          const v = (value || '').toString();
          setCommonForm(prev => ({ ...prev, [name]: name === 'transaction_type' ? v.toLowerCase() : v }));
        };
        const handleAddCommon = () => {
          setCommonForm({ transaction_type: '', pattern_match_logic: '' });
          setCommonMode('add');
          setCommonOriginal(null);
          setCommonOpen(true);
        };
        const handleDeleteCommon = async (r) => {
          const qs = new URLSearchParams({ transaction_type: r.transaction_type || '', pattern_match_logic: r.pattern_match_logic || '' }).toString();
          if (!(await confirmAsync('Delete common rule?'))) return;
          try {
            setSubLoading(true);
            const res = await fetch(`/api/common-rules?${qs}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete common rule');
            await fetchCommon();
          } catch (e) { console.error(e); } finally { setSubLoading(false); }
        };
        const handleEditCommon = (r) => {
          setCommonMode('edit');
          setCommonOriginal(r);
          setCommonForm({ transaction_type: (r.transaction_type||'').toLowerCase(), pattern_match_logic: r.pattern_match_logic||'' });
          setCommonOpen(true);
        };
        const onSubmitCommon = async (e) => {
          e.preventDefault();
          if (!commonForm.transaction_type || !commonForm.pattern_match_logic) return;
          try {
            setCommonSaving(true);
            const res = await fetch('/api/common-rules', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ transaction_type: (commonForm.transaction_type||'').trim().toLowerCase(), pattern_match_logic: (commonForm.pattern_match_logic||'').trim() })
            });
            if (!res.ok) throw new Error('Failed to save common rule');
            if (commonMode === 'edit' && commonOriginal && (commonOriginal.transaction_type !== commonForm.transaction_type || commonOriginal.pattern_match_logic !== commonForm.pattern_match_logic)) {
              const qs = new URLSearchParams({ transaction_type: commonOriginal.transaction_type || '', pattern_match_logic: commonOriginal.pattern_match_logic || '' }).toString();
              await fetch(`/api/common-rules?${qs}`, { method: 'DELETE' });
            }
            setCommonOpen(false);
            await fetchCommon();
          } catch (e) { console.error(e); } finally { setCommonSaving(false); }
        };

        // InheritCommonToBank CRUD (Modal based)
        const [inheritOpen, setInheritOpen] = useState(false);
        const [inheritMode, setInheritMode] = useState('add');
        const [inheritSaving, setInheritSaving] = useState(false);
        const [inheritOriginal, setInheritOriginal] = useState(null);
        const emptyInherit = { bankaccountname:'', tax_category:'', property:'', group:'', otherentity:'' };
        const [inheritForm, setInheritForm] = useState(emptyInherit);
        const onInheritChange = (e) => {
          const { name, value } = e.target;
          const v = (value || '').toString();
          if (['bankaccountname','tax_category','property','group'].includes(name)) {
            setInheritForm(prev => ({ ...prev, [name]: v.toLowerCase() }));
          } else {
            setInheritForm(prev => ({ ...prev, [name]: v }));
          }
        };
        const handleAddInherit = () => {
          setInheritForm(emptyInherit);
          setInheritMode('add');
          setInheritOriginal(null);
          setInheritOpen(true);
        };
        const handleDeleteInherit = async (r) => {
          const params = {
            bankaccountname: r.bankaccountname || '',
            transaction_type: r.transaction_type || '',
            pattern_match_logic: r.pattern_match_logic || '',
            property: r.property || '',
            group: r.group || '',
            tax_category: r.tax_category || '',
            otherentity: r.otherentity || ''
          };
          const qs = new URLSearchParams(params).toString();
          if (!(await confirmAsync('Delete inherit rule?'))) return;
          try {
            setSubLoading(true);
            const res = await fetch(`/api/inherit-common-to-bank?${qs}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete inherit rule');
            await fetchInherit();
          } catch (e) { console.error(e); } finally { setSubLoading(false); }
        };
        const handleEditInherit = (r) => {
          setInheritMode('edit');
          setInheritOriginal(r);
          setInheritForm({
            bankaccountname: (r.bankaccountname||'').toLowerCase(),
            tax_category: (r.tax_category||'').toLowerCase(),
            property: (r.property||'').toLowerCase(),
            group: (r.group||'').toLowerCase(),
            otherentity: r.otherentity || ''
          });
          setInheritOpen(true);
        };
        const onSubmitInherit = async (e) => {
          e.preventDefault();
          const payload = {
            bankaccountname: (inheritForm.bankaccountname||'').trim().toLowerCase(),
            tax_category: (inheritForm.tax_category||'').trim().toLowerCase(),
            property: (inheritForm.property||'').trim().toLowerCase(),
            group: (inheritForm.group||'').trim().toLowerCase(),
            otherentity: (inheritForm.otherentity||'').trim(),
          };
          if (!payload.bankaccountname) return;
          try {
            setInheritSaving(true);
            const res = await fetch('/api/inherit-common-to-bank', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error('Failed to save inherit rule');
            if (inheritMode === 'edit' && inheritOriginal) {
              const params = {
                bankaccountname: inheritOriginal.bankaccountname || '',
                property: inheritOriginal.property || '',
                group: inheritOriginal.group || '',
                tax_category: inheritOriginal.tax_category || '',
                otherentity: inheritOriginal.otherentity || ''
              };
              const qs = new URLSearchParams(params).toString();
              await fetch(`/api/inherit-common-to-bank?${qs}`, { method: 'DELETE' });
            }
            setInheritOpen(false);
            await fetchInherit();
          } catch (e) { console.error(e); } finally { setInheritSaving(false); }
        };
        return (
          <div>
            <div className="tabs" style={{ marginBottom: 12 }}>
              <button className={`tab ${crSubTab==='bank' ? 'active' : ''}`} onClick={() => setCrSubTab('bank')}>BankRules</button>
              <button className={`tab ${crSubTab==='common' ? 'active' : ''}`} onClick={() => setCrSubTab('common')}>CommonRules</button>
              <button className={`tab ${crSubTab==='inherit' ? 'active' : ''}`} onClick={() => setCrSubTab('inherit')}>InheritCommonToBank</button>
            </div>
            {crSubTab === 'bank' && (
              <div>
                <BankRulesTabs bankaccounts={bankaccounts} items={items} taxCategories={taxCategories} transactionTypes={transactionTypes} groups={groups} />
              </div>
            )}
            {crSubTab === 'common' && (
              <div className="card">
                <div className="actions" style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                  <div className="muted">CommonRules</div>
                  <div>
                    <span className="mr-3 text-gray-600">Total: {(commonRules||[]).length}</span>
                    <button type="button" onClick={handleAddCommon} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add</button>
                    <button type="button" onClick={fetchCommon} disabled={subLoading} className="ml-2 px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:opacity-60">Refresh</button>
                  </div>
                </div>
                <Modal title={commonMode==='edit' ? 'Edit Common Rule' : 'Add Common Rule'} open={commonOpen} onClose={() => { setCommonOpen(false); setCommonMode('add'); setCommonOriginal(null); }} onSubmit={onSubmitCommon} submitLabel={commonSaving ? 'Saving...' : 'Save'} submitDisabled={!((commonForm.transaction_type||'').trim()) || !((commonForm.pattern_match_logic||'').trim())}>
                  <form onSubmit={onSubmitCommon} className="grid grid-cols-1 gap-5">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">transaction_type</label>
                      <select name="transaction_type" value={commonForm.transaction_type} onChange={onCommonChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Select transaction type</option>
                        {(transactionTypes || []).map(t => (
                          <option key={t.transactiontype} value={(t.transactiontype || '').toLowerCase()}>{t.transactiontype}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">pattern_match_logic</label>
                      <textarea name="pattern_match_logic" value={commonForm.pattern_match_logic} onChange={onCommonChange} rows={3} placeholder="e.g., desc_contains=rent" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required />
                    </div>
                  </form>
                </Modal>
                {subLoading ? (<div>Loading...</div>) : (
                  <table>
                    <thead>
                      <tr>
                        <th>transaction_type</th>
                        <th>pattern_match_logic</th>
                        <th>actions</th>
                      </tr>
                      <tr>
                        <th><input placeholder="filter" value={commonFilter.transaction_type} onChange={(e)=> setCommonFilter(f => ({...f, transaction_type: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={commonFilter.pattern_match_logic} onChange={(e)=> setCommonFilter(f => ({...f, pattern_match_logic: e.target.value}))} /></th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {(commonRules || [])
                        .slice()
                        .sort((a, b) => {
                          const at = (a.transaction_type || '').toLowerCase();
                          const bt = (b.transaction_type || '').toLowerCase();
                          if (at < bt) return -1; if (at > bt) return 1; return 0;
                        })
                        .filter(r => (
                          (commonFilter.transaction_type ? (r.transaction_type||'').toLowerCase().includes(commonFilter.transaction_type.toLowerCase()) : true) &&
                          (commonFilter.pattern_match_logic ? (r.pattern_match_logic||'').toLowerCase().includes(commonFilter.pattern_match_logic.toLowerCase()) : true)
                        ))
                        .map((r, idx) => (
                          <tr key={`common-${r.transaction_type}-${idx}`}>
                            <td>{r.transaction_type}</td>
                            <td className="whitespace-pre-wrap">{r.pattern_match_logic}</td>
                            <td>
                              <button onClick={() => handleEditCommon(r)} className="px-2 py-1 mr-2 bg-gray-700 text-white rounded hover:bg-gray-800">Edit</button>
                              <button onClick={() => handleDeleteCommon(r)} className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
                            </td>
                          </tr>
                        ))}
                      {(commonRules || []).length === 0 && (
                        <tr><td colSpan="3" className="muted">No common rules</td></tr>
                      )}
                    </tbody>
                  </table>
                )}
              </div>
            )}
            {crSubTab === 'inherit' && (
              <div className="card">
                <div className="actions" style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                  <div className="muted">InheritCommonToBank</div>
                  <div>
                    <span className="mr-3 text-gray-600">Total: {(inheritRules||[]).length}</span>
                    <button type="button" onClick={handleAddInherit} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add</button>
                    <button type="button" onClick={fetchInherit} disabled={subLoading} className="ml-2 px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:opacity-60">Refresh</button>
                  </div>
                </div>
                <Modal title={inheritMode==='edit' ? 'Edit Inherit Rule' : 'Add Inherit Rule'} open={inheritOpen} onClose={() => { setInheritOpen(false); setInheritMode('add'); setInheritOriginal(null); }} onSubmit={onSubmitInherit} submitLabel={inheritSaving ? 'Saving...' : 'Save'} submitDisabled={!((inheritForm.bankaccountname||'').trim())}>
                  <form onSubmit={onSubmitInherit} className="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">bankaccountname</label>
                      <select name="bankaccountname" value={inheritForm.bankaccountname} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Select bank account</option>
                        {(bankaccounts || []).map(b => (
                          <option key={b.bankaccountname} value={(b.bankaccountname || '').toLowerCase()}>{b.bankaccountname}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700">tax_category</label>
                      <select name="tax_category" value={inheritForm.tax_category} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select tax category</option>
                        {(taxCategories || []).map(c => (
                          <option key={c.category} value={(c.category || '').toLowerCase()}>{c.category}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">property</label>
                      <select name="property" value={inheritForm.property} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select property</option>
                        {(items || []).map(p => (
                          <option key={p.property} value={(p.property || '').toLowerCase()}>{p.property}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">group</label>
                      <select name="group" value={inheritForm.group} onChange={onInheritChange} className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select group (optional)</option>
                        {(inheritGroupsData || []).map(g => (
                          <option key={g.groupname} value={(g.groupname || '').toLowerCase()}>{g.groupname}</option>
                        ))}
                      </select>
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700">otherentity</label>
                      <input name="otherentity" value={inheritForm.otherentity} onChange={onInheritChange} placeholder="optional" className="mt-1 w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                  </form>
                </Modal>
                {subLoading ? (<div>Loading...</div>) : (
                  <table>
                    <thead>
                      <tr>
                        <th>bankaccountname</th>
                        <th>tax_category</th>
                        <th>property</th>
                        <th>group</th>
                        <th>otherentity</th>
                        <th>actions</th>
                      </tr>
                      <tr>
                        <th><input placeholder="filter" value={inheritFilter.bankaccountname} onChange={(e)=> setInheritFilter(f => ({...f, bankaccountname: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.tax_category} onChange={(e)=> setInheritFilter(f => ({...f, tax_category: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.property} onChange={(e)=> setInheritFilter(f => ({...f, property: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.group} onChange={(e)=> setInheritFilter(f => ({...f, group: e.target.value}))} /></th>
                        <th><input placeholder="filter" value={inheritFilter.otherentity} onChange={(e)=> setInheritFilter(f => ({...f, otherentity: e.target.value}))} /></th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {(inheritRules || [])
                        .slice()
                        .sort((a, b) => {
                          const an = (a.bankaccountname || '').toLowerCase();
                          const bn = (b.bankaccountname || '').toLowerCase();
                          if (an < bn) return -1; if (an > bn) return 1;
                          const atc = (a.tax_category || '').toLowerCase();
                          const btc = (b.tax_category || '').toLowerCase();
                          if (atc < btc) return -1; if (atc > btc) return 1;
                          return 0;
                        })
                        .filter(r => (
                          (inheritFilter.bankaccountname ? (r.bankaccountname||'').toLowerCase().includes(inheritFilter.bankaccountname.toLowerCase()) : true) &&
                          (inheritFilter.tax_category ? (r.tax_category||'').toLowerCase().includes(inheritFilter.tax_category.toLowerCase()) : true) &&
                          (inheritFilter.property ? (r.property||'').toLowerCase().includes(inheritFilter.property.toLowerCase()) : true) &&
                          (inheritFilter.group ? (r.group||'').toLowerCase().includes(inheritFilter.group.toLowerCase()) : true) &&
                          (inheritFilter.otherentity ? (r.otherentity||'').toLowerCase().includes(inheritFilter.otherentity.toLowerCase()) : true)
                        ))
                        .map((r, idx) => (
                          <tr key={`inherit-${r.bankaccountname}-${r.property}-${idx}`}>
                            <td>{r.bankaccountname}</td>
                            <td>{r.tax_category}</td>
                            <td>{r.property}</td>
                            <td>{r.group}</td>
                            <td>{r.otherentity}</td>
                            <td>
                              <button onClick={() => handleEditInherit(r)} className="px-2 py-1 mr-2 bg-gray-700 text-white rounded hover:bg-gray-800">Edit</button>
                              <button onClick={() => handleDeleteInherit(r)} className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
                            </td>
                          </tr>
                        ))}
                      {(inheritRules || []).length === 0 && (
                        <tr><td colSpan="6" className="muted">No bank-specific rules</td></tr>
                      )}
                    </tbody>
                  </table>
                )}
              </div>
            )}
          </div>
        );
      }

      const api = {
        async list() {
          const res = await fetch('/api/properties');
          if (!res.ok) throw new Error('Failed to fetch properties');
          return res.json();
        },
        async add(item) {
          const res = await fetch('/api/properties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || 'Failed to add property');
          }

      function CompaniesPanel({ companyRecords, loading, reload }) {
        const emptyCompany = { companyname: '', rentPercentage: 0 };
        const [form, setForm] = React.useState(emptyCompany);
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ companyname: '', rentPercentage: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'rentPercentage') {
            setForm({ ...form, [name]: Number(value || 0) });
          } else if (name === 'companyname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
      window.api = api;
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            if (!form.companyname) throw new Error('companyname is required');
            const payload = { ...form, companyname: form.companyname.trim().toLowerCase() };
            await api.addCompanyRecord(payload);
            setForm(emptyCompany);
            await reload();
          } catch (e) { setError(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeCompanyRecord(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Company Records</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>companyname<br/>
                    <input name="companyname" value={form.companyname} onChange={onChange} placeholder="company name (lowercased)" />
                  </label></div>
                  <div className="col"><label>rentPercentage<br/>
                    <input name="rentPercentage" type="number" value={form.rentPercentage} onChange={onChange} min="0" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add company</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>companyname</th>
                      <th>rentPercentage</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th>
                        <input
                          placeholder="filter"
                          value={filter.companyname}
                          onChange={(e)=> setFilter(f=>({...f, companyname: e.target.value }))}
                        />
                      </th>
                      <th>
                        <input
                          placeholder="filter"
                          value={filter.rentPercentage}
                          onChange={(e)=> setFilter(f=>({...f, rentPercentage: e.target.value }))}
                        />
                      </th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {companyRecords
                      .filter(x => (
                        (filter.companyname ? (x.companyname||'').toString().toLowerCase().includes(filter.companyname.toLowerCase()) : true) &&
                        (filter.rentPercentage ? String(x.rentPercentage||'').toLowerCase().includes(filter.rentPercentage.toLowerCase()) : true)
                      ))
                      .map((x) => (
                      <tr key={x.companyname}>
                        <td>{x.companyname}</td>
                        <td>{x.rentPercentage}</td>
                        <td><button onClick={() => onDelete(x.companyname)}>Delete</button></td>
                      </tr>
                    ))}
                    {companyRecords.length === 0 && (<tr><td colSpan="3" className="muted">No company records</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function BankAccountsPanel({ bankaccounts, loading, reload }) {
        const emptyBA = { bankaccountname: '', bankname: '' };
        const [form, setForm] = React.useState(emptyBA);
        const [saving, setSaving] = React.useState(false);
        const [filter, setFilter] = React.useState({ bankaccountname: '', bankname: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'bankaccountname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else if (name === 'bankname') {
            setForm({ ...form, [name]: (value || '').toLowerCase() });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true);
          try {
            if (!form.bankaccountname || !form.bankname) throw new Error('bankaccountname and bankname are required');
            await api.addBankaccount(form);
            setForm(emptyBA);
            await reload();
          } catch (e) { alert(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBankaccount(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Bank Accounts</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>bankaccountname<br/>
                    <input name="bankaccountname" value={form.bankaccountname} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>bankname<br/>
                    <input name="bankname" value={form.bankname} onChange={onChange} placeholder="bank name" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add bank account</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>bankaccountname</th>
                      <th>bankname</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th>
                        <input placeholder="filter" value={filter.bankaccountname} onChange={(e)=> setFilter(f=>({...f, bankaccountname: e.target.value }))} />
                      </th>
                      <th>
                        <input placeholder="filter" value={filter.bankname} onChange={(e)=> setFilter(f=>({...f, bankname: e.target.value }))} />
                      </th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {bankaccounts
                      .filter(x => (
                        (filter.bankaccountname ? (x.bankaccountname||'').toLowerCase().includes(filter.bankaccountname.toLowerCase()) : true) &&
                        (filter.bankname ? (x.bankname||'').toLowerCase().includes(filter.bankname.toLowerCase()) : true)
                      ))
                      .map(x => (
                      <tr key={x.bankaccountname}>
                        <td>{x.bankaccountname}</td>
                        <td>{x.bankname}</td>
                        <td><button onClick={() => onDelete(x.bankaccountname)}>Delete</button></td>
                      </tr>
                    ))}
                    {bankaccounts.length === 0 && (<tr><td colSpan="3" className="muted">No bank accounts</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function GroupsPanel({ groups, loading, reload }) {
        const emptyGroup = { groupname: '', propertylist: '' };
        const [form, setForm] = React.useState(emptyGroup);
        const [saving, setSaving] = React.useState(false);
        const [filter, setFilter] = React.useState({ groupname: '', propertylist: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'groupname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true);
          try {
            const payload = { groupname: form.groupname, propertylist: (form.propertylist || '').split('|').map(s=>s.trim().toLowerCase()).filter(Boolean) };
            if (!payload.groupname) throw new Error('groupname is required');
            await api.addGroup(payload);
            setForm(emptyGroup);
            await reload();
          } catch (e) { alert(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeGroup(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Groups</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>groupname<br/>
                    <input name="groupname" value={form.groupname} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>propertylist (pipe-separated)<br/>
                    <input name="propertylist" value={form.propertylist} onChange={onChange} placeholder="p1|p2|p3" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add group</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>groupname</th>
                      <th>propertylist</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th>
                        <input placeholder="filter" value={filter.groupname} onChange={(e)=> setFilter(f=>({...f, groupname: e.target.value }))} />
                      </th>
                      <th>
                        <input placeholder="filter" value={filter.propertylist} onChange={(e)=> setFilter(f=>({...f, propertylist: e.target.value }))} />
                      </th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {groups
                      .filter(x => (
                        (filter.groupname ? (x.groupname||'').toLowerCase().includes(filter.groupname.toLowerCase()) : true) &&
                        (filter.propertylist ? (x.propertylist||[]).join(' ').toLowerCase().includes(filter.propertylist.toLowerCase()) : true)
                      ))
                      .map(x => (
                      <tr key={x.groupname}>
                        <td>{x.groupname}</td>
                        <td>{x.propertylist.join(' | ')}</td>
                        <td><button onClick={() => onDelete(x.groupname)}>Delete</button></td>
                      </tr>
                    ))}
                    {groups.length === 0 && (<tr><td colSpan="3" className="muted">No groups</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function OwnersPanel({ owners, loading, reload, bankaccounts, items, companies }) {
        const emptyOwner = { name: '', bankaccounts: [], properties: [], companies: [] };
        const [form, setForm] = React.useState(emptyOwner);
        const [saving, setSaving] = React.useState(false);
        const [filter, setFilter] = React.useState({ name: '', bankaccounts: '', properties: '', companies: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if (name === 'name') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setForm({ ...form, [name]: sanitized });
          } else if (e.target.multiple) {
            const selected = Array.from(e.target.selectedOptions).map(o => (o.value || '').toLowerCase());
            setForm({ ...form, [name]: selected });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true);
          try {
            if (!form.name) throw new Error('name is required');
            const payload = {
              name: form.name,
              bankaccounts: Array.from(new Set((form.bankaccounts || []).map(s => (s || '').toLowerCase()))),
              properties: Array.from(new Set((form.properties || []).map(s => (s || '').toLowerCase()))),
              companies: Array.from(new Set((form.companies || []).map(s => (s || '').toLowerCase()))),
            };
            await api.addOwner(payload);
            setForm(emptyOwner);
            await reload();
          } catch (e) { alert(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeOwner(name); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Owners</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>name<br/>
                    <input name="name" value={form.name} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>bankaccounts (multi-select)<br/>
                    <select name="bankaccounts" multiple value={form.bankaccounts} onChange={onChange}>
                      {bankaccounts.map(ba => (
                        <option key={ba.bankaccountname} value={ba.bankaccountname}>{ba.bankaccountname}</option>
                      ))}
                    </select>
                  </label></div>
                  <div className="col"><label>properties (multi-select)<br/>
                    <select name="properties" multiple value={form.properties} onChange={onChange}>
                      {items.map(p => (
                        <option key={p.property} value={p.property}>{p.property}</option>
                      ))}
                    </select>
                  </label></div>
                  <div className="col"><label>companies (multi-select)<br/>
                    <select name="companies" multiple value={form.companies} onChange={onChange}>
                      {companies.map(c => (
                        <option key={c} value={c}>{c}</option>
                      ))}
                    </select>
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add owner</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>name</th>
                      <th>bankaccounts</th>
                      <th>properties</th>
                      <th>companies</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.name} onChange={(e)=> setFilter(f=>({...f, name: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.bankaccounts} onChange={(e)=> setFilter(f=>({...f, bankaccounts: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.properties} onChange={(e)=> setFilter(f=>({...f, properties: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.companies} onChange={(e)=> setFilter(f=>({...f, companies: e.target.value }))} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {owners
                      .filter(x => (
                        (filter.name ? (x.name||'').toLowerCase().includes(filter.name.toLowerCase()) : true) &&
                        (filter.bankaccounts ? (x.bankaccounts||[]).join(' ').toLowerCase().includes(filter.bankaccounts.toLowerCase()) : true) &&
                        (filter.properties ? (x.properties||[]).join(' ').toLowerCase().includes(filter.properties.toLowerCase()) : true) &&
                        (filter.companies ? (x.companies||[]).join(' ').toLowerCase().includes(filter.companies.toLowerCase()) : true)
                      ))
                      .map(x => (
                      <tr key={x.name}>
                        <td>{x.name}</td>
                        <td>{x.bankaccounts.join(' | ')}</td>
                        <td>{x.properties.join(' | ')}</td>
                        <td>{x.companies.join(' | ')}</td>
                        <td><button onClick={() => onDelete(x.name)}>Delete</button></td>
                      </tr>
                    ))}
                    {owners.length === 0 && (<tr><td colSpan="5" className="muted">No owners</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function PropertiesPanel({ items, companies, loading, reload }) {
        const empty = { property: '', cost: 0, landValue: 0, renovation: 0, loanClosingCOst: 0, ownerCount: 1, purchaseDate: '', propMgmgtComp: '' };
        const [form, setForm] = React.useState(empty);
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ property:'', cost:'', landValue:'', renovation:'', loanClosingCOst:'', ownerCount:'', purchaseDate:'', propMgmgtComp:'' });
        const onChange = (e) => {
          const { name, value } = e.target;
          if ([ 'cost','landValue','renovation','loanClosingCOst','ownerCount' ].includes(name)) {
            setForm({ ...form, [name]: Number(value || 0) });
          } else {
            setForm({ ...form, [name]: value });
          }
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            if (!form.property) throw new Error('property is required');
            const payload = {
              ...form,
              property: (form.property || '').trim().toLowerCase(),
              purchaseDate: (form.purchaseDate || '').trim().toLowerCase(),
              propMgmgtComp: (form.propMgmgtComp || '').trim().toLowerCase(),
            };
            await api.add(payload);
            setForm(empty);
            await reload();
          } catch (e) { setError(e.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (id) => {
          if (!confirm(`Delete ${id}?`)) return;
          try { await api.remove(id); await reload(); } catch (e) { alert(e.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Properties</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>property<br/><input name="property" value={form.property} onChange={onChange} placeholder="unique id" required /></label></div>
                  <div className="col"><label>cost<br/><input name="cost" type="number" value={form.cost} onChange={onChange} /></label></div>
                  <div className="col"><label>landValue<br/><input name="landValue" type="number" value={form.landValue} onChange={onChange} /></label></div>
                  <div className="col"><label>renovation<br/><input name="renovation" type="number" value={form.renovation} onChange={onChange} /></label></div>
                  <div className="col"><label>loanClosingCOst<br/><input name="loanClosingCOst" type="number" value={form.loanClosingCOst} onChange={onChange} /></label></div>
                  <div className="col"><label>ownerCount<br/><input name="ownerCount" type="number" value={form.ownerCount} onChange={onChange} min="1" /></label></div>
                  <div className="col"><label>purchaseDate<br/><input name="purchaseDate" type="text" value={form.purchaseDate} onChange={onChange} placeholder="MM/DD/YYYY" /></label></div>
                  <div className="col"><label>propMgmgtComp<br/>
                    <select name="propMgmgtComp" value={form.propMgmgtComp} onChange={onChange}>
                      <option value="">Select company</option>
                      {companies.map((c) => (
                        <option key={c} value={c}>{c}</option>
                      ))}
                    </select>
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add property</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                  <span className="muted">All data is in-memory only.</span>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>property</th>
                      <th>cost</th>
                      <th>landValue</th>
                      <th>renovation</th>
                      <th>loanClosingCOst</th>
                      <th>ownerCount</th>
                      <th>purchaseDate</th>
                      <th>propMgmgtComp</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.property} onChange={(e)=> setFilter(f=>({...f, property: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.cost} onChange={(e)=> setFilter(f=>({...f, cost: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.landValue} onChange={(e)=> setFilter(f=>({...f, landValue: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.renovation} onChange={(e)=> setFilter(f=>({...f, renovation: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.loanClosingCOst} onChange={(e)=> setFilter(f=>({...f, loanClosingCOst: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.ownerCount} onChange={(e)=> setFilter(f=>({...f, ownerCount: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.purchaseDate} onChange={(e)=> setFilter(f=>({...f, purchaseDate: e.target.value }))} /></th>
                      <th><input placeholder="filter" value={filter.propMgmgtComp} onChange={(e)=> setFilter(f=>({...f, propMgmgtComp: e.target.value }))} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {items
                      .filter(x => (
                        (filter.property ? (x.property||'').toLowerCase().includes(filter.property.toLowerCase()) : true) &&
                        (filter.cost ? String(x.cost||'').toLowerCase().includes(filter.cost.toLowerCase()) : true) &&
                        (filter.landValue ? String(x.landValue||'').toLowerCase().includes(filter.landValue.toLowerCase()) : true) &&
                        (filter.renovation ? String(x.renovation||'').toLowerCase().includes(filter.renovation.toLowerCase()) : true) &&
                        (filter.loanClosingCOst ? String(x.loanClosingCOst||'').toLowerCase().includes(filter.loanClosingCOst.toLowerCase()) : true) &&
                        (filter.ownerCount ? String(x.ownerCount||'').toLowerCase().includes(filter.ownerCount.toLowerCase()) : true) &&
                        (filter.purchaseDate ? String(x.purchaseDate||'').toLowerCase().includes(filter.purchaseDate.toLowerCase()) : true) &&
                        (filter.propMgmgtComp ? String(x.propMgmgtComp||'').toLowerCase().includes(filter.propMgmgtComp.toLowerCase()) : true)
                      ))
                      .map((x) => (
                      <tr key={x.property}>
                        <td>{x.property}</td>
                        <td>{x.cost}</td>
                        <td>{x.landValue}</td>
                        <td>{x.renovation}</td>
                        <td>{x.loanClosingCOst}</td>
                        <td>{x.ownerCount}</td>
                        <td>{x.purchaseDate}</td>
                        <td>{x.propMgmgtComp}</td>
                        <td><button onClick={() => onDelete(x.property)}>Delete</button></td>
                      </tr>
                    ))}
                    {items.length === 0 && (<tr><td colSpan="9" className="muted">No items</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      // Tax Categories Panel
      function TaxCategoriesPanel({ taxCategories, loading, reload }) {
        const [form, setForm] = React.useState({ category: '' });
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ category: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: name === 'category' ? (value || '').trim().toLowerCase() : value }));
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            const category = (form.category || '').trim().toLowerCase();
            if (!category) throw new Error('category is required');
            await api.addTaxCategory({ category });
            setForm({ category: '' });
            await reload();
          } catch (err) { setError(err.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (category) => {
          if (!confirm(`Delete ${category}?`)) return;
          try { await api.removeTaxCategory(category); await reload(); } catch (err) { alert(err.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Tax Categories</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>category<br/>
                    <input name="category" value={form.category} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add category</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>category</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.category} onChange={(e)=> setFilter({ category: e.target.value })} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {taxCategories
                      .filter(t => (filter.category ? (t.category||'').toLowerCase().includes(filter.category.toLowerCase()) : true))
                      .map(t => (
                      <tr key={t.category}>
                        <td>{t.category}</td>
                        <td><button onClick={() => onDelete(t.category)}>Delete</button></td>
                      </tr>
                    ))}
                    {taxCategories.length === 0 && (<tr><td colSpan="2" className="muted">No tax categories</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      // Transaction Types Panel
      function TransactionTypesPanel({ transactionTypes, loading, reload }) {
        const [form, setForm] = React.useState({ transactiontype: '' });
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const [filter, setFilter] = React.useState({ transactiontype: '' });
        const onChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: name === 'transactiontype' ? (value || '').trim().toLowerCase() : value }));
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            const transactiontype = (form.transactiontype || '').trim().toLowerCase();
            if (!transactiontype) throw new Error('transactiontype is required');
            await api.addTransactionType({ transactiontype });
            setForm({ transactiontype: '' });
            await reload();
          } catch (err) { setError(err.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (tt) => {
          if (!confirm(`Delete ${tt}?`)) return;
          try { await api.removeTransactionType(tt); await reload(); } catch (err) { alert(err.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Transaction Types</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>transactiontype<br/>
                    <input name="transactiontype" value={form.transactiontype} onChange={onChange} placeholder="lowercase [a-z0-9_]" />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add type</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>transactiontype</th>
                      <th></th>
                    </tr>
                    <tr>
                      <th><input placeholder="filter" value={filter.transactiontype} onChange={(e)=> setFilter({ transactiontype: e.target.value })} /></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {transactionTypes
                      .filter(t => (filter.transactiontype ? (t.transactiontype||'').toLowerCase().includes(filter.transactiontype.toLowerCase()) : true))
                      .map(t => (
                      <tr key={t.transactiontype}>
                        <td>{t.transactiontype}</td>
                        <td><button onClick={() => onDelete(t.transactiontype)}>Delete</button></td>
                      </tr>
                    ))}
                    {transactionTypes.length === 0 && (<tr><td colSpan="2" className="muted">No transaction types</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }
          return res.json();
        },
        async remove(id) {
          const res = await fetch(`/api/properties/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete');
        },
        async companies() {
          const res = await fetch('/api/companies');
          if (!res.ok) throw new Error('Failed to fetch companies');
          return res.json();
        },
        async listCompanyRecords() {
          const res = await fetch('/api/company-records');
          if (!res.ok) throw new Error('Failed to fetch company records');
          return res.json();
        },
        async addCompanyRecord(item) {
          const res = await fetch('/api/company-records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || 'Failed to add company record');
          }
          return res.json();
        },
        async removeCompanyRecord(name) {
          const res = await fetch(`/api/company-records/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete company record');
        },
        // Bank accounts
        async listBankaccounts() {
          const res = await fetch('/api/bankaccounts');
          if (!res.ok) throw new Error('Failed to fetch bank accounts');
          return res.json();
        },
        async addBankaccount(item) {
          const res = await fetch('/api/bankaccounts', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async updateBankaccount(name, item) {
          const res = await fetch(`/api/bankaccounts/${encodeURIComponent(name)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeBankaccount(name) {
          const res = await fetch(`/api/bankaccounts/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete bank account');
        },
        // Groups
        async listGroups() {
          const res = await fetch('/api/groups');
          if (!res.ok) throw new Error('Failed to fetch groups');
          return res.json();
        },
        async addGroup(item) {
          const res = await fetch('/api/groups', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeGroup(name) {
          const res = await fetch(`/api/groups/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete group');
        },
        // Owners
        async listOwners() {
          const res = await fetch('/api/owners');
          if (!res.ok) throw new Error('Failed to fetch owners');
          return res.json();
        },
        async addOwner(item) {
          const res = await fetch('/api/owners', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeOwner(name) {
          const res = await fetch(`/api/owners/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete owner');
        },
        // Tax categories
        async listTaxCategories() {
          const res = await fetch('/api/tax-categories');
          if (!res.ok) throw new Error('Failed to fetch tax categories');
          return res.json();
        },
        async addTaxCategory(item) {
          const res = await fetch('/api/tax-categories', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeTaxCategory(category) {
          const res = await fetch(`/api/tax-categories/${encodeURIComponent(category)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete tax category');
        },
        // Transaction types
        async listTransactionTypes() {
          const res = await fetch('/api/transaction-types');
          if (!res.ok) throw new Error('Failed to fetch transaction types');
          return res.json();
        },
        async addTransactionType(item) {
          const res = await fetch('/api/transaction-types', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeTransactionType(tt) {
          const res = await fetch(`/api/transaction-types/${encodeURIComponent(tt)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete transaction type');
        },
        // Rental summary
        async listRentalSummary() {
          const res = await fetch('/api/rental-summary');
          if (!res.ok) throw new Error('Failed to fetch rental summary');
          return res.json();
        },
        // Company summary
        async listCompanySummary() {
          const res = await fetch('/api/company-summary');
          if (!res.ok) throw new Error('Failed to fetch company summary');
          return res.json();
        },
        // Transactions persistence
        async listTransactions() {
          const res = await fetch('/api/transactions');
          if (!res.ok) throw new Error('Failed to fetch transactions');
          return res.json();
        },
        async saveTransactions(bankaccountname, rows) {
          const res = await fetch(`/api/transactions/${encodeURIComponent(bankaccountname)}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rows })
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        // Classify rules
        async listClassifyRules() {
          const res = await fetch('/api/classify-rules');
          if (res.status === 404) return [];
          if (!res.ok) throw new Error('Failed to fetch classify rules');
          return res.json();
        },
        async addClassifyRule(item) {
          const res = await fetch('/api/classify-rules', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeClassifyRule(key) {
          // key can be an object; encode a composite id if backend expects one
          const obj = (typeof key === 'object' && key !== null) ? key : { bankaccountname: key };
          const bankVal = obj.bankaccountname != null ? obj.bankaccountname : '';
          const qp = new URLSearchParams({
            bankaccountname: String(bankVal),
            transaction_type: obj.transaction_type || '',
            property: obj.property || '',
          }).toString();
          const res = await fetch(`/api/classify-rules?${qp}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete classify rule');
        },

        // Banks config
        async listBanks() {
          const res = await fetch('/api/banks');
          if (!res.ok) throw new Error('Failed to fetch banks config');
          return res.json();
        },
        async addBank(cfg) {
          const res = await fetch('/api/banks', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg)
          });
          if (!res.ok) throw new Error(await res.text());
          return res.json();
        },
        async removeBank(name) {
          const res = await fetch(`/api/banks/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!res.ok && res.status !== 204) throw new Error('Failed to delete bank config');
        }
      };

      // Banks Panel component (encapsulates its own form state and handlers)
      function BanksPanel({ banks, loading, reload }) {
        const [form, setForm] = React.useState({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
        const [saving, setSaving] = React.useState(false);
        const [error, setError] = React.useState('');
        const onChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: value }));
        };
        const onSubmit = async (e) => {
          e.preventDefault(); setSaving(true); setError('');
          try {
            const name = (form.name || '').trim().toLowerCase();
            if (!name) throw new Error('name is required');
            const ignore_lines_contains = (form.ignore_lines_contains || '').split('|').map(s=>s.trim()).filter(Boolean);
            const ignore_lines_startswith = (form.ignore_lines_startswith || '').split('|').map(s=>s.trim()).filter(Boolean);
            let columns = [];
            if (form.columnsText && form.columnsText.trim()) {
              try { columns = JSON.parse(form.columnsText); } catch (_) { columns = []; }
            }
            const payload = {
              name,
              date_format: form.date_format || undefined,
              delim: form.delim || undefined,
              ignore_lines_contains: ignore_lines_contains.length ? ignore_lines_contains : undefined,
              ignore_lines_startswith: ignore_lines_startswith.length ? ignore_lines_startswith : undefined,
              columns: columns.length ? columns : undefined,
            };
            await api.addBank(payload);
            setForm({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
            await reload();
          } catch (err) { setError(err.message || 'Error'); } finally { setSaving(false); }
        };
        const onDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBank(name); await reload(); } catch (err) { alert(err.message || 'Error'); }
        };
        return (
          <React.Fragment>
            <h2>Banks</h2>
            <div className="card">
              <form onSubmit={onSubmit}>
                <div className="row">
                  <div className="col"><label>name<br/>
                    <input name="name" value={form.name} onChange={onChange} placeholder="lowercase id [a-z0-9_]" />
                  </label></div>
                  <div className="col"><label>date_format<br/>
                    <input name="date_format" value={form.date_format} onChange={onChange} placeholder="M/d/yyyy" />
                  </label></div>
                  <div className="col"><label>delim<br/>
                    <input name="delim" value={form.delim} onChange={onChange} placeholder="," />
                  </label></div>
                  <div className="col"><label>ignore_lines_contains (| separated)<br/>
                    <input name="ignore_lines_contains" value={form.ignore_lines_contains} onChange={onChange} placeholder="foo|bar" />
                  </label></div>
                  <div className="col"><label>ignore_lines_startswith (| separated)<br/>
                    <input name="ignore_lines_startswith" value={form.ignore_lines_startswith} onChange={onChange} placeholder="Header|Total" />
                  </label></div>
                  <div className="col" style={{flexBasis:'100%'}}><label>columns (JSON array)<br/>
                    <input name="columnsText" value={form.columnsText} onChange={onChange} placeholder='[{"date":1,"description":2,"debit":3}]' />
                  </label></div>
                </div>
                <div className="actions" style={{ marginTop: 12 }}>
                  <button type="submit" disabled={saving}>Add bank</button>
                  <button type="button" onClick={reload} disabled={loading}>Refresh</button>
                </div>
                {error && <div className="error" style={{ marginTop: 8 }}>{error}</div>}
              </form>
            </div>
            <div className="card">
              {loading ? (<div>Loading...</div>) : (
                <table>
                  <thead>
                    <tr>
                      <th>name</th>
                      <th>date_format</th>
                      <th>delim</th>
                      <th>ignore_lines_contains</th>
                      <th>ignore_lines_startswith</th>
                      <th>columns</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {banks.map(b => (
                      <tr key={b.name}>
                        <td>{b.name}</td>
                        <td>{b.date_format || ''}</td>
                        <td>{b.delim || ''}</td>
                        <td>{(b.ignore_lines_contains || []).join(' | ')}</td>
                        <td>{(b.ignore_lines_startswith || []).join(' | ')}</td>
                        <td>{(b.columns || []).map((c, i) => (
                          <span key={i}>{Object.entries(c).map(([k,v]) => `${k}:${v}`).join(', ')}{i < (b.columns.length-1) ? ' | ' : ''}</span>
                        ))}</td>
                        <td><button onClick={() => onDelete(b.name)}>Delete</button></td>
                      </tr>
                    ))}
                    {banks.length === 0 && (<tr><td colSpan="7" className="muted">No bank configs</td></tr>)}
                  </tbody>
                </table>
              )}
            </div>
          </React.Fragment>
        );
      }

      function App() {
        const [items, setItems] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');
        const [companies, setCompanies] = useState([]);
        const [companyRecords, setCompanyRecords] = useState([]);
        const [bankaccounts, setBankaccounts] = useState([]);
        const [groups, setGroups] = useState([]);
        // Local fallback cache for groups specifically for modals that may open before groups load
        const [inheritGroupsData, setInheritGroupsData] = useState([]);
        useEffect(() => { setInheritGroupsData(groups || []); }, [groups]);
        useEffect(() => {
          if (!groups || groups.length === 0) {
            try { api.listGroups().then(gs => { if (Array.isArray(gs)) setInheritGroupsData(gs); }).catch(()=>{}); } catch (_) {}
          }
        }, []);
        const [owners, setOwners] = useState([]);
        const [taxCategories, setTaxCategories] = useState([]);
        const [transactionTypes, setTransactionTypes] = useState([]);
        const [banks, setBanks] = useState([]);
        const [classifyRules, setClassifyRules] = useState([]);
        // Transactions subtabs state (per bankaccount)
        const [txnBATab, setTxnBATab] = useState(() => {
          try { return window.localStorage.getItem('txnBATab') || ''; } catch(_) { return ''; }
        });
        useEffect(() => {
          if (!txnBATab && (bankaccounts || []).length > 0) {
            setTxnBATab((bankaccounts[0].bankaccountname || ''));
          }
        }, [txnBATab, bankaccounts]);
        useEffect(() => {
          try { window.localStorage.setItem('txnBATab', txnBATab || ''); } catch(_) {}
        }, [txnBATab]);
        // Local per-account transactions state (placeholder until backend wiring)
        const [transactionsByBA, setTransactionsByBA] = useState({});
        const [currentYear, setCurrentYear] = useState('');
        const [txnMonth, setTxnMonth] = useState('12');
        const [txnDay, setTxnDay] = useState('31');
        const [txnOpen, setTxnOpen] = useState(false);
        const [txnSaving, setTxnSaving] = useState(false);
        const emptyTxn = { tr_id: '', date: '', description: '', credit: '', ruleid: '', comment: '', transaction_type: '', tax_category: '', property: '', group: '', company: '', otherentity: '', override: '' };
        const [txnForm, setTxnForm] = useState(emptyTxn);
        const [txnFilters, setTxnFilters] = useState({ tr_id: '', date: '', description: '', credit: '', ruleid: '', comment: '', transaction_type: '', tax_category: '', pgc: '', property: '', group: '', company: '', otherentity: '', override: '' });
        const onTxnChange = (e) => {
          const { name, value } = e.target;
          const v = name === 'description' ? (value || '').toLowerCase() : value;
          setTxnForm(prev => ({ ...prev, [name]: v }));
        };
        const onTxnFilterChange = (e) => {
          const { name, value } = e.target;
          setTxnFilters(prev => ({ ...prev, [name]: value }));
        };
        const onTxnAdd = async () => {
          setTxnForm(emptyTxn);
          setTxnMonth('12');
          setTxnDay('31');
          try {
            const res = await fetch('/api/transactions/config');
            if (res.ok) {
              const j = await res.json();
              setCurrentYear(String(j.current_year || ''));
            }
          } catch (_) {}
          setTxnOpen(true);
        };

        // Load CURRENT_YEAR for date validation
        useEffect(() => {
          (async () => {
            try {
              const res = await fetch('/api/transactions/config');
              if (!res.ok) return;
              const j = await res.json();
              setCurrentYear(String(j.current_year || ''));
            } catch (_) {}
          })();
        }, []);

        const isValidTxnDate = () => {
          if (!currentYear) return false;
          const m = Number(txnMonth);
          const d = Number(txnDay);
          if (!Number.isInteger(m) || m < 1 || m > 12) return false;
          if (!Number.isInteger(d) || d < 1 || d > 31) return false;
          return true;
        };
        const isValidCredit = (c) => {
          if (c == null) return false;
          const s = String(c).trim();
          if (!s) return false;
          const n = Number(s);
          return Number.isFinite(n);
        };
        const isTxnSaveEnabled = (
          isValidTxnDate() &&
          String(txnForm.description || '').trim().length > 0 &&
          isValidCredit(txnForm.credit)
        );
        const saveTxnRows = async (ba, newRows) => {
          setTxnSaving(true);
          try {
            const res = await fetch(`/api/transactions/${encodeURIComponent(ba)}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rows: newRows }) });
            if (!res.ok) {
              const msg = await res.text().catch(()=> '');
              throw new Error(msg || 'Failed to save');
            }
            setTransactionsByBA(prev => ({ ...prev, [ba]: newRows }));
          } finally { setTxnSaving(false); }
        };

        const onTxnSubmit = async (e) => {
          e.preventDefault();
          try {
            const ba = txnBATab || '';
            if (!ba) throw new Error('Select a bank account');
            const mm = String(txnMonth).padStart(2,'0');
            const dd = String(txnDay).padStart(2,'0');
            const payload = {
              date: `${String(currentYear)}-${mm}-${dd}`,
              description: (txnForm.description || ''),
              credit: (txnForm.credit || ''),
            };
            const res = await fetch(`/api/addendum/${encodeURIComponent(ba)}` , {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              const msg = await res.text().catch(()=> '');
              throw new Error(msg || 'Failed to save addendum');
            }
            // Refresh transactions map from processed outputs
            try {
              const txnsMap = await api.listTransactions();
              if (txnsMap && typeof txnsMap === 'object') setTransactionsByBA(txnsMap);
            } catch (_) {}
            setTxnOpen(false);
          } catch (err) {
            console.error(err);
            alert((err && err.message) || 'Failed to save');
          }
        };

        const onTxnDelete = async (ba, index) => {
          if (!confirm(`Delete transaction ${index}?`)) return;
          try {
            const current = transactionsByBA[ba] || [];
            if (current[index].tr_id) {
              alert('Cannot delete normalized rows');
              return;
            }
            const newRows = [ ...current.slice(0, index), ...current.slice(index + 1) ];
            await saveTxnRows(ba, newRows);
          } catch (err) {
            alert(err.message || 'Error');
          }
        };

        // Expose a global hook for other panels (e.g., Bank Rules) to request a Transactions table refresh
        const requestTransactionsReload = React.useCallback(async () => {
          try {
            const txnsMap = await api.listTransactions();
            if (txnsMap && typeof txnsMap === 'object') setTransactionsByBA(txnsMap);
          } catch (_) { /* ignore */ }
        }, []);
        React.useEffect(() => {
          try { window.requestTransactionsReload = requestTransactionsReload; } catch (_) {}
          return () => {
            try { if (window.requestTransactionsReload === requestTransactionsReload) delete window.requestTransactionsReload; } catch (_) {}
          };
        }, [requestTransactionsReload]);

        const [taxCatForm, setTaxCatForm] = useState({ category: '' });
        const [txTypeForm, setTxTypeForm] = useState({ transactiontype: '' });
        const [bankForm, setBankForm] = useState({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
        const [savingTaxCat, setSavingTaxCat] = useState(false);
        const [savingTxType, setSavingTxType] = useState(false);
        const [savingBank, setSavingBank] = useState(false);

        // Tabs state (persisted)
        const [topTab, setTopTab] = useState(() => {
          try { return window.localStorage.getItem('topTab') || 'setup'; } catch (_) { return 'setup'; }
        }); // 'setup' | 'classifyrules' | 'transactions' | 'rentalsummary' | 'companysummary' | 'report'
        const [setupTab, setSetupTab] = useState(() => {
          try { return window.localStorage.getItem('setupTab') || 'properties'; } catch (_) { return 'properties'; }
        }); // 'properties' | 'companies' | 'bankaccounts' | 'groups' | 'owners' | 'banks' | 'taxcats' | 'txtypes'

        const empty = { property: '', cost: 0, landValue: 0, renovation: 0, loanClosingCOst: 0, ownerCount: 1, purchaseDate: '', propMgmgtComp: '' };
        const [form, setForm] = useState(empty);
        const [saving, setSaving] = useState(false);

        const load = async () => {
          setError('');
          setLoading(true);
          try {
            const [data, comps, compRecs, bas, grps, ownrs, taxcats, txtypes, banksCfg, rules, txnsMap] = await Promise.all([
              api.list(),
              api.companies(),
              api.listCompanyRecords(),
              api.listBankaccounts(),
              api.listGroups(),
              api.listOwners(),
              api.listTaxCategories(),
              api.listTransactionTypes(),
              api.listBanks(),
              api.listClassifyRules(),
              api.listTransactions()
            ]);
            setItems(data);
            setCompanies(comps);
            setCompanyRecords(compRecs);
            setBankaccounts(bas);
            setGroups(grps);
            setOwners(ownrs);
            setTaxCategories(taxcats);
            setTransactionTypes(txtypes);
            setBanks(banksCfg);
            setClassifyRules(rules);
            // Processed transactions map: { [bankaccountname]: rows[] }
            if (txnsMap && typeof txnsMap === 'object') setTransactionsByBA(txnsMap);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => { load(); }, []);

        // RentalSummary state and loader
        const rentalEmptyFilters = { property:'', rent:'', commissions:'', insurance:'', proffees:'', mortgageinterest:'', repairs:'', tax:'', utilities:'', depreciation:'', hoa:'', other:'', costbasis:'', renteddays:'', profit:'' };
        const [rentalRows, setRentalRows] = useState([]);
        const [rentalLoading, setRentalLoading] = useState(false);
        const [rentalFilters, setRentalFilters] = useState(rentalEmptyFilters);
        const loadRentalSummary = React.useCallback(async ()=>{
          try {
            setRentalLoading(true);
            const rows = await api.listRentalSummary();
            setRentalRows(Array.isArray(rows) ? rows : []);
          } catch (e) {
            setRentalRows([]);
          } finally { setRentalLoading(false); }
        }, []);
        useEffect(() => { if (topTab === 'rentalsummary') loadRentalSummary(); }, [topTab, loadRentalSummary]);

        const isRSVerified = (row, field) => {
          try {
            const v = row && row._verified && row._verified[field];
            const cur = row && row[field];
            if (v == null || v === '') return false;
            return String(cur) === String(v);
          } catch(_) { return false; }
        };
        const verifyRSCell = async (row, field) => {
          try {
            if (!row || !row.property || field === 'property') return;
            const prop = String(row.property||'').toLowerCase();
            const curVal = row[field];
            if (curVal == null || String(curVal).toString().trim() === '') return; // do nothing when no value
            const verified = isRSVerified(row, field);
            let res;
            if (verified) {
              // Toggle off: remove from verified file
              res = await fetch('/api/rental-summary/verify', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ property: prop, field }) });
            } else {
              const payload = { property: prop, field, value: curVal };
              res = await fetch('/api/rental-summary/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            }
            if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'Failed to verify'); }
            await loadRentalSummary();
          } catch(e) { console.error(e); alert(e.message || 'Failed to verify'); }
        };

        // CompanySummary state and loader
        const companyEmptyFilters = { Name:'', income:'', rentpassedtoowners:'', bankfees:'', c_auto:'', c_donate:'', c_entertainment:'', c_internet:'', c_license:'', c_mobile:'', c_off_exp:'', c_parktoll:'', c_phone:'', c_website:'', ignore:'', insurane:'', proffees:'', utilities:'', profit:'' };
        const [companyRows, setCompanyRows] = useState([]);
        const [companyLoading, setCompanyLoading] = useState(false);
        const [companyFilters, setCompanyFilters] = useState(companyEmptyFilters);
        const loadCompanySummary = React.useCallback(async ()=>{
          try {
            setCompanyLoading(true);
            const rows = await api.listCompanySummary();
            setCompanyRows(Array.isArray(rows) ? rows : []);
          } catch (e) {
            setCompanyRows([]);
          } finally { setCompanyLoading(false); }
        }, []);

        const isCSVerified = (row, field) => {
          try {
            const v = row && row._verified && row._verified[field];
            const cur = row && row[field];
            if (v == null || v === '') return false;
            return String(cur) === String(v);
          } catch(_) { return false; }
        };
        const verifyCSCell = async (row, field) => {
          try {
            if (!row || !row.Name || field === 'Name') return;
            const curVal = row[field];
            if (curVal == null || String(curVal).toString().trim() === '') return;
            const name = String(row.Name||'');
            const verified = isCSVerified(row, field);
            let res;
            if (verified) {
              res = await fetch('/api/company-summary/verify', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ Name: name, field }) });
            } else {
              res = await fetch('/api/company-summary/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ Name: name, field, value: curVal }) });
            }
            if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'Failed to verify'); }
            await loadCompanySummary();
          } catch(e) { console.error(e); alert(e.message || 'Failed to verify'); }
        };
        useEffect(() => { if (topTab === 'companysummary') loadCompanySummary(); }, [topTab, loadCompanySummary]);

        // Persist tab selections
        useEffect(() => {
          try { window.localStorage.setItem('topTab', topTab); } catch (_) {}
        }, [topTab]);
        useEffect(() => {
          try { window.localStorage.setItem('setupTab', setupTab); } catch (_) {}
        }, [setupTab]);

        const onChange = (e) => {
          const { name, value } = e.target;
          if ([ 'cost','landValue','renovation','loanClosingCOst','ownerCount' ].includes(name)) {
            setForm({ ...form, [name]: Number(value || 0) });
          } else {
            setForm({ ...form, [name]: value });
          }
        };

        // Tax Categories handlers
        const onTaxCatChange = (e) => {
          const { name, value } = e.target;
          setTaxCatForm(prev => ({ ...prev, [name]: name === 'category' ? (value || '').trim().toLowerCase() : value }));
        };
        const onTaxCatSubmit = async (e) => {
          e.preventDefault(); setSavingTaxCat(true); setError('');
          try {
            const category = (taxCatForm.category || '').trim().toLowerCase();
            if (!category) throw new Error('category is required');
            await api.addTaxCategory({ category });
            setTaxCatForm({ category: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingTaxCat(false); }
        };
        const onTaxCatDelete = async (category) => {
          if (!confirm(`Delete ${category}?`)) return;
          try { await api.removeTaxCategory(category); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        // Transaction Types handlers
        const onTxTypeChange = (e) => {
          const { name, value } = e.target;
          setTxTypeForm(prev => ({ ...prev, [name]: name === 'transactiontype' ? (value || '').trim().toLowerCase() : value }));
        };
        const onTxTypeSubmit = async (e) => {
          e.preventDefault(); setSavingTxType(true); setError('');
          try {
            const transactiontype = (txTypeForm.transactiontype || '').trim().toLowerCase();
            if (!transactiontype) throw new Error('transactiontype is required');
            await api.addTransactionType({ transactiontype });
            setTxTypeForm({ transactiontype: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingTxType(false); }
        };
        const onTxTypeDelete = async (tt) => {
          if (!confirm(`Delete ${tt}?`)) return;
          try { await api.removeTransactionType(tt); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        // Banks handlers
        const onBankChange = (e) => {
          const { name, value } = e.target;
          setBankForm(prev => ({ ...prev, [name]: value }));
        };
        const onBankSubmit = async (e) => {
          e.preventDefault(); setSavingBank(true); setError('');
          try {
            const name = (bankForm.name || '').trim().toLowerCase();
            if (!name) throw new Error('name is required');
            const ignore_lines_contains = (bankForm.ignore_lines_contains || '')
              .split('|').map(s => s.trim()).filter(Boolean);
            const ignore_lines_startswith = (bankForm.ignore_lines_startswith || '')
              .split('|').map(s => s.trim()).filter(Boolean);
            let columns = [];
            if (bankForm.columnsText && bankForm.columnsText.trim()) {
              try { columns = JSON.parse(bankForm.columnsText); } catch (_) { columns = []; }
            }
            const payload = {
              name,
              date_format: bankForm.date_format || undefined,
              delim: bankForm.delim || undefined,
              ignore_lines_contains: ignore_lines_contains.length ? ignore_lines_contains : undefined,
              ignore_lines_startswith: ignore_lines_startswith.length ? ignore_lines_startswith : undefined,
              columns: columns.length ? columns : undefined,
            };
            await api.addBank(payload);
            setBankForm({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingBank(false); }
        };
        const onBankDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBank(name); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        const onSubmit = async (e) => {
          e.preventDefault();
          setSaving(true);
          setError('');
          try {
            if (!form.property) throw new Error('property is required');
            const payload = {
              ...form,
              property: (form.property || '').trim().toLowerCase(),
              purchaseDate: (form.purchaseDate || '').trim().toLowerCase(),
              propMgmgtComp: (form.propMgmgtComp || '').trim().toLowerCase(),
            };
            const created = await api.add(payload);
            setItems([ ...items, created ]);
            setForm(empty);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setSaving(false);
          }
        };

        const onDelete = async (id) => {
          if (!confirm(`Delete ${id}?`)) return;
          try {
            await api.remove(id);
            setItems(items.filter(x => x.property !== id));
          } catch (e) {
            alert(e.message || 'Error');
          }
        };

        // Company Records form
        const emptyCompany = { companyname: '', rentPercentage: 0 };
        const [companyForm, setCompanyForm] = useState(emptyCompany);
        const [savingCompany, setSavingCompany] = useState(false);

        const onCompanyChange = (e) => {
          const { name, value } = e.target;
          if (name === 'rentPercentage') {
            setCompanyForm({ ...companyForm, [name]: Number(value || 0) });
          } else if (name === 'companyname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            setCompanyForm({ ...companyForm, [name]: sanitized });
          } else {
            setCompanyForm({ ...companyForm, [name]: value });
          }
        };

        const onCompanySubmit = async (e) => {
          e.preventDefault();
          setSavingCompany(true);
          setError('');
          try {
            if (!companyForm.companyname) throw new Error('companyname is required');
            const payload = { ...companyForm, companyname: companyForm.companyname.trim().toLowerCase() };
            const created = await api.addCompanyRecord(payload);
            setCompanyRecords([ ...companyRecords, created ]);
            setCompanyForm(emptyCompany);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setSavingCompany(false);
          }
        };

        const onCompanyDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try {
            await api.removeCompanyRecord(name);
            setCompanyRecords(companyRecords.filter(x => x.companyname !== name));
          } catch (e) {
            alert(e.message || 'Error');
          }
        };

        // Bank account form
        const emptyBA = { bankaccountname: '', bankname: '' };
        const [baForm, setBaForm] = useState(emptyBA);
        const [savingBA, setSavingBA] = useState(false);
        const onBAChange = (e) => {
          const { name, value } = e.target;
          if (name === 'bankaccountname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setBaForm({ ...baForm, [name]: sanitized });
          } else if (name === 'bankname') {
            setBaForm({ ...baForm, [name]: (value || '').toLowerCase() });
          }
        };
        const onBASubmit = async (e) => {
          e.preventDefault(); setSavingBA(true); setError('');
          try {
            if (!baForm.bankaccountname || !baForm.bankname) throw new Error('bankaccountname and bankname are required');
            const created = await api.addBankaccount(baForm);
            setBankaccounts([ ...bankaccounts, created ]);
            setBaForm(emptyBA);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingBA(false); }
        };
        const onBADelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBankaccount(name); setBankaccounts(bankaccounts.filter(x => x.bankaccountname !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        // Group form
        const emptyGroup = { groupname: '', propertylist: '' };
        const [groupForm, setGroupForm] = useState(emptyGroup);
        const [savingGroup, setSavingGroup] = useState(false);
        const onGroupChange = (e) => {
          const { name, value } = e.target;
          if (name === 'groupname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setGroupForm({ ...groupForm, [name]: sanitized });
          } else {
            setGroupForm({ ...groupForm, [name]: value });
          }
        };
        const onGroupSubmit = async (e) => {
          e.preventDefault(); setSavingGroup(true); setError('');
          try {
            const payload = { groupname: groupForm.groupname, propertylist: (groupForm.propertylist || '').split('|').map(s=>s.trim().toLowerCase()).filter(Boolean) };
            if (!payload.groupname) throw new Error('groupname is required');
            const created = await api.addGroup(payload);
            setGroups([ ...groups, created ]);
            setGroupForm(emptyGroup);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingGroup(false); }
        };
        const onGroupDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeGroup(name); setGroups(groups.filter(x => x.groupname !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        // Owner form
        const emptyOwner = { name: '', bankaccounts: [], properties: [], companies: [] };
        const [ownerForm, setOwnerForm] = useState(emptyOwner);
        const [savingOwner, setSavingOwner] = useState(false);
        const onOwnerChange = (e) => {
          const { name, value } = e.target;
          if (name === 'name') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setOwnerForm({ ...ownerForm, [name]: sanitized });
          } else if (e.target.multiple) {
            const selected = Array.from(e.target.selectedOptions).map(o => (o.value || '').toLowerCase());
            setOwnerForm({ ...ownerForm, [name]: selected });
          } else {
            setOwnerForm({ ...ownerForm, [name]: value });
          }
        };
        const onOwnerSubmit = async (e) => {
          e.preventDefault(); setSavingOwner(true); setError('');
          try {
            if (!ownerForm.name) throw new Error('name is required');
            const payload = {
              name: ownerForm.name,
              bankaccounts: Array.from(new Set((ownerForm.bankaccounts || []).map(s => (s || '').toLowerCase()))),
              properties: Array.from(new Set((ownerForm.properties || []).map(s => (s || '').toLowerCase()))),
              companies: Array.from(new Set((ownerForm.companies || []).map(s => (s || '').toLowerCase()))),
            };
            const created = await api.addOwner(payload);
            setOwners([ ...owners, created ]);
            setOwnerForm(emptyOwner);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingOwner(false); }
        };
        const onOwnerDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeOwner(name); setOwners(owners.filter(x => x.name !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        const TabButton = ({ active, onClick, children }) => (
          <button type="button" onClick={onClick} className={`tab ${active ? 'active' : ''}`}>{children}</button>
        );

        const [exporting, setExporting] = useState(false);
        const handleExport = async () => {
          if (exporting) return;
          try {
            setExporting(true);
            const res = await fetch('/api/export-accounts', { method: 'POST' });
            if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'Export failed'); }
            const data = await res.json().catch(()=> ({}));
            alert(`Exported to: ${data && data.path ? data.path : 'file created'}`);
          } catch (e) {
            alert(e.message || 'Export failed');
          } finally {
            setExporting(false);
          }
        };

        return (
          <div className="container" style={{ position: 'relative' }}>
            <button
              type="button"
              onClick={handleExport}
              disabled={exporting}
              style={{ position: 'fixed', top: 12, right: 12, zIndex: 1000 }}
              className={`px-3 py-1 text-sm text-white rounded ${exporting ? 'bg-gray-500' : 'bg-blue-600 hover:bg-blue-700'}`}
            >{exporting ? 'Exporting' : 'Export'}</button>
            <h1>AccountSpy</h1>

            <div className="tabs">
              <TabButton active={topTab==='setup'} onClick={() => setTopTab('setup')}>Setup</TabButton>
              <TabButton active={topTab==='classifyrules'} onClick={() => setTopTab('classifyrules')}>ClassifyRules</TabButton>
              <TabButton active={topTab==='transactions'} onClick={() => setTopTab('transactions')}>Transactions</TabButton>
              <TabButton active={topTab==='rentalsummary'} onClick={() => setTopTab('rentalsummary')}>RentalSummary</TabButton>
              <TabButton active={topTab==='companysummary'} onClick={() => setTopTab('companysummary')}>CompanySummary</TabButton>
              <TabButton active={topTab==='report'} onClick={() => setTopTab('report')}>Report</TabButton>
            </div>

            {topTab === 'setup' && (
              <div className="tabcontent">
                <div className="actions" style={{ marginBottom: 12, flexWrap: 'wrap' }}>
                  <TabButton active={setupTab==='banks'} onClick={() => setSetupTab('banks')}>Banks</TabButton>
                  <TabButton active={setupTab==='bankaccounts'} onClick={() => setSetupTab('bankaccounts')}>Bank Accounts</TabButton>
                  <TabButton active={setupTab==='companies'} onClick={() => setSetupTab('companies')}>Company Records</TabButton>
                  <TabButton active={setupTab==='properties'} onClick={() => setSetupTab('properties')}>Properties</TabButton>
                  <TabButton active={setupTab==='groups'} onClick={() => setSetupTab('groups')}>Groups</TabButton>
                  <TabButton active={setupTab==='owners'} onClick={() => setSetupTab('owners')}>Owners</TabButton>
                  <TabButton active={setupTab==='taxcats'} onClick={() => setSetupTab('taxcats')}>Tax Categories</TabButton>
                  <TabButton active={setupTab==='txtypes'} onClick={() => setSetupTab('txtypes')}>Transaction Types</TabButton>
                </div>

                {setupTab === 'properties' && (
                  <PropertiesPanelExt items={items} companies={companies} loading={loading} reload={load} />
                )}

                {setupTab === 'companies' && (
                  <CompaniesPanelExt companyRecords={companyRecords} loading={loading} reload={load} />
                )}

                {setupTab === 'banks' && (
                  <BanksPanelExt banks={banks} loading={loading} reload={load} />
                )}

                {setupTab === 'taxcats' && (
                  <TaxCategoriesPanelExt taxCategories={taxCategories} loading={loading} reload={load} />
                )}

                {setupTab === 'txtypes' && (
                  <TransactionTypesPanelExt transactionTypes={transactionTypes} loading={loading} reload={load} />
                )}

                {setupTab === 'bankaccounts' && (
                  <BankAccountsPanelExt bankaccounts={bankaccounts} loading={loading} reload={load} banks={banks} />
                )}

                {setupTab === 'groups' && (
                  <GroupsPanelExt groups={groups} loading={loading} reload={load} items={items} />
                )}

                {setupTab === 'owners' && (
                  <OwnersPanelExt owners={owners} loading={loading} reload={load} bankaccounts={bankaccounts} items={items} companies={companies} />
                )}
              </div>
            )}

            {topTab === 'classifyrules' && (
              <div className="tabcontent">
                <ClassifyRulesTabs
                  classifyRules={classifyRules}
                  loading={loading}
                  load={load}
                  bankaccounts={bankaccounts}
                  items={items}
                  taxCategories={taxCategories}
                  transactionTypes={transactionTypes}
                />
              </div>
            )}

            {topTab === 'transactions' && (
              <div className="tabcontent">
                <div className="tabs" style={{ marginBottom: 12, display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                  {(bankaccounts || []).map(b => {
                    const name = b.bankaccountname || '';
                    return (
                      <button key={name} className={`tab ${txnBATab===name ? 'active' : ''}`} onClick={() => setTxnBATab(name)}>{name}</button>
                    );
                  })}
                </div>
                <div className="card">
                  {(() => {
                    const currentBA = (bankaccounts || []).find(b => (b.bankaccountname || '') === txnBATab);
                    if (!currentBA) return (<div className="muted">Select a bank account to view transactions.</div>);
                    const rows = transactionsByBA[txnBATab] || [];
                    return (
                      <div>
                        <div className="actions" style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                          <div className="muted">Transactions for: <strong>{currentBA.bankaccountname}</strong></div>
                          <div>
                            <span className="mr-3 text-gray-600">Total: {rows.length}</span>
                            <button type="button" onClick={onTxnAdd} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Transaction</button>
                          </div>
                        </div>
                        <Modal title={'Add Transaction'} open={txnOpen} onClose={() => setTxnOpen(false)} onSubmit={onTxnSubmit} submitLabel={txnSaving ? 'Saving...' : 'Save'} submitDisabled={!isTxnSaveEnabled}>
                          <form onSubmit={onTxnSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                              <label className="block text-sm font-medium text-gray-700">month</label>
                              <select name="month" value={txnMonth} onChange={(e)=> setTxnMonth(e.target.value)} className="mt-1 w-full border border-gray-300 rounded-md p-2">
                                <option value="01">JAN</option>
                                <option value="02">FEB</option>
                                <option value="03">MAR</option>
                                <option value="04">APR</option>
                                <option value="05">MAY</option>
                                <option value="06">JUN</option>
                                <option value="07">JUL</option>
                                <option value="08">AUG</option>
                                <option value="09">SEP</option>
                                <option value="10">OCT</option>
                                <option value="11">NOV</option>
                                <option value="12">DEC</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700">day</label>
                              <select name="day" value={txnDay} onChange={(e)=> setTxnDay(e.target.value)} className="mt-1 w-full border border-gray-300 rounded-md p-2">
                                {Array.from({length:31}, (_,i)=> String(i+1)).map(d => (
                                  <option key={d} value={d}>{d}</option>
                                ))}
                              </select>
                            </div>
                            <div className="md:col-span-2">
                              <label className="block text-sm font-medium text-gray-700">description</label>
                              <input name="description" value={txnForm.description} onChange={onTxnChange} className="mt-1 w-full border border-gray-300 rounded-md p-2" />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700">credit</label>
                              <input name="credit" type="number" step="any" value={txnForm.credit} onChange={onTxnChange} className="mt-1 w-full border border-gray-300 rounded-md p-2" />
                            </div>
                          </form>
                        </Modal>
                        {(() => { const filteredRows = (rows || []).filter(r => {
                          const f = txnFilters;
                          const keys = Object.keys(f);
                          for (let k of keys) {
                            const fv = (f[k] || '').toString().trim();
                            if (!fv) continue;
                            let rv = '';
                            if (k === 'pgc') {
                              rv = [r.property, r.group, r.company].map(x => (x == null ? '' : String(x))).join(' ').toLowerCase();
                            } else if (k === 'transaction_type') {
                              const t = (r.transaction_type == null ? '' : String(r.transaction_type));
                              rv = ((t.trim() ? t : 'empty')).toLowerCase();
                            } else {
                              rv = (r[k] == null ? '' : String(r[k])).toLowerCase();
                            }
                            if (!rv.includes(fv.toLowerCase())) return false;
                          }
                          return true;
                        });
                        return (
                        <table style={{ tableLayout: 'auto', width: '100%' }}>
                          <thead>
                            <tr>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>date</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>description</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>credit</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>ruleid</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>comment</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>transaction_type</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>tax_category</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>property/group/company</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>otherentity</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>actions</th>
                            </tr>
                            <tr>
                              <th><input name="date" value={txnFilters.date} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="description" value={txnFilters.description} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="credit" value={txnFilters.credit} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="ruleid" value={txnFilters.ruleid} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="comment" value={txnFilters.comment} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="transaction_type" value={txnFilters.transaction_type} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="tax_category" value={txnFilters.tax_category} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="pgc" value={txnFilters.pgc} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th><input name="otherentity" value={txnFilters.otherentity} onChange={onTxnFilterChange} className="w-full border border-gray-300 rounded-md p-1" placeholder="filter" /></th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody>
                            {filteredRows.length === 0 ? (
                              <tr><td colSpan="10" className="muted">No transactions</td></tr>
                            ) : (
                              filteredRows.map((r, idx) => (
                                <tr key={`txn-${idx}`}>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{r.date}</td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{r.description}</td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{r.credit}</td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>
                                    {r.ruleid ? (
                                      <a href="#" className="link" onClick={(e)=>{ e.preventDefault();
                                        try {
                                          window.localStorage.setItem('crSubTab','bank');
                                          window.localStorage.setItem('bankrules_active', (currentBA.bankaccountname||'').toLowerCase());
                                          window.localStorage.setItem('bankrules_filter_order', String(r.ruleid||''));
                                        } catch(_) {}
                                        setTopTab('classifyrules');
                                      }}>{r.ruleid}</a>
                                    ) : ''}
                                  </td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{r.comment}</td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{((r.transaction_type||'').trim() ? r.transaction_type : 'empty')}</td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{r.tax_category}</td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{(r.property||'') || (r.group||'') || (r.company||'')}</td>
                                  <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{r.otherentity}</td>
                                  <td>
                                    <div className="actions flex flex-col items-start gap-2">
                                      <div className="flex gap-2">
                                        <button type="button" className="px-2 py-1 bg-blue-700 text-white rounded hover:bg-blue-800" onClick={async()=>{ try {
                                          // ADD RULE: prefill from transaction row; insert order = server max_order
                                          const bank = (currentBA.bankaccountname||'').toLowerCase();
                                          let maxOrder = 0;
                                          try {
                                            const qsMO = new URLSearchParams({ bankaccountname: bank });
                                            const resMO = await fetch(`/api/bank-rules/max-order?${qsMO}`);
                                            if (resMO.ok) {
                                              const dataMO = await resMO.json();
                                              const mo = Number(dataMO && dataMO.max_order);
                                              if (Number.isFinite(mo) && mo >= 0) maxOrder = mo;
                                            }
                                          } catch(_) {}
                                          const patt = `desc_contains=${(r.description||'').toString()}`;
                                          const ordFromRow = (r.ruleid != null && String(r.ruleid).trim() !== '') ? Number(String(r.ruleid).trim()) : null;
                                          const insertOrder = (Number.isFinite(ordFromRow) && ordFromRow > 0) ? ordFromRow : (maxOrder + 1);
                                          window.localStorage.setItem('crSubTab','bank');
                                          window.localStorage.setItem('bankrules_active', bank);
                                          window.localStorage.setItem('bankrules_prefill_pattern', patt);
                                          window.localStorage.setItem('bankrules_prefill_order', String(insertOrder||''));
                                          window.localStorage.setItem('bankrules_prefill_credit', String(r.credit||''));
                                          window.localStorage.setItem('bankrules_prefill_ttype', String(r.transaction_type||''));
                                          window.localStorage.setItem('bankrules_prefill_tax', String(r.tax_category||''));
                                          window.localStorage.setItem('bankrules_prefill_property', String(r.property||''));
                                          window.localStorage.setItem('bankrules_prefill_group', String(r.group||''));
                                          window.localStorage.setItem('bankrules_prefill_company', String(r.company||''));
                                          window.localStorage.setItem('bankrules_prefill_otherentity', String(r.otherentity||''));
                                          window.localStorage.setItem('bankrules_prefill_force_add', '1');
                                          window.localStorage.setItem('bankrules_prefill_open', '1');
                                          setTopTab('classifyrules');
                                        } catch(_) {} }}>ADD_RULE</button>
                                        <button type="button" className="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800 disabled:opacity-60" disabled={!(r.ruleid != null && String(r.ruleid).trim() !== '')} onClick={async()=>{ try {
                                          const bank = (currentBA.bankaccountname||'').toLowerCase();
                                          const hasRuleId = (r.ruleid != null && String(r.ruleid).trim() !== '');
                                          let pref = null;
                                          if (hasRuleId) {
                                            try {
                                              const qs = new URLSearchParams({ bankaccountname: bank });
                                              const res = await fetch(`/api/bank-rules?${qs}`);
                                              if (res.ok) {
                                                const rules = await res.json();
                                                const rid = Number(String(r.ruleid).trim());
                                                if (Array.isArray(rules)) {
                                                  pref = rules.find(x => Number(x && x.order) === rid) || null;
                                                }
                                              }
                                            } catch(_) { /* ignore; will fallback */ }
                                          }
                                          // Set prefill from rule if found, else fallback to transaction row
                                          const isRule = !!pref;
                                          const pattern = isRule ? String(pref.pattern_match_logic||'') : `desc_contains=${(r.description||'').toString()}`;
                                          const orderStr = isRule ? String(pref.order||'') : ((r.ruleid != null && String(r.ruleid).trim() !== '') ? String(r.ruleid).trim() : '');
                                          const creditStr = isRule ? '' : String(r.credit||'');
                                          const ttype = isRule ? String(pref.transaction_type||'') : String(r.transaction_type||'');
                                          const tax = isRule ? String(pref.tax_category||'') : String(r.tax_category||'');
                                          const prop = isRule ? String(pref.property||'') : String(r.property||'');
                                          const grp = isRule ? String(pref.group||'') : String(r.group||'');
                                          const comp = isRule ? String(pref.company||'') : String(r.company||'');
                                          const other = isRule ? String(pref.otherentity||'') : String(r.otherentity||'');
                                          window.localStorage.setItem('crSubTab','bank');
                                          window.localStorage.setItem('bankrules_active', bank);
                                          window.localStorage.setItem('bankrules_prefill_pattern', pattern);
                                          window.localStorage.setItem('bankrules_prefill_order', orderStr);
                                          window.localStorage.setItem('bankrules_prefill_credit', creditStr);
                                          window.localStorage.setItem('bankrules_prefill_ttype', ttype);
                                          window.localStorage.setItem('bankrules_prefill_tax', tax);
                                          window.localStorage.setItem('bankrules_prefill_property', prop);
                                          window.localStorage.setItem('bankrules_prefill_group', grp);
                                          window.localStorage.setItem('bankrules_prefill_company', comp);
                                          window.localStorage.setItem('bankrules_prefill_otherentity', other);
                                          window.localStorage.setItem('bankrules_prefill_open', '1');
                                          setTopTab('classifyrules');
                                        } catch(_) {} }}>UPDATE_RULE</button>
                                      </div>
                                      <button type="button" className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-60" disabled={!r.fromaddendum} title={!r.fromaddendum ? 'Only addendum rows can be deleted' : 'Delete row'} onClick={async()=>{ try { const ba = txnBATab || ''; const res = await fetch(`/api/transactions/${encodeURIComponent(ba)}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(r) }); if (!res.ok) { const msg = await res.text().catch(()=> ''); throw new Error(msg || 'Failed to delete'); } await requestTransactionsReload(); } catch(e) { console.error(e); alert((e && e.message) || 'Failed to delete'); } }}>DEL</button>
                                    </div>
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                        ); })()}
                      </div>
                    );
                  })()}
                </div>
              </div>
            )}

            {topTab === 'companysummary' && (
              <div className="tabcontent">
                <div className="card">
                  {companyLoading ? (<div>Loading...</div>) : (
                    <div className="overflow-x-auto" style={{ overflowX: 'auto', maxWidth: '100%' }}>
                      {(() => { const rows = (companyRows||[]).filter(r => {
                        const f = companyFilters;
                        const keys = Object.keys(f);
                        for (let k of keys) {
                          const fv = (f[k] || '').toString().trim();
                          if (!fv) continue;
                          const rv = (r[k] == null ? '' : String(r[k])).toLowerCase();
                          if (!rv.includes(fv.toLowerCase())) return false;
                        }
                        return true;
                      });
                      return (
                        <table className="min-w-full" style={{ tableLayout: 'fixed', width: '100%' }}>
                          <thead>
                            <tr>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>Name</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>income</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>rentpassedtoowners</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>bankfees</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_auto</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_donate</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_entertainment</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_internet</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_license</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_mobile</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_off_exp</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_parktoll</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_phone</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>c_website</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>ignore</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>insurane</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>proffees</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>utilities</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>profit</th>
                            </tr>
                            <tr>
                              <th><input name="Name" value={companyFilters.Name} onChange={(e)=> setCompanyFilters(f=>({...f, Name: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="income" value={companyFilters.income} onChange={(e)=> setCompanyFilters(f=>({...f, income: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="rentpassedtoowners" value={companyFilters.rentpassedtoowners} onChange={(e)=> setCompanyFilters(f=>({...f, rentpassedtoowners: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="bankfees" value={companyFilters.bankfees} onChange={(e)=> setCompanyFilters(f=>({...f, bankfees: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_auto" value={companyFilters.c_auto} onChange={(e)=> setCompanyFilters(f=>({...f, c_auto: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_donate" value={companyFilters.c_donate} onChange={(e)=> setCompanyFilters(f=>({...f, c_donate: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_entertainment" value={companyFilters.c_entertainment} onChange={(e)=> setCompanyFilters(f=>({...f, c_entertainment: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_internet" value={companyFilters.c_internet} onChange={(e)=> setCompanyFilters(f=>({...f, c_internet: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_license" value={companyFilters.c_license} onChange={(e)=> setCompanyFilters(f=>({...f, c_license: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_mobile" value={companyFilters.c_mobile} onChange={(e)=> setCompanyFilters(f=>({...f, c_mobile: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_off_exp" value={companyFilters.c_off_exp} onChange={(e)=> setCompanyFilters(f=>({...f, c_off_exp: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_parktoll" value={companyFilters.c_parktoll} onChange={(e)=> setCompanyFilters(f=>({...f, c_parktoll: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_phone" value={companyFilters.c_phone} onChange={(e)=> setCompanyFilters(f=>({...f, c_phone: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="c_website" value={companyFilters.c_website} onChange={(e)=> setCompanyFilters(f=>({...f, c_website: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="ignore" value={companyFilters.ignore} onChange={(e)=> setCompanyFilters(f=>({...f, ignore: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="insurane" value={companyFilters.insurane} onChange={(e)=> setCompanyFilters(f=>({...f, insurane: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="proffees" value={companyFilters.proffees} onChange={(e)=> setCompanyFilters(f=>({...f, proffees: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="utilities" value={companyFilters.utilities} onChange={(e)=> setCompanyFilters(f=>({...f, utilities: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="profit" value={companyFilters.profit} onChange={(e)=> setCompanyFilters(f=>({...f, profit: e.target.value}))} placeholder="filter" /></th>
                            </tr>
                          </thead>
                          <tbody>
                            {rows.length === 0 ? (
                              <tr><td colSpan="19" className="muted">No rows</td></tr>
                            ) : rows.map((r, idx) => (
                              <tr key={`cs-${idx}`}>
                                <td style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>{r.Name}</td>
                                {['income','rentpassedtoowners','bankfees','c_auto','c_donate','c_entertainment','c_internet','c_license','c_mobile','c_off_exp','c_parktoll','c_phone','c_website','ignore','insurane','proffees','utilities','profit'].map((f,i)=> {
                                  const hasVal = (()=>{ const v = r[f]; return !(v == null || String(v).toString().trim() === ''); })();
                                  return (
                                    <td key={`cc-${i}`} className={`break-words whitespace-pre-wrap ${isCSVerified(r,f) ? 'bg-green-100' : ''}`}> 
                                      <div className="flex flex-col items-end gap-1">
                                        <span style={{ wordBreak:'break-word', whiteSpace:'pre-wrap' }} className="self-start">{r[f]}</span>
                                        <button
                                          type="button"
                                          disabled={!hasVal}
                                          title={hasVal ? (isCSVerified(r,f) ? 'Unverify' : 'Mark verified') : 'No value to verify'}
                                          className={`text-white rounded disabled:opacity-50 ${isCSVerified(r,f) ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-gray-500 hover:bg-gray-600'}`}
                                          style={{ width: '6px', height: '6px', padding: 0, display: 'inline-flex', alignItems: 'center', justifyContent: 'center', fontSize: '6px', lineHeight: '6px' }}
                                          onClick={()=> verifyCSCell(r, f)}
                                        ></button>
                                      </div>
                                    </td>
                                  );
                                })}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      ); })()}
                    </div>
                  )}
                </div>
              </div>
            )}

            {topTab === 'rentalsummary' && (
              <div className="tabcontent">
                <div className="card">
                  {rentalLoading ? (<div>Loading...</div>) : (
                    <div className="overflow-x-auto" style={{ overflowX: 'auto', maxWidth: '100%' }}>
                      {(() => { const rows = (rentalRows||[]).filter(r => {
                        const f = rentalFilters;
                        const keys = Object.keys(f);
                        for (let k of keys) {
                          const fv = (f[k] || '').toString().trim();
                          if (!fv) continue;
                          const rv = (r[k] == null ? '' : String(r[k])).toLowerCase();
                          if (!rv.includes(fv.toLowerCase())) return false;
                        }
                        return true;
                      });
                      return (
                        <table className="min-w-full" style={{ tableLayout: 'fixed' }}>
                          <thead>
                            <tr>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>property</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>rent</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>commissions</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>insurance</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>proffees</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>mortgageinterest</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>repairs</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>tax</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>utilities</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>depreciation</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>hoa</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>other</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>costbasis</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>renteddays</th>
                              <th style={{ whiteSpace: 'normal', wordBreak: 'break-word' }}>profit</th>
                            </tr>
                            <tr>
                              <th><input name="property" value={rentalFilters.property} onChange={(e)=> setRentalFilters(f=>({...f, property: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="rent" value={rentalFilters.rent} onChange={(e)=> setRentalFilters(f=>({...f, rent: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="commissions" value={rentalFilters.commissions} onChange={(e)=> setRentalFilters(f=>({...f, commissions: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="insurance" value={rentalFilters.insurance} onChange={(e)=> setRentalFilters(f=>({...f, insurance: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="proffees" value={rentalFilters.proffees} onChange={(e)=> setRentalFilters(f=>({...f, proffees: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="mortgageinterest" value={rentalFilters.mortgageinterest} onChange={(e)=> setRentalFilters(f=>({...f, mortgageinterest: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="repairs" value={rentalFilters.repairs} onChange={(e)=> setRentalFilters(f=>({...f, repairs: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="tax" value={rentalFilters.tax} onChange={(e)=> setRentalFilters(f=>({...f, tax: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="utilities" value={rentalFilters.utilities} onChange={(e)=> setRentalFilters(f=>({...f, utilities: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="depreciation" value={rentalFilters.depreciation} onChange={(e)=> setRentalFilters(f=>({...f, depreciation: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="hoa" value={rentalFilters.hoa} onChange={(e)=> setRentalFilters(f=>({...f, hoa: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="other" value={rentalFilters.other} onChange={(e)=> setRentalFilters(f=>({...f, other: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="costbasis" value={rentalFilters.costbasis} onChange={(e)=> setRentalFilters(f=>({...f, costbasis: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="renteddays" value={rentalFilters.renteddays} onChange={(e)=> setRentalFilters(f=>({...f, renteddays: e.target.value}))} placeholder="filter" /></th>
                              <th><input name="profit" value={rentalFilters.profit} onChange={(e)=> setRentalFilters(f=>({...f, profit: e.target.value}))} placeholder="filter" /></th>
                            </tr>
                          </thead>
                          <tbody>
                            {rows.length === 0 ? (
                              <tr><td colSpan="15" className="muted">No rows</td></tr>
                            ) : rows.map((r, idx) => (
                              <tr key={`rs-${idx}`}>
                                <td className="break-words whitespace-pre-wrap">{r.property}</td>
                                {['rent','commissions','insurance','proffees','mortgageinterest','repairs','tax','utilities','depreciation','hoa','other','costbasis','renteddays','profit'].map((f,i)=> {
                                  const hasVal = (()=>{ const v = r[f]; return !(v == null || String(v).toString().trim() === ''); })();
                                  return (
                                    <td key={`c-${i}`} className={`break-words whitespace-pre-wrap ${isRSVerified(r,f) ? 'bg-green-100' : ''}`}> 
                                      <div className="flex flex-col items-end gap-1">
                                        <span style={{ wordBreak:'break-word', whiteSpace:'pre-wrap' }} className="self-start">{r[f]}</span>
                                        <button
                                          type="button"
                                          disabled={!hasVal}
                                          title={hasVal ? (isRSVerified(r,f) ? 'Unverify' : 'Mark verified') : 'No value to verify'}
                                          className={`text-white rounded disabled:opacity-50 ${isRSVerified(r,f) ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-gray-500 hover:bg-gray-600'}`}
                                          style={{ width: '6px', height: '6px', padding: 0, display: 'inline-flex', alignItems: 'center', justifyContent: 'center', fontSize: '6px', lineHeight: '6px' }}
                                          onClick={()=> verifyRSCell(r, f)}
                                        ></button>
                                      </div>
                                    </td>
                                  );
                                })}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      ); })()}
                    </div>
                  )}
                </div>
              </div>
            )}

            {topTab === 'report' && (
              <div className="tabcontent"><div className="muted">Report UI coming soon.</div></div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
