<!doctype html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/index.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Properties</title>
    <link rel="preconnect" href="https://unpkg.com" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #f7f7f8; }
      .container { max-width: 960px; margin: 0 auto; }
      h1 { margin-top: 0; }
      table { width: 100%; border-collapse: collapse; background: #fff; }
      th, td { padding: 8px 10px; border: 1px solid #e5e7eb; font-size: 14px; }
      th { background: #f3f4f6; text-align: left; }
      .card { background: #fff; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 16px; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; }
      .row .col { flex: 1 1 200px; min-width: 200px; }
      input, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
      button { padding: 10px 14px; border: 0; background: #111827; color: #fff; border-radius: 6px; cursor: pointer; }
      button:disabled { background: #6b7280; cursor: not-allowed; }
      .actions { display: flex; gap: 8px; }
      .muted { color: #6b7280; font-size: 13px; }
      .error { color: #b91c1c; }
      /* Tabbed pane styles */
      .tabs { display: flex; gap: 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 0; }
      .tab { appearance: none; background: transparent; border: 0; border-bottom: 2px solid transparent; color: #6b7280; padding: 10px 14px; margin: 0; cursor: pointer; border-top-left-radius: 8px; border-top-right-radius: 8px; }
      .tab:hover { color: #111827; }
      .tab.active { color: #111827; border-bottom-color: #111827; font-weight: 600; }
      .tabcontent { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: -1px; }
      /* Link style */
      a.link { color: #2563eb; text-decoration: underline; cursor: pointer; }
      a.link:hover { color: #1d4ed8; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="text/babel" src="/components/api.jsx"></script>
    <script type="text/babel" src="/components/Modal.jsx"></script>
    <script type="text/babel" src="/components/Confirm.jsx"></script>
    <script type="text/babel" src="/components/MultiSelect.jsx"></script>
    <script type="text/babel" src="/components/BankRulesTabs.jsx"></script>
    <script type="text/babel" src="/components/ClassifyRulesTabs.jsx"></script>
    <script type="text/babel" src="/components/ClassifyRulesPanel.jsx"></script>
    <!-- External Panels loaded via Babel -->
    <script type="text/babel" src="/components/PropertiesPanel.jsx"></script>
    <script type="text/babel" src="/components/CompaniesPanel.jsx"></script>
    <script type="text/babel" src="/components/BankAccountsPanel.jsx"></script>
    <script type="text/babel" src="/components/GroupsPanel.jsx"></script>
    <script type="text/babel" src="/components/OwnersPanel.jsx"></script>
    <script type="text/babel" src="/components/BanksPanel.jsx"></script>
    <script type="text/babel" src="/components/TaxCategoriesPanel.jsx"></script>
    <script type="text/babel" src="/components/TransactionTypesPanel.jsx"></script>
    <script type="text/babel" src="/components/TransactionsPanel.jsx"></script>
    <script type="text/babel" src="/components/RentTrackerPanel.jsx"></script>
    <script type="text/babel" src="/components/CompanySummaryPanel.jsx"></script>
    <script type="text/babel" src="/components/RentalSummaryPanel.jsx"></script>

    <script type="text/babel">
      const { useEffect, useState } = React;

      // inline panel implementations (CompaniesPanel, BankAccountsPanel, GroupsPanel, OwnersPanel,
      // PropertiesPanel, TaxCategoriesPanel, TransactionTypesPanel, BanksPanel) have been removed,
      // since the app now uses the corresponding *PanelExt components from /components/*.jsx.

      function App() {
        const [items, setItems] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');
        const [companies, setCompanies] = useState([]);
        const [companyRecords, setCompanyRecords] = useState([]);
        const [bankaccounts, setBankaccounts] = useState([]);
        const [groups, setGroups] = useState([]);
        // Local fallback cache for groups specifically for modals that may open before groups load
        const [inheritGroupsData, setInheritGroupsData] = useState([]);
        useEffect(() => { setInheritGroupsData(groups || []); }, [groups]);
        useEffect(() => {
          if (!groups || groups.length === 0) {
            try { api.listGroups().then(gs => { if (Array.isArray(gs)) setInheritGroupsData(gs); }).catch(()=>{}); } catch (_) {}
          }
        }, []);
        const [owners, setOwners] = useState([]);
        const [taxCategories, setTaxCategories] = useState([]);
        const [transactionTypes, setTransactionTypes] = useState([]);
        const [banks, setBanks] = useState([]);
        const [classifyRules, setClassifyRules] = useState([]);
        // Settings: prepare year selection state
        const [prepYear, setPrepYear] = useState(() => {
          try { return window.localStorage.getItem('currentYearSelect') || (window.current_year || ''); } catch(_) { return (window.current_year || ''); }
        });
        useEffect(() => {
          try { window.localStorage.setItem('currentYearSelect', prepYear || ''); } catch(_) {}
        }, [prepYear]);
        // Transactions subtabs state (per bankaccount)
        const [txnBATab, setTxnBATab] = useState(() => {
          try { return window.localStorage.getItem('txnBATab') || ''; } catch(_) { return ''; }
        });
        useEffect(() => {
          if (!txnBATab && (bankaccounts || []).length > 0) {
            setTxnBATab((bankaccounts[0].bankaccountname || ''));
          }
        }, [txnBATab, bankaccounts]);
        useEffect(() => {
          try { window.localStorage.setItem('txnBATab', txnBATab || ''); } catch(_) {}
        }, [txnBATab]);
        // Local per-account transactions state (placeholder until backend wiring)
        const [transactionsByBA, setTransactionsByBA] = useState({});
        const [currentYear, setCurrentYear] = useState('');
        const [txnMonth, setTxnMonth] = useState('12');
        const [txnDay, setTxnDay] = useState('31');
        const [txnOpen, setTxnOpen] = useState(false);
        const [txnSaving, setTxnSaving] = useState(false);
        const emptyTxn = { tr_id: '', date: '', description: '', credit: '', ruleid: '', comment: '', transaction_type: '', tax_category: '', property: '', group: '', company: '', otherentity: '', override: '' };
        const [txnForm, setTxnForm] = useState(emptyTxn);
        const [txnFilters, setTxnFilters] = useState({ tr_id: '', date: '', description: '', credit: '', ruleid: '', comment: '', transaction_type: '', tax_category: '', pgc: '', property: '', group: '', company: '', otherentity: '', override: '' });
        const onTxnChange = (e) => {
          const { name, value } = e.target;
          const v = name === 'description' ? (value || '').toLowerCase() : value;
          setTxnForm(prev => ({ ...prev, [name]: v }));
        };
        const onTxnFilterChange = (e) => {
          const { name, value } = e.target;
          setTxnFilters(prev => ({ ...prev, [name]: value }));
        };
        const onTxnAdd = async () => {
          setTxnForm(emptyTxn);
          setTxnMonth('12');
          setTxnDay('31');
          try {
            const res = await fetch('/api/transactions/config');
            if (res.ok) {
              const j = await res.json();
              setCurrentYear(String(j.current_year || ''));
            }
          } catch (_) {}
          setTxnOpen(true);
        };

        // Load CURRENT_YEAR for date validation
        useEffect(() => {
          (async () => {
            try {
              const res = await fetch('/api/transactions/config');
              if (!res.ok) return;
              const j = await res.json();
              setCurrentYear(String(j.current_year || ''));
            } catch (_) {}
          })();
        }, []);

        const isValidTxnDate = () => {
          if (!currentYear) return false;
          const m = Number(txnMonth);
          const d = Number(txnDay);
          if (!Number.isInteger(m) || m < 1 || m > 12) return false;
          if (!Number.isInteger(d) || d < 1 || d > 31) return false;
          return true;
        };
        const isValidCredit = (c) => {
          if (c == null) return false;
          const s = String(c).trim();
          if (!s) return false;
          const n = Number(s);
          return Number.isFinite(n);
        };
        const isTxnSaveEnabled = (
          isValidTxnDate() &&
          String(txnForm.description || '').trim().length > 0 &&
          isValidCredit(txnForm.credit)
        );
        const saveTxnRows = async (ba, newRows) => {
          setTxnSaving(true);
          try {
            const res = await fetch(`/api/transactions/${encodeURIComponent(ba)}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rows: newRows }) });
            if (!res.ok) {
              const msg = await res.text().catch(()=> '');
              throw new Error(msg || 'Failed to save');
            }
            setTransactionsByBA(prev => ({ ...prev, [ba]: newRows }));
          } finally { setTxnSaving(false); }
        };

        const onTxnSubmit = async (e) => {
          e.preventDefault();
          try {
            const ba = txnBATab || '';
            if (!ba) throw new Error('Select a bank account');
            const mm = String(txnMonth).padStart(2,'0');
            const dd = String(txnDay).padStart(2,'0');
            const payload = {
              date: `${String(currentYear)}-${mm}-${dd}`,
              description: (txnForm.description || ''),
              credit: (txnForm.credit || ''),
            };
            const res = await fetch(`/api/addendum/${encodeURIComponent(ba)}` , {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              const msg = await res.text().catch(()=> '');
              throw new Error(msg || 'Failed to save addendum');
            }
            // Refresh transactions map from processed outputs
            try {
              const txnsMap = await api.listTransactions();
              if (txnsMap && typeof txnsMap === 'object') setTransactionsByBA(txnsMap);
            } catch (_) {}
            setTxnOpen(false);
          } catch (err) {
            console.error(err);
            alert((err && err.message) || 'Failed to save');
          }
        };

        const onTxnDelete = async (ba, index) => {
          if (!confirm(`Delete transaction ${index}?`)) return;
          try {
            const current = transactionsByBA[ba] || [];
            if (current[index].tr_id) {
              alert('Cannot delete normalized rows');
              return;
            }
            const newRows = [ ...current.slice(0, index), ...current.slice(index + 1) ];
            await saveTxnRows(ba, newRows);
          } catch (err) {
            alert(err.message || 'Error');
          }
        };

        // Expose a global hook for other panels (e.g., Bank Rules) to request a Transactions table refresh
        const requestTransactionsReload = React.useCallback(async () => {
          try {
            const txnsMap = await api.listTransactions();
            if (txnsMap && typeof txnsMap === 'object') setTransactionsByBA(txnsMap);
          } catch (_) { /* ignore */ }
        }, []);
        React.useEffect(() => {
          try { window.requestTransactionsReload = requestTransactionsReload; } catch (_) {}
          return () => {
            try { if (window.requestTransactionsReload === requestTransactionsReload) delete window.requestTransactionsReload; } catch (_) {}
          };
        }, [requestTransactionsReload]);

        const [taxCatForm, setTaxCatForm] = useState({ category: '' });
        const [txTypeForm, setTxTypeForm] = useState({ transactiontype: '' });
        const [bankForm, setBankForm] = useState({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
        const [savingTaxCat, setSavingTaxCat] = useState(false);
        const [savingTxType, setSavingTxType] = useState(false);
        const [savingBank, setSavingBank] = useState(false);

        // Tabs state (persisted + initialized from URL)
        const [topTab, setTopTab] = useState(() => {
          try {
            const path = (window.location && window.location.pathname) || '/';
            if (path.startsWith('/setup')) return 'setup';
            if (path.startsWith('/classifyrules')) return 'classifyrules';
            if (path.startsWith('/transactions')) return 'transactions';
            if (path.startsWith('/renttracker')) return 'renttracker';
            if (path.startsWith('/rentalsummary')) return 'rentalsummary';
            if (path.startsWith('/companysummary')) return 'companysummary';
            if (path.startsWith('/report')) return 'report';
            return window.localStorage.getItem('topTab') || 'setup';
          } catch (_) {
            return 'setup';
          }
        }); // 'setup' | 'classifyrules' | 'transactions' | 'renttracker' | 'rentalsummary' | 'companysummary' | 'report'

        const [setupTab, setSetupTab] = useState(() => {
          try {
            const path = (window.location && window.location.pathname) || '/';
            if (path.startsWith('/setup/')) {
              const slug = path.split('/')[2] || '';
              if (slug === 'settings') return 'settings';
              if (slug === 'banks') return 'banks';
              if (slug === 'bankaccounts') return 'bankaccounts';
              if (slug === 'companies') return 'companies';
              if (slug === 'properties') return 'properties';
              if (slug === 'groups') return 'groups';
              if (slug === 'owners') return 'owners';
              if (slug === 'taxcats') return 'taxcats';
              if (slug === 'txtypes') return 'txtypes';
            }
            return window.localStorage.getItem('setupTab') || 'properties';
          } catch (_) {
            return 'properties';
          }
        });
 // 'properties' | 'companies' | 'bankaccounts' | 'groups' | 'owners' | 'banks' | 'taxcats' | 'txtypes'

        // --- Simple URL routing for tabs/subtabs ---
        const slugToSetup = (s) => ({
          settings:'settings',
          properties:'properties', companies:'companies', bankaccounts:'bankaccounts', groups:'groups', owners:'owners', banks:'banks', taxcats:'taxcats', txtypes:'txtypes'
        })[s] || 'properties';
        const setupToSlug = (s) => ({
          settings:'settings',
          properties:'properties', companies:'companies', bankaccounts:'bankaccounts', groups:'groups', owners:'owners', banks:'banks', taxcats:'taxcats', txtypes:'txtypes'
        })[s] || 'properties';
        const crSlugToSub = (s) => ({ bankrules:'bank', common:'common', inherit:'inherit' })[s] || 'bank';
        const crSubToSlug = (s) => ({ bank:'bankrules', common:'common', inherit:'inherit' })[s] || 'bankrules';

        const applyRouteFromPath = React.useCallback(() => {
          try {
            const raw = (window.location && window.location.pathname) || '/';
            const parts = raw.replace(/^\/+|\/+$/g,'').split('/');
            const p0 = (parts[0]||'').toLowerCase();
            const p1 = (parts[1]||'').toLowerCase();
            if (p0 === 'setup') {
              setTopTab('setup');
              if (p1) setSetupTab(slugToSetup(p1));
              return;
            }
            if (p0 === 'classifyrules') {
              setTopTab('classifyrules');
              const sub = crSlugToSub(p1);
              try { window.localStorage.setItem('crSubTab', sub); } catch(_) {}
              return;
            }
            if (p0 === 'transactions') { setTopTab('transactions'); return; }
            if (p0 === 'rentalsummary') { setTopTab('rentalsummary'); return; }
            if (p0 === 'companysummary') { setTopTab('companysummary'); return; }
            if (p0 === 'report') { setTopTab('report'); return; }
          } catch (_) {}
        }, [setTopTab, setSetupTab]);

        useEffect(() => {
          // On initial load, derive state from URL
          applyRouteFromPath();
          const onPop = () => applyRouteFromPath();
          window.addEventListener('popstate', onPop);
          return () => window.removeEventListener('popstate', onPop);
        }, [applyRouteFromPath]);

        const pushRouteForState = React.useCallback(() => {
          try {
            let path = '/';
            if (topTab === 'setup') {
              path = `/setup/${setupToSlug(setupTab)}`;
            } else if (topTab === 'classifyrules') {
              let sub = 'bank';
              try { sub = window.localStorage.getItem('crSubTab') || 'bank'; } catch(_) {}
              path = `/classifyrules/${crSubToSlug(sub)}`;
            } else if (topTab === 'transactions') {
              path = '/transactions';
            } else if (topTab === 'renttracker') {
              path = '/renttracker';
            } else if (topTab === 'rentalsummary') {
              path = '/rentalsummary';
            } else if (topTab === 'companysummary') {
              path = '/companysummary';
            } else if (topTab === 'report') {
              path = '/report';
            }
            if ((window.location && window.location.pathname) !== path) {
              window.history.pushState(null, '', path);
            }
          } catch (_) {}
        }, [topTab, setupTab]);

        // When tab state changes, push URL
        useEffect(() => { pushRouteForState(); }, [topTab, setupTab, pushRouteForState]);

        const empty = { property: '', cost: 0, landValue: 0, renovation: 0, loanClosingCost: 0, ownerCount: 1, purchaseDate: '', propMgmtComp: '' };
        const [form, setForm] = useState(empty);
        const [saving, setSaving] = useState(false);

        const load = async () => {
          setError('');
          setLoading(true);
          try {
            const [data, comps, compRecs, bas, grps, ownrs, taxcats, txtypes, banksCfg, rules, txnsMap] = await Promise.all([
              api.list(),
              api.companies(),
              api.listCompanyRecords(),
              api.listBankaccounts(),
              api.listGroups(),
              api.listOwners(),
              api.listTaxCategories(),
              api.listTransactionTypes(),
              api.listBanks(),
              api.listClassifyRules(),
              api.listTransactions()
            ]);
            setItems(data);
            setCompanies(comps);
            setCompanyRecords(compRecs);
            setBankaccounts(bas);
            setGroups(grps);
            setOwners(ownrs);
            setTaxCategories(taxcats);
            setTransactionTypes(txtypes);
            setBanks(banksCfg);
            setClassifyRules(rules);
            // Processed transactions map: { [bankaccountname]: rows[] }
            if (txnsMap && typeof txnsMap === 'object') setTransactionsByBA(txnsMap);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => { load(); }, []);

        // RentalSummary state and loader
        const rentalEmptyFilters = { property:'', rent:'', commissions:'', insurance:'', proffees:'', mortgageinterest:'', repairs:'', tax:'', utilities:'', depreciation:'', hoa:'', other:'', costbasis:'', renteddays:'', profit:'' };
        const [rentalRows, setRentalRows] = useState([]);
        const [rentalLoading, setRentalLoading] = useState(false);
        const [rentalFilters, setRentalFilters] = useState(rentalEmptyFilters);
        const loadRentalSummary = React.useCallback(async ()=>{
          try {
            setRentalLoading(true);
            const rows = await api.listRentalSummary();
            setRentalRows(Array.isArray(rows) ? rows : []);
          } catch (e) {
            setRentalRows([]);
          } finally { setRentalLoading(false); }
        }, []);
        useEffect(() => { if (topTab === 'rentalsummary') loadRentalSummary(); }, [topTab, loadRentalSummary]);

        // Rent tracker state (per-property monthly rent)
        const [rentTrackerRows, setRentTrackerRows] = useState([]);
        const [rentTrackerLoading, setRentTrackerLoading] = useState(false);
        const loadRentTracker = React.useCallback(async () => {
          try {
            setRentTrackerLoading(true);
            const rows = await api.listRentTracker();
            setRentTrackerRows(Array.isArray(rows) ? rows : []);
          } catch (e) {
            console.error(e);
            setRentTrackerRows([]);
          } finally {
            setRentTrackerLoading(false);
          }
        }, []);
        useEffect(() => { if (topTab === 'renttracker') loadRentTracker(); }, [topTab, loadRentTracker]);

        const isRSVerified = (row, field) => {
          try {
            const v = row && row._verified && row._verified[field];
            const cur = row && row[field];
            // If verified value is explicitly empty string, consider verified when current field is missing/empty
            if (v === '') {
              if (cur == null) return true;
              const cs = String(cur).toString().trim();
              return cs === '';
            }
            if (v == null) return false;
            return String(cur) === String(v);
          } catch(_) { return false; }
        };
        const verifyRSCell = async (row, field) => {
          try {
            if (!row || !row.property || field === 'property') return;
            const prop = String(row.property||'').toLowerCase();
            const curVal = row[field];
            const verified = isRSVerified(row, field);
            let res;
            if (verified) {
              // Toggle off: remove from verified file
              res = await fetch('/api/rental-summary/verify', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ property: prop, field }) });
            } else {
              const payload = { property: prop, field, value: curVal };
              res = await fetch('/api/rental-summary/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            }
            if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'Failed to verify'); }
            await loadRentalSummary();
          } catch(e) { console.error(e); alert(e.message || 'Failed to verify'); }
        };

        // CompanySummary state and loader
        const companyEmptyFilters = { Name:'', income:'', rentpassedtoowners:'', bankfees:'', c_auto:'', c_donate:'', c_entertainment:'', c_internet:'', c_license:'', c_mobile:'', c_off_exp:'', c_parktoll:'', c_phone:'', c_website:'', ignore:'', insurane:'', proffees:'', utilities:'', profit:'' };
        const [companyRows, setCompanyRows] = useState([]);
        const [companyLoading, setCompanyLoading] = useState(false);
        const [companyFilters, setCompanyFilters] = useState(companyEmptyFilters);
        const loadCompanySummary = React.useCallback(async ()=>{
          try {
            setCompanyLoading(true);
            const rows = await api.listCompanySummary();
            setCompanyRows(Array.isArray(rows) ? rows : []);
          } catch (e) {
            setCompanyRows([]);
          } finally { setCompanyLoading(false); }
        }, []);

        const isCSVerified = (row, field) => {
          try {
            const v = row && row._verified && row._verified[field];
            const cur = row && row[field];
            // Mirror property summary behavior: allow verifying as empty
            if (v === '') {
              if (cur == null) return true;
              const cs = String(cur).toString().trim();
              return cs === '';
            }
            if (v == null) return false;
            return String(cur) === String(v);
          } catch(_) { return false; }
        };
        const verifyCSCell = async (row, field) => {
          try {
            if (!row || !row.Name || field === 'Name') return;
            const curVal = row[field];
            const name = String(row.Name||'');
            const verified = isCSVerified(row, field);
            let res;
            if (verified) {
              res = await fetch('/api/company-summary/verify', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ Name: name, field }) });
            } else {
              const payload = { Name: name, field, value: (curVal == null ? '' : curVal) };
              res = await fetch('/api/company-summary/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            }
            if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'Failed to verify'); }
            await loadCompanySummary();
          } catch(e) { console.error(e); alert(e.message || 'Failed to verify'); }
        };
        useEffect(() => { if (topTab === 'companysummary') loadCompanySummary(); }, [topTab, loadCompanySummary]);

        // Persist tab selections
        useEffect(() => {
          try { window.localStorage.setItem('topTab', topTab); } catch (_) {}
        }, [topTab]);
        useEffect(() => {
          try { window.localStorage.setItem('setupTab', setupTab); } catch (_) {}
        }, [setupTab]);

        const onChange = (e) => {
          const { name, value } = e.target;
          if ([ 'cost','landValue','renovation','loanClosingCost','ownerCount' ].includes(name)) {
            setForm({ ...form, [name]: Number(value || 0) });
          } else {
            setForm({ ...form, [name]: value });
          }
        };

        // Tax Categories handlers
        const onTaxCatChange = (e) => {
          const { name, value } = e.target;
          setTaxCatForm(prev => ({ ...prev, [name]: name === 'category' ? (value || '').trim().toLowerCase() : value }));
        };
        const onTaxCatSubmit = async (e) => {
          e.preventDefault(); setSavingTaxCat(true); setError('');
          try {
            const category = (taxCatForm.category || '').trim().toLowerCase();
            if (!category) throw new Error('category is required');
            await api.addTaxCategory({ category });
            setTaxCatForm({ category: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingTaxCat(false); }
        };
        const onTaxCatDelete = async (category) => {
          if (!confirm(`Delete ${category}?`)) return;
          try { await api.removeTaxCategory(category); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        // Transaction Types handlers
        const onTxTypeChange = (e) => {
          const { name, value } = e.target;
          setTxTypeForm(prev => ({ ...prev, [name]: name === 'transactiontype' ? (value || '').trim().toLowerCase() : value }));
        };
        const onTxTypeSubmit = async (e) => {
          e.preventDefault(); setSavingTxType(true); setError('');
          try {
            const transactiontype = (txTypeForm.transactiontype || '').trim().toLowerCase();
            if (!transactiontype) throw new Error('transactiontype is required');
            await api.addTransactionType({ transactiontype });
            setTxTypeForm({ transactiontype: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingTxType(false); }
        };
        const onTxTypeDelete = async (tt) => {
          if (!confirm(`Delete ${tt}?`)) return;
          try { await api.removeTransactionType(tt); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        // Banks handlers
        const onBankChange = (e) => {
          const { name, value } = e.target;
          setBankForm(prev => ({ ...prev, [name]: value }));
        };
        const onBankSubmit = async (e) => {
          e.preventDefault(); setSavingBank(true); setError('');
          try {
            const name = (bankForm.name || '').trim().toLowerCase();
            if (!name) throw new Error('name is required');
            const ignore_lines_contains = (bankForm.ignore_lines_contains || '')
              .split('|').map(s => s.trim()).filter(Boolean);
            const ignore_lines_startswith = (bankForm.ignore_lines_startswith || '')
              .split('|').map(s => s.trim()).filter(Boolean);
            let columns = [];
            if (bankForm.columnsText && bankForm.columnsText.trim()) {
              try { columns = JSON.parse(bankForm.columnsText); } catch (_) { columns = []; }
            }
            const payload = {
              name,
              date_format: bankForm.date_format || undefined,
              delim: bankForm.delim || undefined,
              ignore_lines_contains: ignore_lines_contains.length ? ignore_lines_contains : undefined,
              ignore_lines_startswith: ignore_lines_startswith.length ? ignore_lines_startswith : undefined,
              columns: columns.length ? columns : undefined,
            };
            await api.addBank(payload);
            setBankForm({ name: '', date_format: '', delim: '', ignore_lines_contains: '', ignore_lines_startswith: '', columnsText: '' });
            await load();
          } catch (err) { setError(err.message || 'Error'); } finally { setSavingBank(false); }
        };
        const onBankDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBank(name); await load(); } catch (err) { alert(err.message || 'Error'); }
        };

        const onSubmit = async (e) => {
          e.preventDefault();
          setSaving(true);
          setError('');
          try {
            if (!form.property) throw new Error('property is required');
            const payload = {
              ...form,
              property: (form.property || '').trim().toLowerCase(),
              purchaseDate: (form.purchaseDate || '').trim().toLowerCase(),
              propMgmtComp: (form.propMgmtComp || '').trim().toLowerCase(),
            };
            const created = await api.add(payload);
            setItems([ ...items, created ]);
            setForm(empty);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setSaving(false);
          }
        };

        const onDelete = async (id) => {
          if (!confirm(`Delete ${id}?`)) return;
          try {
            await api.remove(id);
            setItems(items.filter(x => x.property !== id));
          } catch (e) {
            alert(e.message || 'Error');
          }
        };

        // Company Records form
        const emptyCompany = { companyname: '', rentPercentage: 0 };
        const [companyForm, setCompanyForm] = useState(emptyCompany);
        const [savingCompany, setSavingCompany] = useState(false);

        const onCompanyChange = (e) => {
          const { name, value } = e.target;
          if (name === 'rentPercentage') {
            setCompanyForm({ ...companyForm, [name]: Number(value || 0) });
          } else if (name === 'companyname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            setCompanyForm({ ...companyForm, [name]: sanitized });
          } else {
            setCompanyForm({ ...companyForm, [name]: value });
          }
        };

        const onCompanySubmit = async (e) => {
          e.preventDefault();
          setSavingCompany(true);
          setError('');
          try {
            if (!companyForm.companyname) throw new Error('companyname is required');
            const payload = { ...companyForm, companyname: companyForm.companyname.trim().toLowerCase() };
            const created = await api.addCompanyRecord(payload);
            setCompanyRecords([ ...companyRecords, created ]);
            setCompanyForm(emptyCompany);
          } catch (e) {
            setError(e.message || 'Error');
          } finally {
            setSavingCompany(false);
          }
        };

        const onCompanyDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try {
            await api.removeCompanyRecord(name);
            setCompanyRecords(companyRecords.filter(x => x.companyname !== name));
          } catch (e) {
            alert(e.message || 'Error');
          }
        };

        // Bank account form
        const emptyBA = { bankaccountname: '', bankname: '' };
        const [baForm, setBaForm] = useState(emptyBA);
        const [savingBA, setSavingBA] = useState(false);
        const onBAChange = (e) => {
          const { name, value } = e.target;
          if (name === 'bankaccountname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setBaForm({ ...baForm, [name]: sanitized });
          } else if (name === 'bankname') {
            setBaForm({ ...baForm, [name]: (value || '').toLowerCase() });
          }
        };
        const onBASubmit = async (e) => {
          e.preventDefault(); setSavingBA(true); setError('');
          try {
            if (!baForm.bankaccountname || !baForm.bankname) throw new Error('bankaccountname and bankname are required');
            const created = await api.addBankaccount(baForm);
            setBankaccounts([ ...bankaccounts, created ]);
            setBaForm(emptyBA);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingBA(false); }
        };
        const onBADelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeBankaccount(name); setBankaccounts(bankaccounts.filter(x => x.bankaccountname !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        // Group form
        const emptyGroup = { groupname: '', propertylist: '' };
        const [groupForm, setGroupForm] = useState(emptyGroup);
        const [savingGroup, setSavingGroup] = useState(false);
        const onGroupChange = (e) => {
          const { name, value } = e.target;
          if (name === 'groupname') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setGroupForm({ ...groupForm, [name]: sanitized });
          } else {
            setGroupForm({ ...groupForm, [name]: value });
          }
        };
        const onGroupSubmit = async (e) => {
          e.preventDefault(); setSavingGroup(true); setError('');
          try {
            const payload = { groupname: groupForm.groupname, propertylist: (groupForm.propertylist || '').split('|').map(s=>s.trim().toLowerCase()).filter(Boolean) };
            if (!payload.groupname) throw new Error('groupname is required');
            const created = await api.addGroup(payload);
            setGroups([ ...groups, created ]);
            setGroupForm(emptyGroup);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingGroup(false); }
        };
        const onGroupDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeGroup(name); setGroups(groups.filter(x => x.groupname !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        // Owner form
        const emptyOwner = { name: '', bankaccounts: [], properties: [], companies: [] };
        const [ownerForm, setOwnerForm] = useState(emptyOwner);
        const [savingOwner, setSavingOwner] = useState(false);
        const onOwnerChange = (e) => {
          const { name, value } = e.target;
          if (name === 'name') {
            const sanitized = (value || '').toLowerCase().replace(/[^a-z0-9_]/g, '');
            setOwnerForm({ ...ownerForm, [name]: sanitized });
          } else if (e.target.multiple) {
            const selected = Array.from(e.target.selectedOptions).map(o => (o.value || '').toLowerCase());
            setOwnerForm({ ...ownerForm, [name]: selected });
          } else {
            setOwnerForm({ ...ownerForm, [name]: value });
          }
        };
        const onOwnerSubmit = async (e) => {
          e.preventDefault(); setSavingOwner(true); setError('');
          try {
            if (!ownerForm.name) throw new Error('name is required');
            const payload = {
              name: ownerForm.name,
              bankaccounts: Array.from(new Set((ownerForm.bankaccounts || []).map(s => (s || '').toLowerCase()))),
              properties: Array.from(new Set((ownerForm.properties || []).map(s => (s || '').toLowerCase()))),
              companies: Array.from(new Set((ownerForm.companies || []).map(s => (s || '').toLowerCase()))),
            };
            const created = await api.addOwner(payload);
            setOwners([ ...owners, created ]);
            setOwnerForm(emptyOwner);
          } catch (e) { setError(e.message || 'Error'); } finally { setSavingOwner(false); }
        };
        const onOwnerDelete = async (name) => {
          if (!confirm(`Delete ${name}?`)) return;
          try { await api.removeOwner(name); setOwners(owners.filter(x => x.name !== name)); }
          catch (e) { alert(e.message || 'Error'); }
        };

        const TabButton = ({ active, onClick, children }) => (
          <button type="button" onClick={onClick} className={`tab ${active ? 'active' : ''}`}>{children}</button>
        );

        const [exporting, setExporting] = useState(false);
        const [exportResult, setExportResult] = useState({ open: false, path: '' });
        const handleExport = async () => {
          if (exporting) return;
          try {
            setExporting(true);
            const res = await fetch('/api/export-accounts', { method: 'POST' });
            if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'Export failed'); }
            const data = await res.json().catch(()=> ({}));
            const outPath = (data && data.path) ? String(data.path) : '';
            setExportResult({ open: true, path: outPath });
          } catch (e) {
            alert(e.message || 'Export failed');
          } finally {
            setExporting(false);
          }
        };

        return (
          <div className="container" style={{ position: 'relative' }}>
            {exportResult.open && (
              <div
                role="dialog"
                aria-modal="true"
                style={{ position: 'fixed', inset: 0, zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center' }}
              >
                <div style={{ position: 'absolute', inset: 0, background: 'rgba(0,0,0,0.45)' }} onClick={() => setExportResult({ open: false, path: '' })} />
                <div style={{ position: 'relative', background: 'white', width: 'min(92vw, 560px)', borderRadius: 12, boxShadow: '0 10px 30px rgba(0,0,0,0.25)' }}>
                  <div style={{ padding: '16px 20px', borderBottom: '1px solid #eee', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={{ fontSize: 18, fontWeight: 600 }}>Export Successful</div>
                    <button onClick={() => setExportResult({ open: false, path: '' })} title="Close" style={{ border: 0, background: 'transparent', fontSize: 20, lineHeight: 1, cursor: 'pointer' }}>Ã—</button>
                  </div>
                  <div style={{ padding: '16px 20px' }}>
                    <div style={{ marginBottom: 8 }}>Exported to:</div>
                    <div style={{ wordBreak: 'break-all', background: '#f7f7f7', padding: '10px 12px', borderRadius: 8 }}>
                      {exportResult.path ? (
                        <a href={'/api/export-accounts/download'} target="_blank" rel="noopener noreferrer" style={{ color: '#0b6bcb', textDecoration: 'underline' }}>
                          {exportResult.path}
                        </a>
                      ) : (
                        <span>file created</span>
                      )}
                    </div>
                  </div>
                  <div style={{ padding: '12px 20px', display: 'flex', justifyContent: 'flex-end', gap: 8, borderTop: '1px solid #eee' }}>
                    <button onClick={() => setExportResult({ open: false, path: '' })} className="btn" style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #ddd', background: '#fff', cursor: 'pointer' }}>Close</button>
                    {exportResult.path && (
                      <a href={'/api/export-accounts/download'} target="_blank" rel="noopener noreferrer" style={{ padding: '8px 12px', borderRadius: 8, background: '#0b6bcb', color: '#fff', textDecoration: 'none' }}>Open File</a>
                    )}
                  </div>
                </div>
              </div>
            )}
            <h1>AccountSpy</h1>

            <div className="tabs">
              <TabButton active={topTab==='setup'} onClick={() => setTopTab('setup')}>Setup</TabButton>
              <TabButton active={topTab==='classifyrules'} onClick={() => setTopTab('classifyrules')}>ClassifyRules</TabButton>
              <TabButton active={topTab==='transactions'} onClick={() => setTopTab('transactions')}>Transactions</TabButton>
              <TabButton active={topTab==='renttracker'} onClick={() => setTopTab('renttracker')}>RentTracker</TabButton>
              <TabButton active={topTab==='rentalsummary'} onClick={() => setTopTab('rentalsummary')}>RentalSummary</TabButton>
              <TabButton active={topTab==='companysummary'} onClick={() => setTopTab('companysummary')}>CompanySummary</TabButton>
              <TabButton active={topTab==='report'} onClick={() => setTopTab('report')}>Report</TabButton>
            </div>

            {topTab === 'setup' && (
              <div className="tabcontent">
                <div className="actions" style={{ marginBottom: 12, flexWrap: 'wrap' }}>
                  <TabButton active={setupTab==='settings'} onClick={() => setSetupTab('settings')}>Settings</TabButton>
                  <TabButton active={setupTab==='banks'} onClick={() => setSetupTab('banks')}>Banks</TabButton>
                  <TabButton active={setupTab==='bankaccounts'} onClick={() => setSetupTab('bankaccounts')}>Bank Accounts</TabButton>
                  <TabButton active={setupTab==='companies'} onClick={() => setSetupTab('companies')}>Company Records</TabButton>
                  <TabButton active={setupTab==='properties'} onClick={() => setSetupTab('properties')}>Properties</TabButton>
                  <TabButton active={setupTab==='groups'} onClick={() => setSetupTab('groups')}>Groups</TabButton>
                  <TabButton active={setupTab==='owners'} onClick={() => setSetupTab('owners')}>Owners</TabButton>
                  <TabButton active={setupTab==='taxcats'} onClick={() => setSetupTab('taxcats')}>Tax Categories</TabButton>
                  <TabButton active={setupTab==='txtypes'} onClick={() => setSetupTab('txtypes')}>Transaction Types</TabButton>
                </div>

                {setupTab === 'settings' && (
                  <div className="card">
                    <div className="row" style={{ alignItems:'flex-end' }}>
                      <div className="col">
                        <label>Prepare for year<br/>
                          {(() => {
                            const yearOptions = Array.from({ length: 38 }, (_, i) => 2023 + i).map(y => ({ value: String(y), label: String(y) }));
                            const selectedArr = prepYear ? [String(prepYear)] : [];
                            return (
                              <MultiSelect
                                options={yearOptions}
                                selected={selectedArr}
                                onChange={(arr)=>{ const y = (arr && arr[0]) || ''; setPrepYear(y); }}
                                placeholder="Select year..."
                              />
                            );
                          })()}
                        </label>
                      </div>
                      <div className="col" style={{ textAlign:'right' }}>
                        <button
                          type="button"
                          style={{ padding:'6px 12px', background:'#2563eb', color:'#fff', border:'none', borderRadius:'4px', cursor:'pointer' }}
                          onClick={async ()=>{
                            try {
                              const y = String(prepYear||'');
                              if (!y) { alert('Select a year'); return; }
                              const res = await fetch('/api/settings/prepyear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ year: y }) });
                              if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(t || 'prepyear failed'); }
                              alert('Year prepared: ' + y);
                            } catch (e) { alert(e.message || 'Failed'); }
                          }}
                        >prepare</button>
                      </div>
                    </div>
                  </div>
                )}

                {setupTab === 'properties' && (
                  <PropertiesPanelExt items={items} companies={companies} loading={loading} reload={load} />
                )}

                {setupTab === 'companies' && (
                  <CompaniesPanelExt companyRecords={companyRecords} loading={loading} reload={load} />
                )}

                {setupTab === 'banks' && (
                  <BanksPanelExt banks={banks} loading={loading} reload={load} />
                )}

                {setupTab === 'taxcats' && (
                  <TaxCategoriesPanelExt taxCategories={taxCategories} loading={loading} reload={load} />
                )}

                {setupTab === 'txtypes' && (
                  <TransactionTypesPanelExt transactionTypes={transactionTypes} loading={loading} reload={load} />
                )}

                {setupTab === 'bankaccounts' && (
                  <BankAccountsPanelExt bankaccounts={bankaccounts} loading={loading} reload={load} banks={banks} />
                )}

                {setupTab === 'groups' && (
                  <GroupsPanelExt groups={groups} loading={loading} reload={load} items={items} />
                )}

                {setupTab === 'owners' && (
                  <OwnersPanelExt owners={owners} loading={loading} reload={load} bankaccounts={bankaccounts} items={items} companies={companies} />
                )}
              </div>
            )}

            {topTab === 'classifyrules' && (
              <div className="tabcontent">
                <ClassifyRulesTabs
                  classifyRules={classifyRules}
                  loading={loading}
                  load={load}
                  bankaccounts={bankaccounts}
                  items={items}
                  taxCategories={taxCategories}
                  transactionTypes={transactionTypes}
                />
              </div>
            )}

            {topTab === 'transactions' && (
              <TransactionsPanel
                bankaccounts={bankaccounts}
                transactionsByBA={transactionsByBA}
                txnBATab={txnBATab}
                setTxnBATab={setTxnBATab}
                txnOpen={txnOpen}
                setTxnOpen={setTxnOpen}
                txnSaving={txnSaving}
                isTxnSaveEnabled={isTxnSaveEnabled}
                txnMonth={txnMonth}
                txnDay={txnDay}
                txnForm={txnForm}
                txnFilters={txnFilters}
                onTxnAdd={onTxnAdd}
                onTxnSubmit={onTxnSubmit}
                onTxnChange={onTxnChange}
                onTxnFilterChange={onTxnFilterChange}
                requestTransactionsReload={requestTransactionsReload}
                setTopTab={setTopTab}
              />
            )}

            {topTab === 'renttracker' && (
              <RentTrackerPanel
                loading={rentTrackerLoading}
                rows={rentTrackerRows}
              />
            )}

            {topTab === 'companysummary' && (
              <CompanySummaryPanel
                loading={companyLoading}
                rows={companyRows}
                filters={companyFilters}
                setFilters={setCompanyFilters}
                isCSVerified={isCSVerified}
                verifyCSCell={verifyCSCell}
              />
            )}

            {topTab === 'rentalsummary' && (
              <RentalSummaryPanel
                loading={rentalLoading}
                rows={rentalRows}
                filters={rentalFilters}
                setFilters={setRentalFilters}
                isRSVerified={isRSVerified}
                verifyRSCell={verifyRSCell}
              />
            )}

            {topTab === 'report' && (
              <div className="tabcontent"><div className="muted">Report UI coming soon.</div></div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
